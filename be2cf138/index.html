<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Elasticsearch 教程'>

<meta name="keywords" content="elastic , 教程"><title>Elasticsearch 教程</title>

<link rel='canonical' href='https://lxb.wiki/be2cf138/'>

<link rel="stylesheet" href="/scss/style.min.e5fa5972b3e81b9d9b61e2598991a71c444ca50e38b034d78f5651a82802e894.css"><meta property='og:title' content='Elasticsearch 教程'>
<meta property='og:description' content='Elasticsearch 教程'>
<meta property='og:url' content='https://lxb.wiki/be2cf138/'>
<meta property='og:site_name' content='Xiaobin&#39;s Notes'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='elastic' /><meta property='article:published_time' content='2023-05-23T21:56:26&#43;08:00'/><meta property='article:modified_time' content='2023-05-23T21:56:26&#43;08:00'/>
<meta name="twitter:title" content="Elasticsearch 教程">
<meta name="twitter:description" content="Elasticsearch 教程">
<link rel="shortcut icon" href="/favicon.png" />




<script async src="https://www.googletagmanager.com/gtag/js?id=G-JZ2PWLT6JY"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-JZ2PWLT6JY');
</script>
<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?e710560ffa44cae2b3a6259e0171fb5f";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>
<script>
    (function () {
        var el = document.createElement("script");
        el.src = "https://lf1-cdn-tos.bytegoofy.com/goofy/ttzz/push.js?f146251743600ee0672cdcc8455ce18def91cdb255ad969a2ef5c715d5ed5baecaf7cd753709c168f20e6a2e9019123fd11e31a222d3a2fe01ad05c6b8f519b2";
        el.id = "ttzz";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(el, s);
    })(window)
</script>
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu692828361b78eaa42fdbdbbf5a7177a9_44446_300x0_resize_q75_box.jpeg" width="300"
                            height="298" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🍥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Xiaobin&#39;s Notes</a></h1>
            <h2 class="site-description"></h2>
        </div>
    </header>


    <ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                <span>首页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/categories/' >
                
                
                
                <span>分类</span>
            </a>
        </li>
        
        
        <li >
            <a href='/tags/' >
                
                
                
                <span>标签</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                <span>友链</span>
            </a>
        </li>
        

        <div class="menu-bottom-section"><ol class="social-menu">
                    
                        <li>
                            <a 
                                href='mailto://me@lxb.wiki'
                                target="_blank"
                                title="Email"
                                rel="me"
                            >
                                
                                
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                                
                            </a>
                        </li>
                    
                        <li>
                            <a 
                                href='https://github.com/lxbwolf'
                                target="_blank"
                                title="GitHub"
                                rel="me"
                            >
                                
                                
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                                
                            </a>
                        </li>
                    
                        <li>
                            <a 
                                href='https://lxb.wiki/atom.xml'
                                target="_blank"
                                title="Rss"
                                rel="me"
                            >
                                
                                
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="5" cy="19" r="1" />
  <path d="M4 4a16 16 0 0 1 16 16" />
  <path d="M4 11a9 9 0 0 1 9 9" />
</svg>



                                
                            </a>
                        </li>
                    
                </ol>
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>暗色模式</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
<section class="widget archives">
    
    <h2 class="widget-title section-title">目录</h2>

    <div class="widget--toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#一安装">一、安装</a></li>
    <li><a href="#二基本概念">二、基本概念</a>
      <ul>
        <li><a href="#20-抽象类比">2.0 抽象类比</a></li>
        <li><a href="#21-node-与-cluster">2.1 Node 与 Cluster</a></li>
        <li><a href="#22-index">2.2 Index</a></li>
        <li><a href="#23-document">2.3 Document</a></li>
        <li><a href="#24-type">2.4 Type</a></li>
        <li><a href="#25-mappings映射">2.5 mappings(映射)</a></li>
        <li><a href="#26-shard分片">2.6 shard(分片)</a></li>
        <li><a href="#27-replica备份">2.7. replica(备份)</a></li>
        <li><a href="#28-倒排索引">2.8 倒排索引</a></li>
        <li><a href="#29-analysis">2.9 analysis</a></li>
        <li><a href="#210-es集群状态">2.10 ES集群状态：</a></li>
        <li><a href="#211-replica作用">2.11 replica作用：</a></li>
      </ul>
    </li>
    <li><a href="#三新建和删除-index">三、新建和删除 Index</a></li>
    <li><a href="#四中文分词设置">四、中文分词设置</a></li>
    <li><a href="#五数据操作">五、数据操作</a>
      <ul>
        <li><a href="#51-新增记录">5.1 新增记录</a></li>
        <li><a href="#52-查看记录">5.2 查看记录</a></li>
        <li><a href="#53-删除记录">5.3 删除记录</a></li>
        <li><a href="#54-更新记录">5.4 更新记录</a></li>
        <li><a href="#55-操作索引">5.5 操作索引</a></li>
        <li><a href="#56-操作文档">5.6 操作文档</a></li>
      </ul>
    </li>
    <li><a href="#六数据查询">六、数据查询</a>
      <ul>
        <li><a href="#61-返回所有记录">6.1 返回所有记录</a></li>
        <li><a href="#62-全文搜索">6.2 全文搜索</a></li>
        <li><a href="#63-逻辑运算">6.3 逻辑运算</a></li>
        <li><a href="#64-搜索demo">6.4 搜索demo</a></li>
      </ul>
    </li>
    <li><a href="#七参考链接">七、参考链接</a></li>
  </ul>
</nav>
    </div>
</section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
        <a href="/categories/Lang/" >
            Lang
        </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/be2cf138/">Elasticsearch 教程</a>
        </h2>

        
        <h3 class="article-subtitle">
            Elasticsearch 教程
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
            <time class="article-time--published">May 23, 2023</time>
        </div>
        

        
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



            <time class="article-time--reading">
                阅读时长: 14 分钟
            </time>
        </div>
        
        <small>
    <section class="article-tags">
        
            <a href="/tags/elastic/">elastic</a>
        
    </section>
</small>
    </footer>
    

    
</div>
</header>

    <section class="article-content">
    
    
    <p><a class="link" href="https://baike.baidu.com/item/%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E"  target="_blank" rel="noopener"
    >全文搜索</a>属于最常见的需求，开源的 <a class="link" href="https://www.elastic.co/"  target="_blank" rel="noopener"
    >Elasticsearch</a> （以下简称 Elastic）是目前全文搜索引擎的首选。</p>
<p>它可以快速地储存、搜索和分析海量数据。维基百科、Stack Overflow、Github 都采用它。</p>
<p><img src="https://raw.githubusercontent.com/lxbwolf/blog_source_image/main/202403031501235.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>Elastic 的底层是开源库 <a class="link" href="https://lucene.apache.org/"  target="_blank" rel="noopener"
    >Lucene</a>。但是，你没法直接用 Lucene，必须自己写代码去调用它的接口。Elastic 是 Lucene 的封装，提供了 REST API 的操作接口，开箱即用。</p>
<p>本文从零开始，讲解如何使用 Elastic 搭建自己的全文搜索引擎。每一步都有详细的说明，大家跟着做就能学会。</p>
<h2 id="一安装">一、安装</h2>
<p>Elastic 需要 Java 8 环境。如果你的机器还没安装 Java，可以参考<a class="link" href="https://www.digitalocean.com/community/tutorials/how-to-install-java-with-apt-get-on-debian-8"  target="_blank" rel="noopener"
    >这篇文章</a>，注意要保证环境变量<code>JAVA_HOME</code>正确设置。</p>
<p>安装完 Java，就可以跟着<a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/zip-targz.html"  target="_blank" rel="noopener"
    >官方文档</a>安装 Elastic。直接下载压缩包比较简单。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.5.1.zip 
</span></span><span style="display:flex;"><span>$ unzip elasticsearch-5.5.1.zip 
</span></span><span style="display:flex;"><span>$ cd elasticsearch-5.5.1/
</span></span></code></pre></div></blockquote>
<p>接着，进入解压后的目录，运行下面的命令，启动 Elastic。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./bin/elasticsearch
</span></span></code></pre></div></blockquote>
<p>如果这时<a class="link" href="https://github.com/spujadas/elk-docker/issues/92"  target="_blank" rel="noopener"
    >报错</a>&ldquo;max virtual memory areas vm.max_map_count [65530] is too low&rdquo;，要运行下面的命令。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo sysctl -w vm.max_map_count<span style="color:#f92672">=</span><span style="color:#ae81ff">262144</span>
</span></span></code></pre></div></blockquote>
<p>如果一切正常，Elastic 就会在默认的9200端口运行。这时，打开另一个命令行窗口，请求该端口，会得到说明信息。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl localhost:9200 
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;atntrTf&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cluster_name&#34;</span>:<span style="color:#e6db74">&#34;elasticsearch&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cluster_uuid&#34;</span>:<span style="color:#e6db74">&#34;tf9250XhQ6ee4h7YI11anA&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;version&#34;</span>:<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;number&#34;</span>:<span style="color:#e6db74">&#34;5.5.1&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;build_hash&#34;</span>:<span style="color:#e6db74">&#34;19c13d0&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;build_date&#34;</span>:<span style="color:#e6db74">&#34;2017-07-18T20:44:24.823Z&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;build_snapshot&#34;</span>:false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;lucene_version&#34;</span>:<span style="color:#e6db74">&#34;6.6.0&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;tagline&#34;</span>:<span style="color:#e6db74">&#34;You Know, for Search&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></blockquote>
<p>上面代码中，请求9200端口，Elastic 返回一个 JSON 对象，包含当前节点、集群、版本等信息。</p>
<p>按下 <code>Ctrl + C</code>，Elastic 就会停止运行。</p>
<p>默认情况下，Elastic 只允许本机访问，如果需要远程访问，可以修改 Elastic 安装目录的<code>config/elasticsearch.yml</code>文件，去掉<code>network.host</code>的注释，将它的值改成<code>0.0.0.0</code>，然后重新启动 Elastic。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>network.host: 0.0.0.0
</span></span></code></pre></div></blockquote>
<p>上面代码中，设成<code>0.0.0.0</code>让任何人都可以访问。线上服务不要这样设置，要设成具体的 IP。</p>
<p>通过 docker 启动一个单节点集群</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker run -p 9200:9200 -p 9300:9300 -e <span style="color:#e6db74">&#34;discovery.type=single-node&#34;</span> docker.elastic.co/elasticsearch/elasticsearch:6.7.2
</span></span></code></pre></div><p>使用 RESTful API 通过端口 9200 和 Elasticsearch 进行通信</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl -X &lt;METHOD&gt; http://localhost:9200/&lt;PATH&gt;?&lt;QUERY_STRING&gt; -d <span style="color:#e6db74">&#39;&lt;BODY&gt;&#39;</span>
</span></span></code></pre></div><h2 id="二基本概念">二、基本概念</h2>
<h3 id="20-抽象类比">2.0 抽象类比</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>MySql</th>
<th>Es</th>
</tr>
</thead>
<tbody>
<tr>
<td>Table</td>
<td>Index(Type)</td>
</tr>
<tr>
<td>Row</td>
<td>Document</td>
</tr>
<tr>
<td>Column</td>
<td>Field</td>
</tr>
<tr>
<td>Schema</td>
<td>Mapping</td>
</tr>
<tr>
<td>SQL</td>
<td>DSL</td>
</tr>
</tbody>
</table></div>
<h3 id="21-node-与-cluster">2.1 Node 与 Cluster</h3>
<p>Elastic 本质上是一个分布式数据库，允许多台服务器协同工作，每台服务器可以运行多个 Elastic 实例，所以并不能说一台机器就是一个 node，大多数情况下每个node运行在一个独立的环境或虚拟机上。</p>
<p>单个 Elastic 实例称为一个节点（node），一组节点构成一个集群（cluster），每个集群都有一个cluster name作为标识</p>
<h3 id="22-index">2.2 Index</h3>
<p>Elastic 会索引所有字段，经过处理后写入一个反向索引（Inverted Index）。查找数据的时候，直接查找该索引。</p>
<p>所以，Elastic 数据管理的顶层单位就叫做 Index（索引）。它是单个数据库的同义词。每个 Index （即数据库）的名字必须是小写。</p>
<p>下面的命令可以查看当前节点的所有 Index。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl -X GET <span style="color:#e6db74">&#39;http://localhost:9200/_cat/indices?v&#39;</span>
</span></span></code></pre></div></blockquote>
<p>Index 即一系列 documents 的集合。每个索引可以有多个type，不过7.0之后将会被废弃，略过。</p>
<h3 id="23-document">2.3 Document</h3>
<p>Index 里面单条的记录称为 Document（文档）。许多条 Document 构成了一个 Index。</p>
<p>Document 使用 JSON 格式表示，下面是一个例子。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;user&#34;</span>: <span style="color:#e6db74">&#34;张三&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;title&#34;</span>: <span style="color:#e6db74">&#34;工程师&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;desc&#34;</span>: <span style="color:#e6db74">&#34;数据库管理&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div></blockquote>
<p>同一个 Index 里面的 Document，不要求有相同的结构（scheme），但是最好保持相同，这样有利于提高搜索效率。</p>
<h3 id="24-type">2.4 Type</h3>
<p>Document 可以分组，比如<code>weather</code>这个 Index 里面，可以按城市分组（北京和上海），也可以按气候分组（晴天和雨天）。这种分组就叫做 Type，它是虚拟的逻辑分组，用来过滤 Document。</p>
<p>不同的 Type 应该有相似的结构（schema），举例来说，<code>id</code>字段不能在这个组是字符串，在另一个组是数值。这是与关系型数据库的表的<a class="link" href="https://www.elastic.co/guide/en/elasticsearch/guide/current/mapping.html"  target="_blank" rel="noopener"
    >一个区别</a>。性质完全不同的数据（比如<code>products</code>和<code>logs</code>）应该存成两个 Index，而不是一个 Index 里面的两个 Type（虽然可以做到）。</p>
<p>下面的命令可以列出每个 Index 所包含的 Type。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#39;localhost:9200/_mapping?pretty=true&#39;</span>
</span></span></code></pre></div></blockquote>
<p>根据<a class="link" href="https://www.elastic.co/blog/index-type-parent-child-join-now-future-in-elasticsearch"  target="_blank" rel="noopener"
    >规划</a>，Elastic 6.x 版只允许每个 Index 包含一个 Type，7.x 版将会彻底移除 Type。</p>
<h3 id="25-mappings映射">2.5 mappings(映射)</h3>
<p>映射, 就像数据库中的 schema ，描述了文档可能具有的字段或 属性 、每个字段的数据类型—比如 string, integer 或 date —以及Lucene是如何索引和存储这些字段的。</p>
<ul>
<li>字符串: string</li>
<li>整数: byte, short, integer, long</li>
<li>浮点数: float, double</li>
<li>布尔型: boolean</li>
<li>日期: date</li>
<li>keyword：存储数据时候，不会分词建立索引</li>
<li>text：存储数据时候，会自动分词，并生成索引</li>
</ul>
<h3 id="26-shard分片">2.6 shard(分片)</h3>
<p>ES是分布式搜索引擎，每个索引有一个或多个分片，索引的数据被分配到各个分片上，相当于一桶水用了N个杯子装。分片有助于横向扩展，N个分片会被尽可能平均地（rebalance）分配在不同的节点上（例如你有2个节点，4个主分片(不考虑备份)，那么每个节点会分到2个分片，后来你增加了2个节点，那么你这4个节点上都会有1个分片，这个过程叫 relocation，ES感知后自动完成)。分片是独立的，对于一个 Search Request 的行为，每个分片都会执行这个  Request。</p>
<h3 id="27-replica备份">2.7. replica(备份)</h3>
<p>可以理解为备份分片，相应地有 primary  shard（主分片)，主分片和备分片不会出现在同一个节点上（防止单点故障），默认情况下一个索引创建5个分片一个备份（即5primary+5replica=10个分片）。如果你只有一个节点，那么5个 replica 都无法分配（unassigned），此时cluster status会变成Yellow。</p>
<h3 id="28-倒排索引">2.8 倒排索引</h3>
<p>Elasticsearch 使用一种称为 倒排索引 的结构，它适用于快速的全文搜索。一个倒排索引由文档中所有不重复词的列表构成，对于其中每个词，有一个包含它的文档列表。</p>
<h3 id="29-analysis">2.9 analysis</h3>
<p>Document 中的数据是如何转变成倒排索引的，以及查询语句是如何转换成一个个词(Term)使高效率文本搜索变得可行，这种转换数据的过程就称为文本分析(analysis)。</p>
<p>elasticsearch会用某种算法(Tokenizer)对要建索引的文档进行分析，  从文档中提取出若干Token(词元)， 这些算法称为Tokenizer(分词器)， 这些Token会被进一步处理， 比如转成小写等，  这些进一步的处理算法被称为Filter(过滤器), 被处理后的结果被称为Term(词)，  文档中包含了几个这样的Term被称为Frequency(词频)。 引擎会建立Term和原文档的Inverted Index(倒排索引)，  这样就能根据Term很快到找到源文档了。
文本分析(analysis)工作由analyzer(分析器)组件负责。analyzer由一个分词器(tokenizer)和0个或者多个过滤器(filter)组成,也可能会有0个或者多个字符映射器(character mappers)组成。
tokenizer用来把文本拆分成一个个的Token。Token包含了比较多的信息，比如Term在文本的中的位置及Term原始文本，以及Term的长度。文本经过tokenizer处理后的结果称为token stream。token stream其实就是一个个Token的顺序排列。token stream将等待着filter来处理。
filter链将用来处理Token Stream中的每一个token。这些处理方式包括删除Token, 改变Token，甚至添加新的Token。比如变小写，去掉里面的HTML标记， 这些处理的算法被称为Character Filter(字符过滤器)</p>
<h3 id="210-es集群状态">2.10 ES集群状态：</h3>
<ul>
<li>Green：所有主分片和备份分片都准备就绪（分配成功），即使有一台机器挂了（假设一台机器一个实例），数据都不会丢失，但会变成Yellow状态</li>
<li>Yellow：所有主分片准备就绪，但存在至少一个主分片（假设是A）对应的备份分片没有就绪，此时集群属于警告状态，意味着集群高可用和容灾能力下降，如果刚好A所在的机器挂了，并且你只设置了一个备份（已处于未就绪状态），那么A的数据就会丢失（查询结果不完整），此时集群进入Red状态</li>
<li>Red：至少有一个主分片没有就绪（直接原因是找不到对应的备份分片成为新的主分片）,此时查询的结果会出现数据丢失（不完整）</li>
</ul>
<h3 id="211-replica作用">2.11 replica作用：</h3>
<ul>
<li>容灾：primary分片丢失，replica分片就会被顶上去成为新的主分片，同时根据这个新的主分片创建新的replica，集群数据安然无恙;</li>
<li>提高查询性能：replica和primary分片的数据是相同的，所以对于一个query既可以查主分片也可以查备分片，在合适的范围内多个replica性能会更优（但要考虑资源占用也会提升[cpu/disk/heap]），另外index request只能发生在主分片上，replica不能执行index request。</li>
</ul>
<p>对于一个索引，除非重建索引否则不能调整分片的数目（主分片数, number_of_shards），但可以随时调整 replica 数(number_of_replicas)。</p>
<h2 id="三新建和删除-index">三、新建和删除 Index</h2>
<p>新建 Index，可以直接向 Elastic 服务器发出 PUT 请求。下面的例子是新建一个名叫<code>weather</code>的 Index。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl -X PUT <span style="color:#e6db74">&#39;localhost:9200/weather&#39;</span>
</span></span></code></pre></div></blockquote>
<p>服务器返回一个 JSON 对象，里面的<code>acknowledged</code>字段表示操作成功。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;acknowledged&#34;</span><span style="color:#f92672">:</span><span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;shards_acknowledged&#34;</span><span style="color:#f92672">:</span><span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></blockquote>
<p>然后，我们发出 DELETE 请求，删除这个 Index。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl -X DELETE <span style="color:#e6db74">&#39;localhost:9200/weather&#39;</span>
</span></span></code></pre></div></blockquote>
<h2 id="四中文分词设置">四、中文分词设置</h2>
<p>首先，安装中文分词插件。这里使用的是 <a class="link" href="https://github.com/medcl/elasticsearch-analysis-ik/"  target="_blank" rel="noopener"
    >ik</a>，也可以考虑其他插件（比如 <a class="link" href="https://www.elastic.co/guide/en/elasticsearch/plugins/current/analysis-smartcn.html"  target="_blank" rel="noopener"
    >smartcn</a>）。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">$</span> .<span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">/</span><span style="color:#a6e22e">elasticsearch</span><span style="color:#f92672">-</span><span style="color:#a6e22e">plugin</span> <span style="color:#a6e22e">install</span> <span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//github.com/medcl/elasticsearch-analysis-ik/releases/download/v5.5.1/elasticsearch-analysis-ik-5.5.1.zip
</span></span></span></code></pre></div></blockquote>
<p>上面代码安装的是5.5.1版的插件，与 Elastic 5.5.1 配合使用。</p>
<p>接着，重新启动 Elastic，就会自动加载这个新安装的插件。</p>
<p>然后，新建一个 Index，指定需要分词的字段。这一步根据数据结构而异，下面的命令只针对本文。基本上，凡是需要搜索的中文字段，都要单独设置一下。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl -X PUT <span style="color:#e6db74">&#39;localhost:9200/accounts&#39;</span> -d <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;mappings&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;person&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;properties&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;user&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;type&#34;: &#34;text&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;analyzer&#34;: &#34;ik_max_word&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;search_analyzer&#34;: &#34;ik_max_word&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;title&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;type&#34;: &#34;text&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;analyzer&#34;: &#34;ik_max_word&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;search_analyzer&#34;: &#34;ik_max_word&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;desc&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;type&#34;: &#34;text&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;analyzer&#34;: &#34;ik_max_word&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;search_analyzer&#34;: &#34;ik_max_word&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div></blockquote>
<p>上面代码中，首先新建一个名称为<code>accounts</code>的 Index，里面有一个名称为<code>person</code>的 Type。<code>person</code>有三个字段。</p>
<blockquote>
<ul>
<li>user</li>
<li>title</li>
<li>desc</li>
</ul>
</blockquote>
<p>这三个字段都是中文，而且类型都是文本（text），所以需要指定中文分词器，不能使用默认的英文分词器。</p>
<p>Elastic 的分词器称为 <a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis.html"  target="_blank" rel="noopener"
    >analyzer</a>。我们对每个字段指定分词器。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;user&#34;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;text&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;analyzer&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;ik_max_word&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;search_analyzer&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;ik_max_word&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div></blockquote>
<p>上面代码中，<code>analyzer</code>是字段文本的分词器，<code>search_analyzer</code>是搜索词的分词器。<code>ik_max_word</code>分词器是插件<code>ik</code>提供的，可以对文本进行最大数量的分词。</p>
<h2 id="五数据操作">五、数据操作</h2>
<h3 id="51-新增记录">5.1 新增记录</h3>
<p>向指定的 /Index/Type 发送 PUT 请求，就可以在 Index 里面新增一条记录。比如，向<code>/accounts/person</code>发送请求，就可以新增一条人员记录。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl -X PUT <span style="color:#e6db74">&#39;localhost:9200/accounts/person/1&#39;</span> -d <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;user&#34;: &#34;张三&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;title&#34;: &#34;工程师&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;desc&#34;: &#34;数据库管理&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div></blockquote>
<p>服务器返回的 JSON 对象，会给出 Index、Type、Id、Version 等信息。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;_index&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;accounts&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;_type&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;person&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;_version&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;result&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;created&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;_shards&#34;</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#34;total&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">2</span>,<span style="color:#e6db74">&#34;successful&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#34;failed&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>},
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;created&#34;</span><span style="color:#f92672">:</span><span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></blockquote>
<p>如果你仔细看，会发现请求路径是<code>/accounts/person/1</code>，最后的<code>1</code>是该条记录的 Id。它不一定是数字，任意字符串（比如<code>abc</code>）都可以。</p>
<p>新增记录的时候，也可以不指定 Id，这时要改成 POST 请求。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl -X POST <span style="color:#e6db74">&#39;localhost:9200/accounts/person&#39;</span> -d <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;user&#34;: &#34;李四&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;title&#34;: &#34;工程师&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;desc&#34;: &#34;系统管理&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div></blockquote>
<p>上面代码中，向<code>/accounts/person</code>发出一个 POST 请求，添加一个记录。这时，服务器返回的 JSON 对象里面，<code>_id</code>字段就是一个随机字符串。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;_index&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;accounts&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;_type&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;person&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;AV3qGfrC6jMbsbXb6k1p&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;_version&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;result&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;created&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;_shards&#34;</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#34;total&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">2</span>,<span style="color:#e6db74">&#34;successful&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#34;failed&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>},
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;created&#34;</span><span style="color:#f92672">:</span><span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div></blockquote>
<p>注意，如果没有先创建 Index（这个例子是<code>accounts</code>），直接执行上面的命令，Elastic 也不会报错，而是直接生成指定的 Index。所以，打字的时候要小心，不要写错 Index 的名称。</p>
<h3 id="52-查看记录">5.2 查看记录</h3>
<p>向<code>/Index/Type/Id</code>发出 GET 请求，就可以查看这条记录。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#39;localhost:9200/accounts/person/1?pretty=true&#39;</span>
</span></span></code></pre></div></blockquote>
<p>上面代码请求查看<code>/accounts/person/1</code>这条记录，URL 的参数<code>pretty=true</code>表示以易读的格式返回。</p>
<p>返回的数据中，<code>found</code>字段表示查询成功，<code>_source</code>字段返回原始记录。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;_index&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;accounts&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;_type&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;person&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;_id&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;_version&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;found&#34;</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;_source&#34;</span> <span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;user&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;张三&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;title&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;工程师&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;desc&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;数据库管理&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div></blockquote>
<p>如果 Id 不正确，就查不到数据，<code>found</code>字段就是<code>false</code>。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#39;localhost:9200/weather/beijing/abc?pretty=true&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;_index&#34;</span> : <span style="color:#e6db74">&#34;accounts&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;_type&#34;</span> : <span style="color:#e6db74">&#34;person&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;_id&#34;</span> : <span style="color:#e6db74">&#34;abc&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;found&#34;</span> : false
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></blockquote>
<h3 id="53-删除记录">5.3 删除记录</h3>
<p>删除记录就是发出 DELETE 请求。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl -X DELETE <span style="color:#e6db74">&#39;localhost:9200/accounts/person/1&#39;</span>
</span></span></code></pre></div></blockquote>
<p>这里先不要删除这条记录，后面还要用到。</p>
<h3 id="54-更新记录">5.4 更新记录</h3>
<p>更新记录就是使用 PUT 请求，重新发送一次数据。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl -X PUT <span style="color:#e6db74">&#39;localhost:9200/accounts/person/1&#39;</span> -d <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;user&#34; : &#34;张三&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;title&#34; : &#34;工程师&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;desc&#34; : &#34;数据库管理，软件开发&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;_index&#34;</span>:<span style="color:#e6db74">&#34;accounts&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;_type&#34;</span>:<span style="color:#e6db74">&#34;person&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;_id&#34;</span>:<span style="color:#e6db74">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;_version&#34;</span>:2,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;result&#34;</span>:<span style="color:#e6db74">&#34;updated&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;_shards&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;total&#34;</span>:2,<span style="color:#e6db74">&#34;successful&#34;</span>:1,<span style="color:#e6db74">&#34;failed&#34;</span>:0<span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;created&#34;</span>:false
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></blockquote>
<p>上面代码中，我们将原始数据从&quot;数据库管理&quot;改成&quot;数据库管理，软件开发&quot;。 返回结果里面，有几个字段发生了变化。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;_version&#34;</span> : 2,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;result&#34;</span> : <span style="color:#e6db74">&#34;updated&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;created&#34;</span> : false
</span></span></code></pre></div></blockquote>
<p>可以看到，记录的 Id 没变，但是版本（version）从<code>1</code>变成<code>2</code>，操作类型（result）从<code>created</code>变成<code>updated</code>，<code>created</code>字段变成<code>false</code>，因为这次不是新建记录。</p>
<h3 id="55-操作索引">5.5 操作索引</h3>
<p>新建索引时可以指定设置或者映射，也可以不指定自动生成</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ PUT foo_index
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;settings&#34;</span>: <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;number_of_shards&#34;</span> :   1,   <span style="color:#75715e">#每个索引的主分片数，默认值是 5 。这个配置在索引创建后不能修改。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;number_of_replicas&#34;</span> : <span style="color:#ae81ff">0</span>    <span style="color:#75715e">#每个主分片的副本数，默认值是 1 。对于活动的索引库，这个配置可以随时修改。</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;mappings&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;type_one&#34;</span>: <span style="color:#f92672">{</span> ... any mappings ... <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;type_two&#34;</span>: <span style="color:#f92672">{</span> ... any mappings ... <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>修改索引设置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ PUT foo_index/_settings
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;number_of_replicas&#34;</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>修改索引映射</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ PUT foo_index/_mappings/_doc
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;properties&#34;</span>: <span style="color:#f92672">{</span>...<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>删除索引</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ DELETE foo_index
</span></span></code></pre></div><h3 id="56-操作文档">5.6 操作文档</h3>
<p>使用put新建文档项指定id为1</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ PUT foo_index/_doc/1
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;demo 1&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;body&#34;</span>: <span style="color:#e6db74">&#34;demo foo bar&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>使用post可以不指定id来新建文档，自动生成id</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ POST foo_index/_doc
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;demo test&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;body&#34;</span>: <span style="color:#e6db74">&#34;demo test&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>查看id=1的文档</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ GET foo_index/_doc/1
</span></span></code></pre></div><h2 id="六数据查询">六、数据查询</h2>
<h3 id="61-返回所有记录">6.1 返回所有记录</h3>
<p>使用 GET 方法，直接请求<code>/Index/Type/_search</code>，就会返回所有记录。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#39;localhost:9200/accounts/person/_search&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;took&#34;</span>:2,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;timed_out&#34;</span>:false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;_shards&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;total&#34;</span>:5,<span style="color:#e6db74">&#34;successful&#34;</span>:5,<span style="color:#e6db74">&#34;failed&#34;</span>:0<span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;hits&#34;</span>:<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;total&#34;</span>:2,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;max_score&#34;</span>:1.0,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;hits&#34;</span>:<span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;_index&#34;</span>:<span style="color:#e6db74">&#34;accounts&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;_type&#34;</span>:<span style="color:#e6db74">&#34;person&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;_id&#34;</span>:<span style="color:#e6db74">&#34;AV3qGfrC6jMbsbXb6k1p&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;_score&#34;</span>:1.0,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;_source&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;user&#34;</span>: <span style="color:#e6db74">&#34;李四&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;title&#34;</span>: <span style="color:#e6db74">&#34;工程师&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;desc&#34;</span>: <span style="color:#e6db74">&#34;系统管理&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;_index&#34;</span>:<span style="color:#e6db74">&#34;accounts&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;_type&#34;</span>:<span style="color:#e6db74">&#34;person&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;_id&#34;</span>:<span style="color:#e6db74">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;_score&#34;</span>:1.0,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;_source&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;user&#34;</span> : <span style="color:#e6db74">&#34;张三&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;title&#34;</span> : <span style="color:#e6db74">&#34;工程师&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;desc&#34;</span> : <span style="color:#e6db74">&#34;数据库管理，软件开发&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></blockquote>
<p>上面代码中，返回结果的 <code>took</code>字段表示该操作的耗时（单位为毫秒），<code>timed_out</code>字段表示是否超时，<code>hits</code>字段表示命中的记录，里面子字段的含义如下。</p>
<blockquote>
<ul>
<li><code>total</code>：返回记录数，本例是2条。</li>
<li><code>max_score</code>：最高的匹配程度，本例是<code>1.0</code>。</li>
<li><code>hits</code>：返回的记录组成的数组。</li>
</ul>
</blockquote>
<p>返回的记录中，每条记录都有一个<code>_score</code>字段，表示匹配的程序，默认是按照这个字段降序排列。</p>
<h3 id="62-全文搜索">6.2 全文搜索</h3>
<p>Elastic 的查询非常特别，使用自己的<a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/5.5/query-dsl.html"  target="_blank" rel="noopener"
    >查询语法</a>，要求 GET 请求带有数据体。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#39;localhost:9200/accounts/person/_search&#39;</span>  -d <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34; : { &#34;match&#34; : { &#34;desc&#34; : &#34;软件&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div></blockquote>
<p>上面代码使用 <a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/5.5/query-dsl-match-query.html"  target="_blank" rel="noopener"
    >Match 查询</a>，指定的匹配条件是<code>desc</code>字段里面包含&quot;软件&quot;这个词。返回结果如下。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;took&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;timed_out&#34;</span><span style="color:#f92672">:</span><span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;_shards&#34;</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#34;total&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">5</span>,<span style="color:#e6db74">&#34;successful&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">5</span>,<span style="color:#e6db74">&#34;failed&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>},
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;hits&#34;</span><span style="color:#f92672">:</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;total&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;max_score&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0.28582606</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;hits&#34;</span><span style="color:#f92672">:</span>[
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;_index&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;accounts&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;_type&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;person&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;_score&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0.28582606</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;_source&#34;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>              <span style="color:#e6db74">&#34;user&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;张三&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#e6db74">&#34;title&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;工程师&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#e6db74">&#34;desc&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;数据库管理，软件开发&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div></blockquote>
<p>Elastic 默认一次返回10条结果，可以通过<code>size</code>字段改变这个设置。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#39;localhost:9200/accounts/person/_search&#39;</span>  -d <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34; : { &#34;match&#34; : { &#34;desc&#34; : &#34;管理&#34; }},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;size&#34;: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div></blockquote>
<p>上面代码指定，每次只返回一条结果。</p>
<p>还可以通过<code>from</code>字段，指定位移。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#39;localhost:9200/accounts/person/_search&#39;</span>  -d <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34; : { &#34;match&#34; : { &#34;desc&#34; : &#34;管理&#34; }},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;from&#34;: 1,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;size&#34;: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div></blockquote>
<p>上面代码指定，从位置1开始（默认是从位置0开始），只返回一条结果。</p>
<h3 id="63-逻辑运算">6.3 逻辑运算</h3>
<p>如果有多个搜索关键字， Elastic 认为它们是<code>or</code>关系。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#39;localhost:9200/accounts/person/_search&#39;</span>  -d <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34; : { &#34;match&#34; : { &#34;desc&#34; : &#34;软件 系统&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div></blockquote>
<p>上面代码搜索的是<code>软件 or 系统</code>。</p>
<p>如果要执行多个关键词的<code>and</code>搜索，必须使用<a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/5.5/query-dsl-bool-query.html"  target="_blank" rel="noopener"
    >布尔查询</a>。</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#39;localhost:9200/accounts/person/_search&#39;</span>  -d <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;bool&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;must&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        { &#34;match&#34;: { &#34;desc&#34;: &#34;软件&#34; } },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        { &#34;match&#34;: { &#34;desc&#34;: &#34;系统&#34; } }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div></blockquote>
<h3 id="64-搜索demo">6.4 搜索demo</h3>
<p>使用 <code>curl -X GET foo_index/_search -d 'body'</code> 来搜索文档</p>
<p>match_all匹配所有文档，等价于空查询{}</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;query&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;match_all&#34;</span>: {}
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>mathc匹配包含，如果在一个精确值的字段上使用match，例如数字、日期、布尔或者一个 not_analyzed 字符串字段，那么它将会精确匹配给定的值：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;query&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;match&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;demo&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>多字段match使用multi_match</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;multi_match&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;query&#34;</span>:    <span style="color:#e6db74">&#34;full text search&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;fields&#34;</span>:   [ <span style="color:#e6db74">&#34;title&#34;</span>, <span style="color:#e6db74">&#34;body&#34;</span> ]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>term查询被用于精确值匹配，这些精确值可能是数字、时间、布尔或者那些 not_analyzed 的字符串，term 查询对于输入的文本不分析 ，所以它将给定的值进行精确查询</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;query&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;term&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;demo&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>terms查询被用于匹配多个精确值</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;query&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;terms&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;name&#34;</span>: [<span style="color:#e6db74">&#34;demo&#34;</span>, <span style="color:#e6db74">&#34;demo1&#34;</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>合并(bool)查询可以组合多种查询方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;bool&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;must&#34;</span>:     { <span style="color:#f92672">&#34;match&#34;</span>: { <span style="color:#f92672">&#34;tweet&#34;</span>: <span style="color:#e6db74">&#34;elasticsearch&#34;</span> }},
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;must_not&#34;</span>: { <span style="color:#f92672">&#34;match&#34;</span>: { <span style="color:#f92672">&#34;name&#34;</span>:  <span style="color:#e6db74">&#34;mary&#34;</span> }},
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;should&#34;</span>:   { <span style="color:#f92672">&#34;match&#34;</span>: { <span style="color:#f92672">&#34;tweet&#34;</span>: <span style="color:#e6db74">&#34;full text&#34;</span> }},
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;filter&#34;</span>:   { <span style="color:#f92672">&#34;range&#34;</span>: { <span style="color:#f92672">&#34;age&#34;</span> : { <span style="color:#f92672">&#34;gt&#34;</span> : <span style="color:#ae81ff">30</span> }} }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="七参考链接">七、参考链接</h2>
<ul>
<li><a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started.html"  target="_blank" rel="noopener"
    >ElasticSearch 官方手册</a></li>
<li><a class="link" href="https://www.elastic.co/blog/a-practical-introduction-to-elasticsearch"  target="_blank" rel="noopener"
    >A Practical Introduction to Elasticsearch</a></li>
</ul>
<p>（完）</p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="lxbwolf/lxbwolf.github.io"
        issue-term="pathname"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2024 Xiaobin&#39;s Notes
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
