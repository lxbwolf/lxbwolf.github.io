<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='1. å‰è¨€ goçš„mapåº•å±‚å®ç°æ–¹å¼æ˜¯hashè¡¨ï¼ˆC&#43;&#43;çš„mapæ˜¯çº¢é»‘æ ‘å®ç°ï¼Œè€ŒC&#43;&#43; 11æ–°å¢çš„unordered_mapåˆ™ä¸goçš„mapç±»ä¼¼ï¼Œéƒ½'>
<title>go mapæ•°æ®ç»“æ„</title>

<link rel='canonical' href='http://lxb.wiki/aaf3975f/'>

<link rel="stylesheet" href="/scss/style.min.bc5bb6e306c354a2f5d5bfd1e65a5f3996962fb9b4a3546b748aee7daee4f258.css"><meta property='og:title' content='go mapæ•°æ®ç»“æ„'>
<meta property='og:description' content='1. å‰è¨€ goçš„mapåº•å±‚å®ç°æ–¹å¼æ˜¯hashè¡¨ï¼ˆC&#43;&#43;çš„mapæ˜¯çº¢é»‘æ ‘å®ç°ï¼Œè€ŒC&#43;&#43; 11æ–°å¢çš„unordered_mapåˆ™ä¸goçš„mapç±»ä¼¼ï¼Œéƒ½'>
<meta property='og:url' content='http://lxb.wiki/aaf3975f/'>
<meta property='og:site_name' content='Xiaobin&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='go' /><meta property='article:published_time' content='2021-08-28T22:30:18&#43;00:00'/><meta property='article:modified_time' content='2021-08-28T22:30:18&#43;00:00'/>
<meta name="twitter:title" content="go mapæ•°æ®ç»“æ„">
<meta name="twitter:description" content="1. å‰è¨€ goçš„mapåº•å±‚å®ç°æ–¹å¼æ˜¯hashè¡¨ï¼ˆC&#43;&#43;çš„mapæ˜¯çº¢é»‘æ ‘å®ç°ï¼Œè€ŒC&#43;&#43; 11æ–°å¢çš„unordered_mapåˆ™ä¸goçš„mapç±»ä¼¼ï¼Œéƒ½">
<link rel="shortcut icon" href="/favicon.png" />

<script data-ad-client="ca-pub-5708899526501350" async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-JZ2PWLT6JY"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-JZ2PWLT6JY');
</script>
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu692828361b78eaa42fdbdbbf5a7177a9_44446_300x0_resize_q75_box.jpeg" width="300"
                            height="298" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Xiaobin&#39;s Blog</a></h1>
            <h2 class="site-description"></h2>
        </div>
    </header><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                <span>é¦–é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/categories/' >
                
                
                
                <span>åˆ†ç±»</span>
            </a>
        </li>
        
        
        <li >
            <a href='/tags/' >
                
                
                
                <span>æ ‡ç­¾</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                <span>å‹é“¾</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>æš—è‰²æ¨¡å¼</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
<section class="widget archives">
    
    <h2 class="widget-title section-title">ç›®å½•</h2>

    <div class="widget--toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#21-æ ¸å¿ƒç»“ä½“ä½“">2.1 æ ¸å¿ƒç»“ä½“ä½“</a></li>
    <li><a href="#22-æ•°æ®ç»“æ„å›¾">2.2 æ•°æ®ç»“æ„å›¾</a></li>
  </ul>

  <ul>
    <li><a href="#31-åˆ›å»º">3.1 åˆ›å»º</a></li>
    <li><a href="#32-æ’å…¥æˆ–æ›´æ–°">3.2 æ’å…¥æˆ–æ›´æ–°</a></li>
    <li><a href="#33-åˆ é™¤">3.3 åˆ é™¤</a></li>
    <li><a href="#34-æŸ¥æ‰¾">3.4 æŸ¥æ‰¾</a></li>
    <li><a href="#35-rangeè¿­ä»£">3.5 rangeè¿­ä»£</a>
      <ul>
        <li><a href="#351-åˆå§‹åŒ–è¿­ä»£å™¨mapiterinit">3.5.1 åˆå§‹åŒ–è¿­ä»£å™¨mapiterinit()</a></li>
        <li><a href="#352-è¿­ä»£è¿‡ç¨‹mapiternext">3.5.2 è¿­ä»£è¿‡ç¨‹mapiternext()</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#41-æ‰©å®¹ç¼©å®¹çš„åŸºæœ¬åŸç†">4.1 æ‰©å®¹ç¼©å®¹çš„åŸºæœ¬åŸç†</a></li>
    <li><a href="#42-ä¸ºä»€ä¹ˆå«ä¼ªç¼©å®¹å¦‚ä½•å®ç°çœŸç¼©å®¹">4.2 ä¸ºä»€ä¹ˆå«â€œä¼ªç¼©å®¹â€ï¼Ÿå¦‚ä½•å®ç°â€œçœŸç¼©å®¹â€ï¼Ÿ</a></li>
  </ul>

  <ul>
    <li><a href="#51-åŸºæœ¬åŸç†">5.1 åŸºæœ¬åŸç†</a></li>
    <li><a href="#52-æ—¶é—´å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦åˆ†æ">5.2 æ—¶é—´å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦åˆ†æ</a></li>
  </ul>
</nav>
    </div>
</section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
        <a href="/categories/Lang/" >
            Lang
        </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/aaf3975f/">go mapæ•°æ®ç»“æ„</a>
        </h2>

        
    </div>

    
    
    
    
    <footer class="article-time">
        
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
            <time class="article-time--published">Aug 28, 2021</time>
        </div>
        

        
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



            <time class="article-time--reading">
                é˜…è¯»æ—¶é•¿: 18 åˆ†é’Ÿ
            </time>
        </div>
        
        <small>
    <section class="article-tags">
        
            <a href="/tags/go/">go</a>
        
    </section>
</small>
    </footer>
    

    
</div>
</header>

    <section class="article-content">
    
    
    <!-- raw HTML omitted -->
<h1 id="1-å‰è¨€">1. å‰è¨€</h1>
<p>goçš„mapåº•å±‚å®ç°æ–¹å¼æ˜¯hashè¡¨ï¼ˆC++çš„mapæ˜¯çº¢é»‘æ ‘å®ç°ï¼Œè€ŒC++ 11æ–°å¢çš„unordered_mapåˆ™ä¸goçš„mapç±»ä¼¼ï¼Œéƒ½æ˜¯hashå®ç°ï¼‰ã€‚go mapçš„æ•°æ®è¢«ç½®å…¥ä¸€ä¸ªç”±æ¡¶ç»„æˆçš„æœ‰åºæ•°ç»„ä¸­ï¼Œæ¯ä¸ªæ¡¶æœ€å¤šå¯ä»¥å­˜æ”¾8ä¸ªkey/valueå¯¹ã€‚keyçš„hashå€¼(32ä½)çš„ä½é˜¶ä½ç”¨äºåœ¨è¯¥æ•°ç»„ä¸­å®šä½åˆ°æ¡¶ï¼Œè€Œé«˜8ä½åˆ™ç”¨äºåœ¨æ¡¶ä¸­åŒºåˆ†key/valueå¯¹ã€‚
go mapçš„hashè¡¨ä¸­çš„åŸºæœ¬å•ä½æ˜¯æ¡¶ï¼Œæ¯ä¸ªæ¡¶æœ€å¤šå­˜8ä¸ªé”®å€¼å¯¹ï¼Œè¶…äº†ï¼Œåˆ™ä¼šé“¾æ¥åˆ°é¢å¤–çš„æº¢å‡ºæ¡¶ã€‚æ‰€ä»¥go mapæ˜¯åŸºæœ¬æ•°æ®ç»“æ„æ˜¯hashæ•°ç»„+æ¡¶å†…çš„key-valueæ•°ç»„+æº¢å‡ºçš„æ¡¶é“¾è¡¨
å½“hashè¡¨è¶…è¿‡é˜ˆå€¼éœ€è¦æ‰©å®¹å¢é•¿æ—¶ï¼Œä¼šåˆ†é…ä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œæ–°æ•°ç»„çš„å¤§å°ä¸€èˆ¬æ˜¯æ—§æ•°ç»„çš„2å€ã€‚è¿™é‡Œä»æ—§æ•°ç»„å°†æ•°æ®è¿ç§»åˆ°æ–°æ•°ç»„ï¼Œä¸ä¼šä¸€æ¬¡å…¨é‡æ‹·è´ï¼Œgoä¼šåœ¨æ¯æ¬¡è¯»å†™Mapæ—¶ä»¥æ¡¶ä¸ºå•ä½åšåŠ¨æ€æ¬è¿ç–æ•£ã€‚</p>
<h1 id="2-go-mapçš„æ•°æ®ç»“æ„">2. go mapçš„æ•°æ®ç»“æ„</h1>
<h2 id="21-æ ¸å¿ƒç»“ä½“ä½“">2.1 æ ¸å¿ƒç»“ä½“ä½“</h2>
<p>mapä¸»è¦ç”±ä¸¤ä¸ªæ ¸å¿ƒçš„ç»“æ„ï¼Œå³åŸºç¡€ç»“æ„å’Œæ¡¶å®ç°ï¼š</p>
<ul>
<li>hmapï¼šmapçš„åŸºç¡€ç»“æ„</li>
<li>bmapï¼šä¸¥æ ¼æ¥è¯´hmap.bucketsæŒ‡å‘æ¡¶ç»„æˆçš„æ•°ç»„ï¼Œæ¯ä¸ªæ¡¶çš„å¤´éƒ¨æ˜¯bmapï¼Œä¹‹åæ˜¯8ä¸ªkeyï¼Œå†æ˜¯8ä¸ªvalueï¼Œæœ€åæ˜¯1ä¸ªæº¢å‡ºæŒ‡é’ˆã€‚æº¢å‡ºæŒ‡é’ˆæŒ‡å‘é¢å¤–çš„æ¡¶é“¾è¡¨ï¼Œç”¨äºå­˜å‚¨æº¢å‡ºçš„æ•°æ®</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> ( <span style="color:#75715e">// å…³é”®çš„å˜é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">bucketCntBits</span> = <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bucketCnt</span>     = <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#a6e22e">bucketCntBits</span>  <span style="color:#75715e">// ä¸€ä¸ªæ¡¶æœ€å¤šå­˜å‚¨8ä¸ªkey-valueå¯¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">loadFactorNum</span> = <span style="color:#ae81ff">13</span> <span style="color:#75715e">// æ‰©æ•£å› å­ï¼šloadFactorNum / loadFactorDen = 6.5ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">loadFactorDen</span> = <span style="color:#ae81ff">2</span>  <span style="color:#75715e">// å³å…ƒç´ æ•°é‡ &gt;= (hashæ¡¶æ•°é‡(2^hmp.B) * 6.5 / 8) æ—¶ï¼Œè§¦å‘æ‰©å®¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// mapçš„åŸºç¡€æ•°æ®ç»“æ„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">hmap</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">count</span>     <span style="color:#66d9ef">int</span>	 <span style="color:#75715e">// mapå­˜å‚¨çš„å…ƒç´ å¯¹è®¡æ•°ï¼Œlen()å‡½æ•°è¿”å›æ­¤å€¼ï¼Œæ‰€ä»¥mapçš„len()æ—¶é—´å¤æ‚åº¦æ˜¯O(1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">flags</span>     <span style="color:#66d9ef">uint8</span>  <span style="color:#75715e">// è®°å½•å‡ ä¸ªç‰¹æ®Šçš„ä½æ ‡è®°ï¼Œå¦‚å½“å‰æ˜¯å¦æœ‰åˆ«çš„çº¿ç¨‹æ­£åœ¨å†™mapã€å½“å‰æ˜¯å¦ä¸ºç›¸åŒå¤§å°çš„å¢é•¿ï¼ˆæ‰©å®¹/ç¼©å®¹ï¼Ÿï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">B</span>         <span style="color:#66d9ef">uint8</span>  <span style="color:#75715e">// hashæ¡¶bucketsçš„æ•°é‡ä¸º2^Bä¸ª
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">noverflow</span> <span style="color:#66d9ef">uint16</span> <span style="color:#75715e">// æº¢å‡ºçš„æ¡¶çš„æ•°é‡çš„è¿‘ä¼¼å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">hash0</span>     <span style="color:#66d9ef">uint32</span> <span style="color:#75715e">// hashç§å­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">buckets</span>    <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span> <span style="color:#75715e">// æŒ‡å‘2^Bä¸ªæ¡¶ç»„æˆçš„æ•°ç»„çš„æŒ‡é’ˆï¼Œæ•°æ®å­˜åœ¨è¿™é‡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">oldbuckets</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span> <span style="color:#75715e">// æŒ‡å‘æ‰©å®¹å‰çš„æ—§bucketsæ•°ç»„ï¼Œåªåœ¨mapå¢é•¿æ—¶æœ‰æ•ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">nevacuate</span>  <span style="color:#66d9ef">uintptr</span>        <span style="color:#75715e">// è®¡æ•°å™¨ï¼Œæ ‡ç¤ºæ‰©å®¹åæ¬è¿çš„è¿›åº¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">extra</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mapextra</span> <span style="color:#75715e">// ä¿å­˜æº¢å‡ºæ¡¶çš„é“¾è¡¨å’Œæœªä½¿ç”¨çš„æº¢å‡ºæ¡¶æ•°ç»„çš„é¦–åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// æ¡¶çš„å®ç°ç»“æ„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">bmap</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// tophashå­˜å‚¨æ¡¶å†…æ¯ä¸ªkeyçš„hashå€¼çš„é«˜å­—èŠ‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// tophash[0] &lt; minTopHashè¡¨ç¤ºæ¡¶çš„ç–æ•£çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// å½“å‰ç‰ˆæœ¬bucketCntçš„å€¼æ˜¯8ï¼Œä¸€ä¸ªæ¡¶æœ€å¤šå­˜å‚¨8ä¸ªkey-valueå¯¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">tophash</span> [<span style="color:#a6e22e">bucketCnt</span>]<span style="color:#66d9ef">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ç‰¹åˆ«æ³¨æ„ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// å®é™…åˆ†é…å†…å­˜æ—¶ä¼šç”³è¯·ä¸€ä¸ªæ›´å¤§çš„å†…å­˜ç©ºé—´Aï¼ŒAçš„å‰8å­—èŠ‚ä¸ºbmap
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// åé¢ä¾æ¬¡è·Ÿ8ä¸ªkeyã€8ä¸ªvalueã€1ä¸ªæº¢å‡ºæŒ‡é’ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// mapçš„æ¡¶ç»“æ„å®é™…æŒ‡çš„æ˜¯å†…å­˜ç©ºé—´A
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// map.goé‡Œå¾ˆå¤šå‡½æ•°çš„ç¬¬1ä¸ªå…¥å‚æ˜¯è¿™ä¸ªç»“æ„ï¼Œä»æˆå‘˜æ¥çœ‹å¾ˆæ˜æ˜¾ï¼Œæ­¤ç»“æ„æ ‡ç¤ºäº†é”®å€¼å¯¹å’Œæ¡¶çš„å¤§å°ç­‰å¿…è¦ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// æœ‰äº†è¿™ä¸ªç»“æ„çš„ä¿¡æ¯ï¼Œmap.goçš„ä»£ç å°±å¯ä»¥ä¸é”®å€¼å¯¹çš„å…·ä½“æ•°æ®ç±»å‹è§£è€¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// æ‰€ä»¥map.goç”¨å†…å­˜åç§»é‡å’Œunsafe.PointeræŒ‡é’ˆæ¥ç›´æ¥å¯¹å†…å­˜è¿›è¡Œå­˜å–ï¼Œè€Œæ— éœ€å…³å¿ƒkeyæˆ–valueçš„å…·ä½“ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">maptype</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">typ</span>        <span style="color:#a6e22e">_type</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">key</span>        <span style="color:#f92672">*</span><span style="color:#a6e22e">_type</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">elem</span>       <span style="color:#f92672">*</span><span style="color:#a6e22e">_type</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bucket</span>     <span style="color:#f92672">*</span><span style="color:#a6e22e">_type</span> <span style="color:#75715e">// internal type representing a hash bucket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">keysize</span>    <span style="color:#66d9ef">uint8</span>  <span style="color:#75715e">// size of key slot
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">valuesize</span>  <span style="color:#66d9ef">uint8</span>  <span style="color:#75715e">// size of value slot
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">bucketsize</span> <span style="color:#66d9ef">uint16</span> <span style="color:#75715e">// size of bucket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">flags</span>      <span style="color:#66d9ef">uint32</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>C++ä½¿ç”¨æ¨¡æ¿å¯ä»¥æ ¹æ®ä¸åŒçš„ç±»å‹ç”Ÿæˆmapçš„ä»£ç ã€‚
golangåˆ™é€šè¿‡ä¸Šè¿°maptypeç»“æ„ä½“ä¼ é€’é”®å€¼å¯¹çš„ç±»å‹å¤§å°ç­‰ä¿¡æ¯ï¼Œä»è€Œmap.goç›´æ¥ç”¨æŒ‡é’ˆæ“ä½œå¯¹åº”å¤§å°çš„å†…å­˜æ¥å®ç°å…¨å±€ä¸€ä»½mapä»£ç åŒæ—¶é€‚ç”¨äºä¸åŒç±»å‹çš„é”®å€¼å¯¹ã€‚è¿™ç‚¹ä¸Šå¯ä»¥è®¤ä¸ºç›¸æ¯”C++ç”¨æ¨¡æ¿å®ç°mapçš„æ–¹å¼ï¼Œgo mapçš„ç›®æ ‡æ–‡ä»¶çš„ä»£ç é‡ä¼šæ›´å°ã€‚</p>
<h2 id="22-æ•°æ®ç»“æ„å›¾">2.2 æ•°æ®ç»“æ„å›¾</h2>
<p>mapåº•å±‚åˆ›å»ºæ—¶ï¼Œä¼šåˆå§‹åŒ–ä¸€ä¸ªhmapç»“æ„ä½“ï¼ŒåŒæ—¶åˆ†é…ä¸€ä¸ªè¶³å¤Ÿå¤§çš„å†…å­˜ç©ºé—´Aã€‚å…¶ä¸­Açš„å‰æ®µç”¨äºhashæ•°ç»„ï¼ŒAçš„åæ®µé¢„ç•™ç»™æº¢å‡ºçš„æ¡¶ã€‚äºæ˜¯hmap.bucketsæŒ‡å‘hashæ•°ç»„ï¼Œå³Açš„é¦–åœ°å€ï¼›hmap.extra.nextOverflowåˆå§‹æ—¶æŒ‡å‘å†…å­˜Aä¸­çš„åæ®µï¼Œå³hashæ•°ç»„ç»“å°¾çš„ä¸‹ä¸€ä¸ªæ¡¶ï¼Œä¹Ÿå³ç¬¬1ä¸ªé¢„ç•™çš„æº¢å‡ºæ¡¶ã€‚æ‰€ä»¥å½“hashå†²çªéœ€è¦ä½¿ç”¨åˆ°æ–°çš„æº¢å‡ºæ¡¶æ—¶ï¼Œä¼šä¼˜å…ˆä½¿ç”¨ä¸Šè¿°é¢„ç•™çš„æº¢å‡ºæ¡¶ï¼Œhmap.extra.nextOverflowä¾æ¬¡å¾€ååç§»ç›´åˆ°ç”¨å®Œæ‰€æœ‰çš„æº¢å‡ºæ¡¶ï¼Œæ‰æœ‰å¯èƒ½ä¼šç”³è¯·æ–°çš„æº¢å‡ºæ¡¶ç©ºé—´ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220226143452.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>ä¸Šå›¾ä¸­ï¼Œå½“éœ€è¦åˆ†é…ä¸€ä¸ªæº¢å‡ºæ¡¶æ—¶ï¼Œä¼šä¼˜å…ˆä»é¢„ç•™çš„æº¢å‡ºæ¡¶æ•°ç»„é‡Œå–ä¸€ä¸ªå‡ºæ¥é“¾æ¥åˆ°é“¾è¡¨åé¢ï¼Œè¿™æ—¶ä¸éœ€è¦å†æ¬¡ç”³è¯·å†…å­˜ã€‚ä½†å½“é¢„ç•™çš„æ¡¶è¢«ç”¨å®Œäº†ï¼Œåˆ™éœ€è¦ç”³è¯·æ–°çš„å†…å­˜ç»™æº¢å‡ºæ¡¶ã€‚</p>
<h1 id="3-go-mapçš„å¸¸ç”¨æ“ä½œ">3. go mapçš„å¸¸ç”¨æ“ä½œ</h1>
<h2 id="31-åˆ›å»º">3.1 åˆ›å»º</h2>
<p>ä½¿ç”¨make(map[k]v, hint)åˆ›å»ºmapæ—¶ä¼šè°ƒç”¨makemap()å‡½æ•°ï¼Œä»£ç é€»è¾‘æ¯”è¾ƒç®€å•ã€‚
å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œmakemap()åˆ›å»ºçš„hashæ•°ç»„ï¼Œæ•°ç»„çš„å‰é¢æ˜¯hashè¡¨çš„ç©ºé—´ï¼Œå½“hint &gt;= 4æ—¶åé¢ä¼šè¿½åŠ 2^(hint-4)ä¸ªæ¡¶ï¼Œä¹‹åå†å†…å­˜é¡µå¸§å¯¹é½åˆè¿½åŠ äº†è‹¥å¹²ä¸ªæ¡¶ï¼ˆå‚è§2.2ç« èŠ‚ç»“æ„å›¾çš„hashæ•°ç»„éƒ¨åˆ†ï¼‰
æ‰€ä»¥åˆ›å»ºmapæ—¶ä¸€æ¬¡å†…å­˜åˆ†é…æ—¢åˆ†é…äº†ç”¨æˆ·é¢„æœŸå¤§å°çš„hashæ•°ç»„ï¼Œåˆè¿½åŠ äº†ä¸€å®šé‡çš„é¢„ç•™çš„æº¢å‡ºæ¡¶ï¼Œè¿˜åšäº†å†…å­˜å¯¹é½ï¼Œä¸€ä¸¾å¤šå¾—ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// make(map[k]v, hint), hintå³é¢„åˆ†é…å¤§å°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ä¸ä¼ hintæ—¶ï¼Œå¦‚ç”¨newåˆ›å»ºä¸ªé¢„è®¾å®¹é‡ä¸º0çš„mapæ—¶ï¼Œmakemapåªåˆå§‹åŒ–hmapç»“æ„ï¼Œä¸åˆ†é…hashæ•°ç»„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">makemap</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">maptype</span>, <span style="color:#a6e22e">hint</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hmap</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">hmap</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// çœç•¥éƒ¨åˆ†ä»£ç 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// éšæœºhashç§å­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">hash0</span> = <span style="color:#a6e22e">fastrand</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 2^h.B ä¸ºå¤§äºhint*6.5(æ‰©å®¹å› å­)çš„æœ€å°çš„2çš„å¹‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">B</span> <span style="color:#f92672">:=</span> uint8(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// overLoadFactor(hint, B)åªæœ‰ä¸€è¡Œä»£ç ï¼šreturn hint &gt; bucketCnt &amp;&amp; uintptr(hint) &gt; loadFactorNum*(bucketShift(B)/loadFactorDen)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// å³Bçš„å¤§å°åº”æ»¡è¶³ hint &lt;= (2^B) * 6.5
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// ä¸€ä¸ªæ¡¶èƒ½å­˜8å¯¹key-valueï¼Œæ‰€ä»¥è¿™å°±è¡¨ç¤ºBçš„åˆå§‹å€¼æ˜¯ä¿è¯è¿™ä¸ªmapä¸éœ€è¦æ‰©å®¹å³å¯å­˜ä¸‹hintä¸ªå…ƒç´ å¯¹çš„æœ€å°çš„Bå€¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">overLoadFactor</span>(<span style="color:#a6e22e">hint</span>, <span style="color:#a6e22e">B</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">B</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">B</span> = <span style="color:#a6e22e">B</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// è¿™é‡Œåˆ†é…hashæ•°ç»„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">B</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">nextOverflow</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">bmap</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">buckets</span>, <span style="color:#a6e22e">nextOverflow</span> = <span style="color:#a6e22e">makeBucketArray</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">B</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// makeBucketArray()ä¼šåœ¨hashæ•°ç»„åé¢é¢„åˆ†é…ä¸€äº›æº¢å‡ºæ¡¶ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// h.extra.nextOverflowç”¨æ¥ä¿å­˜ä¸Šè¿°æº¢å‡ºæ¡¶çš„é¦–åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">nextOverflow</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">extra</span> = new(<span style="color:#a6e22e">mapextra</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">extra</span>.<span style="color:#a6e22e">nextOverflow</span> = <span style="color:#a6e22e">nextOverflow</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">h</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// åˆ†é…hashæ•°ç»„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">makeBucketArray</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">maptype</span>, <span style="color:#a6e22e">b</span> <span style="color:#66d9ef">uint8</span>, <span style="color:#a6e22e">dirtyalloc</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>) (<span style="color:#a6e22e">buckets</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">nextOverflow</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">bmap</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">base</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bucketShift</span>(<span style="color:#a6e22e">b</span>) <span style="color:#75715e">// baseä»£è¡¨ç”¨æˆ·é¢„æœŸçš„æ¡¶çš„æ•°é‡ï¼Œå³hashæ•°ç»„çš„çœŸå®å¤§å°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">nbuckets</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base</span> <span style="color:#75715e">// nbucketsè¡¨ç¤ºå®é™…åˆ†é…çš„æ¡¶çš„æ•°é‡ï¼Œ&gt;= baseï¼Œè¿™å°±å¯èƒ½ä¼šè¿½åŠ ä¸€äº›æº¢å‡ºæ¡¶ä½œä¸ºæº¢å‡ºçš„é¢„ç•™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">4</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// è¿™é‡Œè¿½åŠ ä¸€å®šæ•°é‡çš„æ¡¶ï¼Œå¹¶åšå†…å­˜å¯¹é½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">nbuckets</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">bucketShift</span>(<span style="color:#a6e22e">b</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">sz</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">bucket</span>.<span style="color:#a6e22e">size</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">nbuckets</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">up</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">roundupsize</span>(<span style="color:#a6e22e">sz</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">up</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">sz</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">nbuckets</span> = <span style="color:#a6e22e">up</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">bucket</span>.<span style="color:#a6e22e">size</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åé¢çš„ä»£ç å°±æ˜¯ç”³è¯·å†…å­˜ç©ºé—´äº†ï¼Œæ­¤å¤„çœç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// è¿™é‡Œå¤§å®¶å¯ä»¥æ€è€ƒä¸‹è¿™ä¸ªæ•°ç»„ç©ºé—´è¦æ€ä¹ˆåˆ†é…ï¼Œå…¶å®å°±æ˜¯n*sizeof(æ¡¶)ï¼Œæ‰€ä»¥ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// æ¯ä¸ªæ¡¶å‰é¢æ˜¯8å­—èŠ‚çš„tophashæ•°ç»„ï¼Œç„¶åæ˜¯8ä¸ªkeyï¼Œå†æ˜¯8ä¸ªvalueï¼Œæœ€åæ”¾ä¸€ä¸ªæº¢å‡ºæŒ‡é’ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// sizeof(æ¡¶) = 8 + 8*sizeof(key) + 8*sizeof(value) + 8
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">buckets</span>, <span style="color:#a6e22e">nextOverflow</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="32-æ’å…¥æˆ–æ›´æ–°">3.2 æ’å…¥æˆ–æ›´æ–°</h2>
<p>go mapçš„æ’å…¥æ“ä½œï¼Œè°ƒç”¨mapassign()å‡½æ•°ã€‚
åŒå­¦ä»¬æˆ–è®¸åœ¨æŸäº›èµ„æ–™ä¸Šäº†è§£è¿‡ï¼š</p>
<ul>
<li>go mapéœ€è¦åˆå§‹åŒ–æ‰èƒ½ä½¿ç”¨ï¼Œå¯¹ç©ºmapæ’å…¥ä¼španicã€‚hmapæŒ‡é’ˆä¼ é€’çš„æ–¹å¼ï¼Œå†³å®šäº†mapåœ¨ä½¿ç”¨å‰å¿…é¡»åˆå§‹åŒ–</li>
<li>go mapä¸æ”¯æŒå¹¶å‘è¯»å†™ï¼Œä¼španicã€‚å¦‚æœä¸€å®šè¦å¹¶å‘ï¼Œè¯·ç”¨sync.Mapæˆ–è‡ªå·±è§£å†³å†²çª</li>
</ul>
<p>ä¸Šè¿°ä¸¤ä¸ªé™åˆ¶ï¼Œåœ¨mapassign()å‡½æ•°å¼€å¤´èƒ½æ‰¾åˆ°ç­”æ¡ˆï¼š</p>
<p>1 å‚æ•°åˆæ³•æ€§æ£€æµ‹ï¼Œè®¡ç®—hashå€¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">mapassign</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">maptype</span>, <span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hmap</span>, <span style="color:#a6e22e">key</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>) <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä¸ç†Ÿæ‚‰æŒ‡é’ˆæ“ä½œçš„åŒå­¦ï¼Œç”¨æŒ‡é’ˆä¼ å‚å¾€å¾€ä¼šè¸©ç©ºæŒ‡é’ˆçš„å‘
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// è¿™é‡Œå¤§å®¶å¯ä»¥æ€è€ƒä¸‹ï¼Œä¸ºä»€ä¹ˆhè¦éç©ºåˆ¤æ–­ï¼Ÿ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¦‚æœä¸€å®šè¦åœ¨è¿™é‡Œæ”¯æŒç©ºmapå¹¶æ£€æµ‹åˆ°mapä¸ºç©ºæ—¶è‡ªåŠ¨åˆå§‹åŒ–ï¼Œåº”è¯¥æ€ä¹ˆå†™ï¼Ÿ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// æç¤ºï¼šæŒ‡é’ˆçš„æŒ‡é’ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">h</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">plainError</span>(<span style="color:#e6db74">&#34;assignment to entry in nil map&#34;</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åœ¨è¿™é‡Œåšå¹¶å‘åˆ¤æ–­ï¼Œæ£€æµ‹åˆ°å¹¶å‘å†™æ—¶ï¼ŒæŠ›å¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// æ³¨æ„ï¼šgo mapçš„å¹¶å‘æ£€æµ‹æ˜¯ä¼ªæ£€æµ‹ï¼Œå¹¶ä¸ä¿è¯æ‰€æœ‰çš„å¹¶å‘éƒ½ä¼šè¢«æ£€æµ‹å‡ºæ¥ã€‚è€Œä¸”è¿™ç©æ„æ˜¯åœ¨è¿è¡ŒæœŸæ£€æµ‹ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// æ‰€ä»¥å¯¹mapæœ‰å¹¶å‘è¦æ±‚æ—¶ï¼Œåº”ä½¿ç”¨sync.mapæ¥ä»£æ›¿æ™®é€šmapï¼Œé€šè¿‡åŠ é”æ¥é˜»æ–­å¹¶å‘å†²çª
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">flags</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">hashWriting</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">throw</span>(<span style="color:#e6db74">&#34;concurrent map writes&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">hash</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">alg</span>.<span style="color:#a6e22e">hash</span>(<span style="color:#a6e22e">key</span>, uintptr(<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">hash0</span>)) <span style="color:#75715e">// è¿™é‡Œå¾—åˆ°uint32çš„hashå€¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">flags</span> ^= <span style="color:#a6e22e">hashWriting</span> <span style="color:#75715e">// ç½®Writingæ ‡å¿—ï¼Œkeyå†™å…¥bucketsåæ‰ä¼šæ¸…é™¤æ ‡å¿—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">buckets</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> { <span style="color:#75715e">// mapä¸èƒ½ä¸ºç©ºï¼Œä½†hashæ•°ç»„å¯ä»¥åˆå§‹æ˜¯ç©ºçš„ï¼Œè¿™é‡Œä¼šåˆå§‹åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">buckets</span> = <span style="color:#a6e22e">newobject</span>(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">bucket</span>) <span style="color:#75715e">// newarray(t.bucket, 1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>2 å®šä½keyåœ¨hashè¡¨ä¸­çš„ä½ç½®</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">mapassign</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">maptype</span>, <span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hmap</span>, <span style="color:#a6e22e">key</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>) <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">again</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bucket</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">hash</span> <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">bucketMask</span>(<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">B</span>) <span style="color:#75715e">// è¿™é‡Œç”¨hashå€¼çš„ä½é˜¶ä½å®šä½hashæ•°ç»„çš„ä¸‹æ ‡åç§»é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">growing</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">growWork</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">h</span>, <span style="color:#a6e22e">bucket</span>) <span style="color:#75715e">// è¿™é‡Œæ˜¯mapçš„æ‰©å®¹ç¼©å®¹æ“ä½œï¼Œæˆ‘ä»¬åœ¨ç¬¬4ç« å•ç‹¬è®²
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// é€šè¿‡ä¸‹æ ‡bucketï¼Œåç§»å®šä½åˆ°å…·ä½“çš„æ¡¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">bmap</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(uintptr(<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">buckets</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">bucket</span><span style="color:#f92672">*</span>uintptr(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">bucketsize</span>)))
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">top</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tophash</span>(<span style="color:#a6e22e">hash</span>) <span style="color:#75715e">// è¿™é‡Œå–é«˜8ä½ç”¨äºåœ¨æ¡¶å†…å®šä½é”®å€¼å¯¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>3 è¿›ä¸€æ­¥å®šä½keyå¯ä»¥æ’å…¥çš„æ¡¶åŠæ¡¶ä¸­çš„ä½ç½®</p>
<ul>
<li>ä¸¤è½®å¾ªç¯ï¼Œå¤–å±‚å¾ªç¯éå†hashæ¡¶åŠå…¶æŒ‡å‘çš„æº¢å‡ºé“¾è¡¨ï¼Œå†…å±‚å¾ªç¯åˆ™åœ¨æ¡¶å†…éå†ï¼ˆä¸€ä¸ªæ¡¶æœ€å¤š8ä¸ªkey-valueå¯¹ï¼‰</li>
<li>æœ‰å¯èƒ½æ­£å¥½é“¾è¡¨ä¸Šçš„æ¡¶éƒ½æ»¡äº†ï¼Œè¿™æ—¶insertiä¸ºnilï¼Œç¬¬4æ­¥ä¼šé“¾æ¥ä¸€ä¸ªæ–°çš„æº¢å‡ºæ¡¶è¿›æ¥</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">mapassign</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">maptype</span>, <span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hmap</span>, <span style="color:#a6e22e">key</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>) <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">inserti</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">uint8</span>          <span style="color:#75715e">// tophashæ’å…¥ä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">insertk</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>  <span style="color:#75715e">// keyæ’å…¥ä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">val</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>      <span style="color:#75715e">// valueæ’å…¥ä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">bucketloop</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> uintptr(<span style="color:#ae81ff">0</span>); <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">bucketCnt</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">tophash</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">!=</span> <span style="color:#a6e22e">top</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isEmpty</span>(<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">tophash</span>[<span style="color:#a6e22e">i</span>]) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">inserti</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				    <span style="color:#75715e">// æ‰¾åˆ°ä¸ªç©ºä½ï¼Œå…ˆè®°å½•ä¸‹tophashã€keyã€valueçš„æ’å…¥ä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				    <span style="color:#75715e">// ä½†è¦éå†å®Œæ‰èƒ½ç¡®å®šè¦ä¸è¦æ’å…¥åˆ°è¿™ä¸ªä½ç½®ï¼Œå› ä¸ºåé¢æœ‰å¯èƒ½æœ‰é‡å¤çš„å…ƒç´ 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					<span style="color:#a6e22e">inserti</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">tophash</span>[<span style="color:#a6e22e">i</span>]
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">insertk</span> = <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">b</span>), <span style="color:#a6e22e">dataOffset</span><span style="color:#f92672">+</span><span style="color:#a6e22e">i</span><span style="color:#f92672">*</span>uintptr(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">keysize</span>))
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">val</span> = <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">b</span>), <span style="color:#a6e22e">dataOffset</span><span style="color:#f92672">+</span><span style="color:#a6e22e">bucketCnt</span><span style="color:#f92672">*</span>uintptr(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">keysize</span>)<span style="color:#f92672">+</span><span style="color:#a6e22e">i</span><span style="color:#f92672">*</span>uintptr(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">valuesize</span>))
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">tophash</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">==</span> <span style="color:#a6e22e">emptyRest</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">break</span> <span style="color:#a6e22e">bucketloop</span> <span style="color:#75715e">// éå†å®Œæ•´ä¸ªæº¢å‡ºé“¾è¡¨ï¼Œé€€å‡ºå¾ªç¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">k</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">b</span>), <span style="color:#a6e22e">dataOffset</span><span style="color:#f92672">+</span><span style="color:#a6e22e">i</span><span style="color:#f92672">*</span>uintptr(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">keysize</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">indirectkey</span>() {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">k</span> = <span style="color:#f92672">*</span>((<span style="color:#f92672">*</span><span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>)(<span style="color:#a6e22e">k</span>))
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">alg</span>.<span style="color:#a6e22e">equal</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">k</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// èµ°åˆ°è¿™é‡Œè¯´æ˜mapé‡Œæ‰¾åˆ°ä¸€ä¸ªé‡å¤çš„keyï¼Œæ›´æ–°key-valueï¼Œè·³åˆ°ç¬¬5æ­¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">needkeyupdate</span>() {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">typedmemmove</span>(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">key</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">val</span> = <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">b</span>), <span style="color:#a6e22e">dataOffset</span><span style="color:#f92672">+</span><span style="color:#a6e22e">bucketCnt</span><span style="color:#f92672">*</span>uintptr(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">keysize</span>)<span style="color:#f92672">+</span><span style="color:#a6e22e">i</span><span style="color:#f92672">*</span>uintptr(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">valuesize</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">done</span> <span style="color:#75715e">// æ›´æ–°Keyåè·³åˆ°ç¬¬5æ­¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ovf</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">overflow</span>(<span style="color:#a6e22e">t</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ovf</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span> <span style="color:#75715e">// éå†å®Œæ•´ä¸ªæº¢å‡ºé“¾è¡¨ï¼Œæ²¡æ‰¾åˆ°èƒ½æ’å…¥çš„ç©ºä½ï¼Œç»“æŸå¾ªç¯ï¼Œä¸‹ä¸€æ­¥å†è¿½åŠ ä¸€ä¸ªæº¢å‡ºæ¡¶è¿›æ¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">b</span> = <span style="color:#a6e22e">ovf</span> <span style="color:#75715e">// ç»§ç»­éå†ä¸‹ä¸€ä¸ªæº¢å‡ºæ¡¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>4 æ’å…¥ key</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">mapassign</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">maptype</span>, <span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hmap</span>, <span style="color:#a6e22e">key</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>) <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è¿™é‡Œåˆ¤æ–­è¦ä¸è¦æ‰©å®¹ï¼Œæˆ‘ä»¬ç¬¬4ç« å†è®²
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">growing</span>() <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">overLoadFactor</span>(<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">count</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">B</span>) <span style="color:#f92672">||</span> <span style="color:#a6e22e">tooManyOverflowBuckets</span>(<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">noverflow</span>, <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">B</span>)) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">hashGrow</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">h</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">again</span> <span style="color:#75715e">// Growing the table invalidates everything, so try again
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">inserti</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> { <span style="color:#75715e">// inserti == nilè¯´æ˜ä¸Š1æ­¥æ²¡æ‰¾åˆ°ç©ºä½ï¼Œæ•´ä¸ªé“¾è¡¨æ˜¯æ»¡çš„ï¼Œè¿™é‡Œæ·»åŠ ä¸€ä¸ªæ–°çš„æº¢å‡ºæ¡¶ä¸Šå»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">newb</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">newoverflow</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">b</span>) <span style="color:#75715e">// åˆ†é…æ–°æº¢å‡ºæ¡¶ï¼Œä¼˜å…ˆç”¨3.1ç« èŠ‚é¢„ç•™çš„æº¢å‡ºæ¡¶ï¼Œç”¨å®Œäº†åˆ™åˆ†é…ä¸€ä¸ªæ–°æ¡¶å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">inserti</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">newb</span>.<span style="color:#a6e22e">tophash</span>[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">insertk</span> = <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">newb</span>), <span style="color:#a6e22e">dataOffset</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">val</span> = <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">insertk</span>, <span style="color:#a6e22e">bucketCnt</span><span style="color:#f92672">*</span>uintptr(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">keysize</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å½“keyæˆ–valueçš„ç±»å‹å¤§å°è¶…è¿‡ä¸€å®šå€¼æ—¶ï¼Œæ¡¶åªå­˜å‚¨keyæˆ–valueçš„æŒ‡é’ˆã€‚è¿™é‡Œåˆ†é…ç©ºé—´å¹¶å–æŒ‡é’ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">indirectkey</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">kmem</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newobject</span>(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">key</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">*</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>)(<span style="color:#a6e22e">insertk</span>) = <span style="color:#a6e22e">kmem</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">insertk</span> = <span style="color:#a6e22e">kmem</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">indirectvalue</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">vmem</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newobject</span>(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">elem</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">*</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>)(<span style="color:#a6e22e">val</span>) = <span style="color:#a6e22e">vmem</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">typedmemmove</span>(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">insertk</span>, <span style="color:#a6e22e">key</span>) <span style="color:#75715e">// åœ¨æ¡¶ä¸­å¯¹åº”ä½ç½®æ’å…¥key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">*</span><span style="color:#a6e22e">inserti</span> = <span style="color:#a6e22e">top</span> <span style="color:#75715e">// æ’å…¥tophashï¼Œhashå€¼é«˜8ä½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">count</span><span style="color:#f92672">++</span> <span style="color:#75715e">// æ’å…¥äº†æ–°çš„é”®å€¼å¯¹ï¼Œh.countæ•°é‡+1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>5 ç»“æŸæ’å…¥</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span> <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">mapassign</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">maptype</span>, <span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hmap</span>, <span style="color:#a6e22e">key</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>) <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">done</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">flags</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">hashWriting</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">throw</span>(<span style="color:#e6db74">&#34;concurrent map writes&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">flags</span> <span style="color:#f92672">&amp;^=</span> <span style="color:#a6e22e">hashWriting</span> <span style="color:#75715e">// é‡Šæ”¾hashWritingæ ‡å¿—ä½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">indirectvalue</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">val</span> = <span style="color:#f92672">*</span>((<span style="color:#f92672">*</span><span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>)(<span style="color:#a6e22e">val</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">val</span> <span style="color:#75715e">// è¿”å›valueå¯æ’å…¥ä½ç½®çš„æŒ‡é’ˆï¼Œæ³¨æ„ï¼Œvalueè¿˜æ²¡æ’å…¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><ul>
<li>åªæ’å…¥äº†tophashå’Œkeyï¼Œå°±ç»“æŸäº†å—ï¼Ÿvalueè¿˜æ²¡æ’å…¥å‘¢</li>
<li>æ˜¯çš„ï¼Œmapassign()åªæ’å…¥tophashå’Œkeyï¼Œå¹¶è¿”å›valæŒ‡é’ˆï¼Œç¼–è¯‘å™¨ä¼šåœ¨è°ƒç”¨mapassign()åç”¨æ±‡ç¼–å¾€valæ’å…¥value</li>
<li>googleå¤§ä½¬è¿™ä¹ˆéªšæ°”çš„æ“ä½œï¼Œæ˜¯ä¸ºäº†å‡å°‘valueå€¼ä¼ é€’çš„æ¬¡æ•°å—ï¼Ÿ</li>
</ul>
<h2 id="33-åˆ é™¤">3.3 åˆ é™¤</h2>
<ol>
<li>åˆ é™¤ä¸æ’å…¥ç±»ä¼¼ï¼Œå‰é¢çš„æ­¥éª¤éƒ½æ˜¯å‚æ•°å’ŒçŠ¶æ€åˆ¤æ–­ã€å®šä½key-valueä½ç½®ï¼Œç„¶åclearå¯¹åº”çš„å†…å­˜ã€‚ä¸å±•å¼€è¯´ã€‚ä»¥ä¸‹æ˜¯å‡ ä¸ªå…³é”®ç‚¹ï¼š</li>
</ol>
<ul>
<li>åˆ é™¤è¿‡ç¨‹ä¸­ä¹Ÿä¼šç½®hashWritingæ ‡å¿—</li>
<li>å½“key/valueè¿‡å¤§æ—¶ï¼Œhashè¡¨é‡Œå­˜å‚¨çš„æ˜¯æŒ‡é’ˆï¼Œè¿™æ—¶å€™ç”¨è½¯åˆ é™¤ï¼Œç½®æŒ‡é’ˆä¸ºnilï¼Œæ•°æ®äº¤ç»™gcå»åˆ ã€‚å½“ç„¶ï¼Œè¿™æ˜¯mapçš„å†…éƒ¨å¤„ç†ï¼Œå¤–å±‚æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œæ‹¿åˆ°çš„éƒ½æ˜¯å€¼æ‹·è´</li>
<li>æ— è®ºKey/valueæ˜¯å€¼ç±»å‹è¿˜æ˜¯æŒ‡é’ˆç±»å‹ï¼Œåˆ é™¤æ“ä½œéƒ½åªå½±å“hashè¡¨ï¼Œå¤–å±‚å·²ç»æ‹¿åˆ°çš„æ•°æ®ä¸å—å½±å“ã€‚å°¤å…¶æ˜¯æŒ‡é’ˆç±»å‹ï¼Œå¤–å±‚çš„æŒ‡é’ˆè¿˜èƒ½ç»§ç»­ä½¿ç”¨</li>
</ul>
<ol>
<li>ç”±äºå®šä½keyä½ç½®çš„æ–¹å¼æ˜¯æŸ¥æ‰¾tophashï¼Œæ‰€ä»¥åˆ é™¤æ“ä½œå¯¹tophashçš„å¤„ç†æ˜¯å…³é”®ï¼š</li>
</ol>
<ul>
<li>mapé¦–å…ˆå°†å¯¹åº”ä½ç½®çš„tophash[i]ç½®ä¸ºemptyOneï¼Œè¡¨ç¤ºè¯¥ä½ç½®å·²è¢«åˆ é™¤</li>
<li>å¦‚æœtophash[i]ä¸æ˜¯æ•´ä¸ªé“¾è¡¨çš„æœ€åä¸€ä¸ªï¼Œåˆ™åªç½®emptyOneæ ‡å¿—ï¼Œè¯¥ä½ç½®è¢«åˆ é™¤ä½†æœªé‡Šæ”¾ï¼Œåç»­æ’å…¥æ“ä½œä¸èƒ½ä½¿ç”¨æ­¤ä½ç½®</li>
<li>å¦‚æœtophash[i]æ˜¯é“¾è¡¨æœ€åä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹äº†ï¼Œåˆ™æŠŠé“¾è¡¨æœ€åé¢çš„æ‰€æœ‰æ ‡å¿—ä¸ºemptyOneçš„ä½ç½®ï¼Œéƒ½ç½®ä¸ºemptyRestã€‚ç½®ä¸ºemptyRestçš„ä½ç½®å¯ä»¥åœ¨åç»­çš„æ’å…¥æ“ä½œä¸­è¢«ä½¿ç”¨ã€‚</li>
<li>è¿™ç§åˆ é™¤æ–¹å¼ï¼Œä»¥å°‘é‡ç©ºé—´æ¥é¿å…æ¡¶é“¾è¡¨å’Œæ¡¶å†…çš„æ•°æ®ç§»åŠ¨ã€‚äº‹å®ä¸Šï¼Œgo æ•°æ®ä¸€æ—¦è¢«æ’å…¥åˆ°æ¡¶çš„ç¡®åˆ‡ä½ç½®ï¼Œmapæ˜¯ä¸ä¼šå†ç§»åŠ¨è¯¥æ•°æ®åœ¨æ¡¶ä¸­çš„ä½ç½®äº†ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">mapdelete</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">maptype</span>, <span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hmap</span>, <span style="color:#a6e22e">key</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">tophash</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#a6e22e">emptyOne</span> <span style="color:#75715e">// å…ˆæ ‡è®°åˆ é™¤
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// å¦‚æœb.tophash[i]ä¸æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ï¼Œåˆ™æš‚æ—¶å…ˆå ç€å‘ã€‚emptyOneæ ‡è®°çš„ä½ç½®æš‚æ—¶ä¸èƒ½è¢«æ’å…¥æ–°å…ƒç´ (è§3.2ç« èŠ‚æ’å…¥å‡½æ•°)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">bucketCnt</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">overflow</span>(<span style="color:#a6e22e">t</span>) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">overflow</span>(<span style="color:#a6e22e">t</span>).<span style="color:#a6e22e">tophash</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#a6e22e">emptyRest</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">notLast</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">tophash</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">!=</span> <span style="color:#a6e22e">emptyRest</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">notLast</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">for</span> { <span style="color:#75715e">// å¦‚æœb.tophash[i]æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ï¼Œåˆ™æŠŠæœ«å°¾çš„emptyOneå…¨éƒ¨æ¸…é™¤ç½®ä¸ºemptyRest
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">tophash</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#a6e22e">emptyRest</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">bOrig</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#66d9ef">break</span> <span style="color:#75715e">// beginning of initial bucket, we&#39;re done.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// Find previous bucket, continue at its last entry.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">b</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">b</span> = <span style="color:#a6e22e">bOrig</span>; <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">overflow</span>(<span style="color:#a6e22e">t</span>) <span style="color:#f92672">!=</span> <span style="color:#a6e22e">c</span>; <span style="color:#a6e22e">b</span> = <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">overflow</span>(<span style="color:#a6e22e">t</span>) {
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">i</span> = <span style="color:#a6e22e">bucketCnt</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>				} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">i</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">tophash</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">!=</span> <span style="color:#a6e22e">emptyOne</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="34-æŸ¥æ‰¾">3.4 æŸ¥æ‰¾</h2>
<p>æŸ¥æ‰¾æ“ä½œç”±mapaccesså¼€å¤´çš„ä¸€ç»„å‡½æ•°å®ç°ã€‚å‰é¢çš„ç« èŠ‚åœ¨æ’å…¥å’Œåˆ é™¤ä¹‹å‰éƒ½å¾—å…ˆå®šä½æŸ¥æ‰¾åˆ°å…ƒç´ ï¼Œé€»è¾‘æ˜¯ç±»ä¼¼çš„ï¼Œä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±ä¸ç»†è¯´äº†ï¼š</p>
<ul>
<li>mapaccess1()ï¼šé€šè¿‡KeyæŸ¥æ‰¾ï¼Œè¿”å›valueæŒ‡é’ˆï¼Œç”¨äºval := map[key]ã€‚æœªæ‰¾åˆ°æ—¶è¿”å›valueç±»å‹çš„0å€¼ã€‚</li>
<li>mapaccess2()ï¼šé€šè¿‡keyæŸ¥æ‰¾ï¼Œè¿”å›valueæŒ‡é’ˆï¼Œä»¥åŠboolç±»å‹çš„æ˜¯å¦æŸ¥æ‰¾æˆåŠŸçš„æ ‡å¿—ï¼Œç”¨äºval, ok := map[key]ã€‚æœªæ‰¾åˆ°æ—¶è¿”å›valueç±»å‹çš„0å€¼ã€‚</li>
<li>mapaccessK()ï¼šé€šè¿‡keyæŸ¥æ‰¾ï¼Œè¿”å›keyå’ŒvalueæŒ‡é’ˆï¼Œç”¨äºè¿­ä»£å™¨(range)ã€‚æœªæ‰¾åˆ°æ—¶è¿”å›ç©ºæŒ‡é’ˆ</li>
<li>mapaccess1_fat()ï¼Œå¯¹mapaccess1()çš„å°è£…ï¼ŒåŒºåˆ«æ˜¯mapaccess1_fat()å¤šäº†ä¸ªzeroå‚æ•°ï¼Œæœªæ‰¾åˆ°æ—¶è¿”å›zero</li>
<li>mapaccess2_fat()ï¼Œä¹Ÿæ˜¯å¯¹mapaccess1()çš„å°è£…ã€‚ç›¸æ¯”mapaccess1_fat()ï¼Œæœ¬å‡½æ•°å¢åŠ ä¸€ä¸ªæ˜¯å¦æŸ¥æ‰¾æˆåŠŸçš„æ ‡å¿—</li>
</ul>
<h2 id="35-rangeè¿­ä»£">3.5 rangeè¿­ä»£</h2>
<p>mapçš„è¿­ä»£æ˜¯é€šè¿‡hiterç»“æ„å’Œå¯¹åº”çš„ä¸¤ä¸ªè¾…åŠ©å‡½æ•°å®ç°çš„ã€‚hiterç»“æ„ç”±ç¼–è¯‘å™¨åœ¨è°ƒç”¨è¾…åŠ©å‡½æ•°ä¹‹å‰åˆ›å»ºå¹¶ä¼ å…¥ï¼Œæ¯æ¬¡è¿­ä»£ç»“æœä¹Ÿç”±hiterç»“æ„ä¼ å›ã€‚ä¸‹æ–¹çš„itå³æ˜¯hiterç»“æ„ä½“çš„æŒ‡é’ˆå˜é‡ã€‚</p>
<h3 id="351-åˆå§‹åŒ–è¿­ä»£å™¨mapiterinit">3.5.1 åˆå§‹åŒ–è¿­ä»£å™¨mapiterinit()</h3>
<p>mapiterinit()å‡½æ•°ä¸»è¦æ˜¯å†³å®šæˆ‘ä»¬ä»å“ªä¸ªä½ç½®å¼€å§‹è¿­ä»£ï¼Œä¸ºä»€ä¹ˆæ˜¯ä»å“ªä¸ªä½ç½®ï¼Œè€Œä¸æ˜¯ç›´æ¥ä»hashæ•°ç»„å¤´éƒ¨å¼€å§‹å‘¢ï¼Ÿã€Šgoç¨‹åºè®¾è®¡è¯­è¨€ã€‹å¥½åƒæåˆ°è¿‡ï¼Œhashè¡¨ä¸­æ•°æ®æ¯æ¬¡æ’å…¥çš„ä½ç½®æ˜¯å˜åŒ–çš„ï¼ˆå…¶å®æ˜¯å› ä¸ºå®ç°çš„åŸå› ï¼Œä¸€æ–¹é¢hashç§å­æ˜¯éšæœºçš„ï¼Œè¿™å¯¼è‡´ç›¸åŒçš„æ•°æ®åœ¨ä¸åŒçš„mapå˜é‡å†…çš„hashå€¼ä¸åŒï¼›å¦ä¸€æ–¹é¢å³ä½¿åŒä¸€ä¸ªmapå˜é‡å†…ï¼Œæ•°æ®åˆ é™¤å†æ·»åŠ çš„ä½ç½®ä¹Ÿæœ‰å¯èƒ½å˜åŒ–ï¼Œå› ä¸ºåœ¨åŒä¸€ä¸ªæ¡¶åŠæº¢å‡ºé“¾è¡¨ä¸­æ•°æ®çš„ä½ç½®ä¸åˆ†å…ˆåï¼‰ï¼Œæ‰€ä»¥ä¸ºäº†é˜²æ­¢ç”¨æˆ·é”™è¯¯çš„ä¾èµ–äºæ¯æ¬¡è¿­ä»£çš„é¡ºåºï¼Œmapä½œè€…å¹²è„†è®©ç›¸åŒçš„mapæ¯æ¬¡è¿­ä»£çš„é¡ºåºä¹Ÿæ˜¯éšæœºçš„ã€‚
è¿­ä»£é¡ºåºéšæœºçš„å®ç°æ–¹å¼ä¹Ÿç®€å•ï¼Œç›´æ¥ä»éšæœºçš„ä¸€ä¸ªä½ç½®å¼€å§‹å°±è¡Œäº†ï¼š</p>
<ul>
<li>it.startBucketï¼šè¿™ä¸ªæ˜¯hashæ•°ç»„çš„åç§»é‡ï¼Œè¡¨ç¤ºéå†ä»è¿™ä¸ªæ¡¶å¼€å§‹</li>
<li>it.offsetï¼šè¿™ä¸ªæ˜¯æ¡¶å†…çš„åç§»é‡ï¼Œè¡¨ç¤ºæ¯ä¸ªæ¡¶çš„éå†éƒ½ä»è¿™ä¸ªåç§»é‡å¼€å§‹</li>
</ul>
<p>äºæ˜¯ï¼Œmapçš„éå†è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä»hashæ•°ç»„ä¸­ç¬¬it.startBucketä¸ªæ¡¶å¼€å§‹ï¼Œå…ˆéå†hashæ¡¶ï¼Œç„¶åæ˜¯è¿™ä¸ªæ¡¶çš„æº¢å‡ºé“¾è¡¨ã€‚</li>
<li>ä¹‹åhashæ•°ç»„åç§»é‡+1ï¼Œç»§ç»­å‰ä¸€æ­¥åŠ¨ä½œã€‚</li>
<li>éå†æ¯ä¸€ä¸ªæ¡¶ï¼Œæ— è®ºæ˜¯hashæ¡¶è¿˜æ˜¯æº¢å‡ºæ¡¶ï¼Œéƒ½ä»it.offsetåç§»é‡å¼€å§‹ã€‚ï¼ˆå¦‚æœåªæ˜¯éšæœºä¸€ä¸ªå¼€å§‹çš„æ¡¶ï¼Œrangeç»“æœè¿˜æ˜¯æœ‰åºçš„ï¼›ä½†æ¯ä¸ªæ¡¶éƒ½åŠ it.offsetåç§»ï¼Œè¿™ä¸ªè¾“å‡ºç»“æœå°±æœ‰ç‚¹æ‰‘æœ”è¿·ç¦»ï¼Œå¤§å®¶å¯ä»¥äº²æ‰‹è¯•ä¸‹ï¼Œå¯¹åŒä¸€ä¸ªmapå¤šæ¬¡rangeï¼‰</li>
<li>å½“è¿­ä»£å™¨ç»è¿‡ä¸€è½®å¾ªç¯å›åˆ°it.startBucketçš„ä½ç½®ï¼Œç»“æŸéå†ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">mapiterinit</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">maptype</span>, <span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hmap</span>, <span style="color:#a6e22e">it</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hiter</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// éšæœºä¸€ä¸ªåç§»é‡æ¥å¼€å§‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> uintptr(<span style="color:#a6e22e">fastrand</span>())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">B</span> &gt; <span style="color:#ae81ff">31</span><span style="color:#f92672">-</span><span style="color:#a6e22e">bucketCntBits</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">r</span> <span style="color:#f92672">+=</span> uintptr(<span style="color:#a6e22e">fastrand</span>()) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">31</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">it</span>.<span style="color:#a6e22e">startBucket</span> = <span style="color:#a6e22e">r</span> <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">bucketMask</span>(<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">B</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">it</span>.<span style="color:#a6e22e">offset</span> = uint8(<span style="color:#a6e22e">r</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">B</span> <span style="color:#f92672">&amp;</span> (<span style="color:#a6e22e">bucketCnt</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mapiternext</span>(<span style="color:#a6e22e">it</span>) <span style="color:#75715e">// åˆå§‹åŒ–è¿­ä»£å™¨çš„åŒæ—¶ä¹Ÿè¿”å›ç¬¬1å¯¹key/value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h3 id="352-è¿­ä»£è¿‡ç¨‹mapiternext">3.5.2 è¿­ä»£è¿‡ç¨‹mapiternext()</h3>
<p>ä¸Šä¸€èŠ‚è¿­ä»£å¾ªç¯çš„è¿‡ç¨‹å¾ˆæ¸…æ™°äº†ï¼Œè¿™é‡Œæˆ‘ä»¬è¯´æ˜å‡ ä¸ªé‡è¦çš„å‚æ•°ï¼š</p>
<ul>
<li>it.startBucketï¼šå¼€å§‹çš„æ¡¶</li>
<li>it.offsetï¼šæ¯ä¸ªæ¡¶å¼€å§‹çš„åç§»é‡</li>
<li>it.bptrï¼šå½“å‰éå†çš„æ¡¶</li>
<li>it.iï¼šit.bptrå·²ç»éå†çš„é”®å€¼å¯¹æ•°é‡ï¼Œiåˆå§‹ä¸º0ï¼Œå½“i=8æ—¶è¡¨ç¤ºè¿™ä¸ªæ¡¶éå†å®Œäº†ï¼Œå°†it.bptrç§»å‘ä¸‹ä¸€ä¸ªæ¡¶</li>
<li>it.keyï¼šæ¯æ¬¡è¿­ä»£çš„ç»“æœ</li>
<li>it.valueï¼šæ¯æ¬¡è¿­ä»£çš„ç»“æœ</li>
</ul>
<p>æ­¤å¤–ï¼Œè¿­ä»£è¿˜éœ€è¦å…³æ³¨æ‰©å®¹ç¼©å®¹çš„æƒ…å†µï¼š</p>
<ul>
<li>å¦‚æœæ˜¯åœ¨è¿­ä»£å¼€å§‹åæ‰growingï¼Œè¿™ç§æƒ…å†µå½“å‰çš„é€»è¾‘æ²¡å¤„ç†ï¼Œè¿­ä»£æœ‰å¯èƒ½å¼‚å¸¸ã€‚å‘ƒï¼Œgo mapä¸æ”¯æŒå¹¶å‘ã€‚</li>
<li>å¦‚æœæ˜¯å…ˆgrowingï¼Œå†å¼€å§‹è¿­ä»£ï¼Œè¿™æ˜¯æœ‰å¯èƒ½çš„ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œä¼šå…ˆåˆ°æ—§hashè¡¨ä¸­æ£€æŸ¥keyå¯¹åº”çš„æ¡¶æœ‰æ²¡æœ‰è¢«ç–æ•£ï¼Œæœªç–æ•£åˆ™éå†æ—§æ¡¶ï¼Œå·²ç–æ•£åˆ™éå†æ–°hashè¡¨é‡Œå¯¹åº”çš„æ¡¶ã€‚</li>
</ul>
<h1 id="4-go-mapçš„æ‰©å®¹ç¼©å®¹">4. go mapçš„æ‰©å®¹ç¼©å®¹</h1>
<h2 id="41-æ‰©å®¹ç¼©å®¹çš„åŸºæœ¬åŸç†">4.1 æ‰©å®¹ç¼©å®¹çš„åŸºæœ¬åŸç†</h2>
<p>go mapçš„æ‰©å®¹ç¼©å®¹éƒ½æ˜¯growç›¸å…³çš„å‡½æ•°ï¼Œè¿™é‡Œæ‰©å®¹æ˜¯çœŸçš„ï¼Œç¼©å®¹æ˜¯ä¼ªç¼©å®¹ï¼Œåé¢æˆ‘ä¼šè§£é‡Šã€‚æˆ‘ä»¬å…ˆçœ‹ä¸‹è§¦å‘æ¡ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">mapassign</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">maptype</span>, <span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hmap</span>, <span style="color:#a6e22e">key</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>) <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">growing</span>() <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">overLoadFactor</span>(<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">count</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">B</span>) <span style="color:#f92672">||</span> <span style="color:#a6e22e">tooManyOverflowBuckets</span>(<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">noverflow</span>, <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">B</span>)) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">hashGrow</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">h</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">again</span> <span style="color:#75715e">// Growing the table invalidates everything, so try again
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// overLoadFactor()è¿”å›trueåˆ™è§¦å‘æ‰©å®¹ï¼Œå³mapçš„countå¤§äºhashæ¡¶æ•°é‡(2^B)*6.5
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">overLoadFactor</span>(<span style="color:#a6e22e">count</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">B</span> <span style="color:#66d9ef">uint8</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">count</span> &gt; <span style="color:#a6e22e">bucketCnt</span> <span style="color:#f92672">&amp;&amp;</span> uintptr(<span style="color:#a6e22e">count</span>) &gt; <span style="color:#a6e22e">loadFactorNum</span><span style="color:#f92672">*</span>(<span style="color:#a6e22e">bucketShift</span>(<span style="color:#a6e22e">B</span>)<span style="color:#f92672">/</span><span style="color:#a6e22e">loadFactorDen</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// tooManyOverflowBuckets()ï¼Œé¡¾åæ€ä¹‰ï¼Œæº¢å‡ºæ¡¶å¤ªå¤šäº†è§¦å‘ç¼©å®¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">tooManyOverflowBuckets</span>(<span style="color:#a6e22e">noverflow</span> <span style="color:#66d9ef">uint16</span>, <span style="color:#a6e22e">B</span> <span style="color:#66d9ef">uint8</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">B</span> &gt; <span style="color:#ae81ff">15</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">B</span> = <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">noverflow</span> <span style="color:#f92672">&gt;=</span> uint16(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">&lt;&lt;</span>(<span style="color:#a6e22e">B</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">15</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>mapåªåœ¨æ’å…¥å…ƒç´ å³mapassign()å‡½æ•°ä¸­å¯¹æ˜¯å¦æ‰©å®¹ç¼©å®¹è¿›è¡Œè§¦å‘ï¼Œæ¡ä»¶å³æ˜¯ä¸Šé¢è¿™æ®µä»£ç ï¼š</p>
<ul>
<li>æ¡ä»¶1ï¼šå½“å‰ä¸å¤„åœ¨growingçŠ¶æ€</li>
<li>æ¡ä»¶2-1ï¼šè§¦å‘æ‰©å®¹ï¼šmapçš„æ•°æ®é‡countå¤§äºhashæ¡¶æ•°é‡(2B)*6.5ã€‚æ³¨æ„è¿™é‡Œçš„(2B)åªæ˜¯hashæ•°ç»„å¤§å°ï¼Œä¸åŒ…æ‹¬æº¢å‡ºçš„æ¡¶</li>
<li>æ¡ä»¶2-2ï¼šè§¦å‘ç¼©å®¹ï¼šæº¢å‡ºçš„æ¡¶æ•°é‡noverflow&gt;=32768(1&laquo;15)æˆ–è€…&gt;=hashæ•°ç»„å¤§å°ã€‚</li>
</ul>
<p>ä»”ç»†è§‚å¯Ÿè§¦å‘çš„ä»£ç ï¼Œæ‰©å®¹å’Œç¼©å®¹æ˜¯åŒä¸€ä¸ªå‡½æ•°ï¼Œè¿™æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿåœ¨hashGrow()å¼€å§‹ï¼Œä¼šå…ˆåˆ¤æ–­æ˜¯å¦æ»¡è¶³æ‰©å®¹æ¡ä»¶ï¼Œå¦‚æœæ»¡è¶³å°±è¡¨æ˜è¿™æ¬¡æ˜¯æ‰©å®¹ï¼Œä¸æ»¡è¶³å°±ä¸€å®šæ˜¯ç¼©å®¹æ¡ä»¶è§¦å‘äº†ã€‚æ‰©å®¹å’Œç¼©å®¹å‰©ä¸‹çš„é€»è¾‘ï¼Œä¸»è¦åŒºåˆ«å°±åœ¨äºå®¹é‡å˜åŒ–ï¼Œå°±æ˜¯hmap.Bå‚æ•°ï¼Œæ‰©å®¹æ—¶B+1åˆ™hashè¡¨å®¹é‡æ‰©å¤§1å€ï¼Œç¼©å®¹æ—¶hashè¡¨å®¹é‡ä¸å˜ã€‚</p>
<ul>
<li>h.oldbucketsï¼šæŒ‡å‘æ—§çš„hashæ•°ç»„ï¼Œå³å½“å‰çš„h.buckets</li>
<li>h.bucketsï¼šæŒ‡å‘æ–°åˆ›å»ºçš„hashæ•°ç»„</li>
</ul>
<p>åˆ°è¿™é‡Œè§¦å‘çš„ä¸»è¦å·¥ä½œå·²ç»å®Œæˆï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ€ä¹ˆæŠŠå…ƒç´ æ¬è¿åˆ°æ–°hashè¡¨é‡Œäº†ã€‚å¦‚æœç°åœ¨å°±ä¸€æ¬¡å…¨é‡æ¬è¿è¿‡å»ï¼Œæ˜¾ç„¶æ¥ä¸‹æ¥ä¼šæœ‰æ¯”è¾ƒé•¿çš„ä¸€æ®µæ—¶é—´mapè¢«å ç”¨ï¼ˆä¸æ”¯æŒå¹¶å‘ï¼‰ã€‚æ‰€ä»¥æ¬è¿çš„å·¥ä½œæ˜¯å¼‚æ­¥å¢é‡æ¬è¿çš„ã€‚
åœ¨æ’å…¥å’Œåˆ é™¤çš„å‡½æ•°å†…éƒ½æœ‰ä¸‹é¢ä¸€æ®µä»£ç ç”¨äºåœ¨æ¯æ¬¡æ’å…¥å’Œåˆ é™¤æ“ä½œæ—¶ï¼Œæ‰§è¡Œä¸€æ¬¡æ¬è¿å·¥ä½œï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">growing</span>() { <span style="color:#75715e">// å½“å‰å¤„äºæ¬è¿çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">growWork</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">h</span>, <span style="color:#a6e22e">bucket</span>) <span style="color:#75715e">// è°ƒç”¨æ¬è¿å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">growWork</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">maptype</span>, <span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hmap</span>, <span style="color:#a6e22e">bucket</span> <span style="color:#66d9ef">uintptr</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å°†å½“å‰éœ€è¦å¤„ç†çš„æ¡¶æ¬è¿
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">evacuate</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">h</span>, <span style="color:#a6e22e">bucket</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">oldbucketmask</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">growing</span>() { <span style="color:#75715e">// å†å¤šæ¬è¿ä¸€ä¸ªæ¡¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">evacuate</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">h</span>, <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">nevacuate</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>æ¯æ‰§è¡Œä¸€æ¬¡æ’å…¥æˆ–åˆ é™¤ï¼Œéƒ½ä¼šè°ƒç”¨growWorkæ¬è¿0~2ä¸ªhashæ¡¶ï¼ˆæœ‰å¯èƒ½è¿™æ¬¡éœ€è¦æ¬è¿çš„2ä¸ªæ¡¶åœ¨æ­¤ä¹‹å‰éƒ½è¢«æ¬è¿‡äº†ï¼‰</li>
<li>æ¬è¿æ˜¯ä»¥hashæ¡¶ä¸ºå•ä½çš„ï¼ŒåŒ…å«å¯¹åº”çš„hashæ¡¶å’Œè¿™ä¸ªæ¡¶çš„æº¢å‡ºé“¾è¡¨</li>
<li>è¢«deleteæ‰çš„å…ƒç´ (emptyoneæ ‡å¿—)ä¼šè¢«èˆå¼ƒï¼ˆè¿™æ˜¯ç¼©å®¹çš„å…³é”®ï¼‰</li>
</ul>
<h2 id="42-ä¸ºä»€ä¹ˆå«ä¼ªç¼©å®¹å¦‚ä½•å®ç°çœŸç¼©å®¹">4.2 ä¸ºä»€ä¹ˆå«â€œä¼ªç¼©å®¹â€ï¼Ÿå¦‚ä½•å®ç°â€œçœŸç¼©å®¹â€ï¼Ÿ</h2>
<p>ç°åœ¨å¯ä»¥è§£é‡Šä¸ºä»€ä¹ˆæˆ‘æŠŠmapçš„ç¼©å®¹å«åšä¼ªç¼©å®¹äº†ï¼šå› ä¸ºç¼©å®¹ä»…ä»…é’ˆå¯¹æº¢å‡ºæ¡¶å¤ªå¤šçš„æƒ…å†µï¼Œè§¦å‘ç¼©å®¹æ—¶hashæ•°ç»„çš„å¤§å°ä¸å˜ï¼Œå³hashæ•°ç»„æ‰€å ç”¨çš„ç©ºé—´åªå¢ä¸å‡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬æŠŠä¸€ä¸ªå·²ç»å¢é•¿åˆ°å¾ˆå¤§çš„mapçš„å…ƒç´ æŒ¨ä¸ªå…¨éƒ¨åˆ é™¤æ‰ï¼Œhashè¡¨æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ã€‚</p>
<p>æ‰€ä»¥å¦‚æœè¦å®ç°â€œçœŸç¼©å®¹â€ï¼Œéœ€è‡ªå·±å®ç°ç¼©å®¹æ¬è¿ï¼Œå³åˆ›å»ºä¸€ä¸ªè¾ƒå°çš„mapï¼Œå°†éœ€è¦ç¼©å®¹çš„mapçš„å…ƒç´ æŒ¨ä¸ªæ¬è¿è¿‡æ¥ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// go mapç¼©å®¹ä»£ç ç¤ºä¾‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">myMap</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">1000000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å‡è®¾è¿™é‡Œæˆ‘ä»¬å¯¹bigMapåšäº†å¾ˆå¤šæ¬¡æ’å…¥ï¼Œä¹‹ååˆåšäº†å¾ˆå¤šæ¬¡åˆ é™¤ï¼Œæ­¤æ—¶bigMapçš„å…ƒç´ æ•°é‡è¿œå°äºhashè¡¨å¤§å°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹ç¼©å®¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">smallMap</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#66d9ef">int</span>, len(<span style="color:#a6e22e">myMap</span>))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">myMap</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">smallMap</span>[<span style="color:#a6e22e">k</span>] = <span style="color:#a6e22e">v</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">myMap</span> = <span style="color:#a6e22e">smallMap</span> <span style="color:#75715e">// ç¼©å®¹å®Œæˆï¼ŒåŸæ¥çš„mapè¢«æˆ‘ä»¬ä¸¢å¼ƒï¼Œäº¤ç»™gcå»æ¸…ç†
</span></span></span></code></pre></div><h1 id="5-qaå…³é”®çŸ¥è¯†ç‚¹">5 Q&amp;Aå…³é”®çŸ¥è¯†ç‚¹</h1>
<h2 id="51-åŸºæœ¬åŸç†">5.1 åŸºæœ¬åŸç†</h2>
<ul>
<li>åº•å±‚æ˜¯hashå®ç°ï¼Œæ•°æ®ç»“æ„ä¸ºhashæ•°ç»„ + æ¡¶ + æº¢å‡ºçš„æ¡¶é“¾è¡¨ï¼Œæ¯ä¸ªæ¡¶å­˜å‚¨æœ€å¤š8ä¸ªkey-valueå¯¹</li>
<li>æŸ¥æ‰¾å’Œæ’å…¥çš„åŸç†ï¼škeyçš„hashå€¼ï¼ˆä½é˜¶ä½ï¼‰ä¸æ¡¶æ•°é‡ç›¸ä¸ï¼Œå¾—åˆ°keyæ‰€åœ¨çš„hashæ¡¶ï¼Œå†ç”¨keyçš„é«˜8ä½ä¸æ¡¶ä¸­çš„tophash[i]å¯¹æ¯”ï¼Œç›¸åŒåˆ™è¿›ä¸€æ­¥å¯¹æ¯”keyå€¼ï¼Œkeyå€¼ç›¸ç­‰åˆ™æ‰¾åˆ°</li>
<li>go mapä¸æ”¯æŒå¹¶å‘ã€‚æ’å…¥ã€åˆ é™¤ã€æ¬è¿ç­‰æ“ä½œä¼šç½®writingæ ‡å¿—ï¼Œæ£€æµ‹åˆ°å¹¶å‘ç›´æ¥panic</li>
<li>æ¯æ¬¡æ‰©å®¹hashè¡¨å¢å¤§1å€ï¼Œhashè¡¨åªå¢ä¸å‡</li>
<li>æ”¯æŒæœ‰é™ç¼©å®¹ï¼Œdeleteæ“ä½œåªç½®åˆ é™¤æ ‡å¿—ä½ï¼Œé‡Šæ”¾æº¢å‡ºæ¡¶çš„ç©ºé—´ä¾é è§¦å‘ç¼©å®¹æ¥å®ç°ã€‚</li>
<li>mapåœ¨ä½¿ç”¨å‰å¿…é¡»åˆå§‹åŒ–ï¼Œå¦åˆ™panicï¼šå·²åˆå§‹åŒ–çš„mapæ˜¯make(map[key]value)æˆ–make(map[key]value, hint)è¿™ä¸¤ç§å½¢å¼ã€‚è€Œnewæˆ–var xxx map[key]valueè¿™ä¸¤ç§å½¢å¼æ˜¯æœªåˆå§‹åŒ–çš„ï¼Œç›´æ¥ä½¿ç”¨ä¼španicã€‚</li>
</ul>
<h2 id="52-æ—¶é—´å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦åˆ†æ">5.2 æ—¶é—´å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦åˆ†æ</h2>
<p>æ—¶é—´å¤æ‚åº¦ï¼Œgo mapæ˜¯hashå®ç°ï¼Œæˆ‘ä»¬å…ˆä¸ç®¡å…·ä½“åŸç†ï¼Œæ±Ÿæ¹–å¥—è·¯hashå®ç°çš„å°±å«å®ƒO(1)çš„æ—¶é—´å¤æ‚åº¦ï¼š</p>
<ul>
<li>æ­£å¸¸æƒ…å†µï¼Œä¸”ä¸è€ƒè™‘æ‰©å®¹çŠ¶æ€ï¼Œå¤æ‚åº¦O(1)ï¼šé€šè¿‡hashå€¼å®šä½æ¡¶æ˜¯O(1)ï¼Œä¸€ä¸ªæ¡¶æœ€å¤š8ä¸ªå…ƒç´ ï¼Œåˆç†çš„hashç®—æ³•åº”è¯¥èƒ½æŠŠå…ƒç´ ç›¸å¯¹å‡åŒ€æ•£åˆ—ï¼Œæ‰€ä»¥æº¢å‡ºé“¾è¡¨ï¼ˆå¦‚æœæœ‰ï¼‰ä¹Ÿä¸ä¼šå¤ªé•¿ï¼Œæ‰€ä»¥è™½ç„¶åœ¨æ¡¶å’Œæº¢å‡ºé“¾è¡¨ä¸Šå®šä½keyæ˜¯éå†ï¼Œè€ƒè™‘åˆ°æ•°é‡å°ä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯O(1)</li>
<li>æ­£å¸¸æƒ…å†µï¼Œå¤„äºæ‰©å®¹çŠ¶æ€æ—¶ï¼Œå¤æ‚åº¦ä¹Ÿæ˜¯O(1)ï¼šç›¸æ¯”äºä¸Šä¸€ç§çŠ¶æ€ï¼Œæ‰©å®¹ä¼šå¢åŠ æ¬è¿æœ€å¤š2ä¸ªæ¡¶å’Œæº¢å‡ºé“¾è¡¨çš„æ—¶é—´æ¶ˆè€—ï¼Œå½“æº¢å‡ºé“¾è¡¨ä¸å¤ªé•¿æ—¶ï¼Œå¤æ‚åº¦ä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯O(1)</li>
<li>æç«¯æƒ…å†µï¼Œæ•£åˆ—æä¸å‡åŒ€ï¼Œå¤§éƒ¨åˆ†æ•°æ®è¢«é›†ä¸­åœ¨ä¸€æ¡æ•£åˆ—é“¾è¡¨ä¸Šï¼Œå¤æ‚åº¦é€€åŒ–ä¸ºO(n)ã€‚</li>
</ul>
<p>goé‡‡ç”¨çš„hashç®—æ³•åº”æ˜¯å¾ˆæˆç†Ÿçš„ç®—æ³•ï¼Œæç«¯æƒ…å†µæš‚ä¸è€ƒè™‘ã€‚æ‰€ä»¥ç»¼åˆæƒ…å†µä¸‹go mapçš„æ—¶é—´å¤æ‚åº¦åº”ä¸ºO(1)</p>
<p>ç©ºé—´å¤æ‚åº¦åˆ†æï¼š
é¦–å…ˆæˆ‘ä»¬ä¸è€ƒè™‘å› åˆ é™¤å¤§é‡å…ƒç´ å¯¼è‡´çš„ç©ºé—´æµªè´¹æƒ…å†µï¼ˆè¿™ç§æƒ…å†µç°åœ¨goæ˜¯ç•™ç»™ç¨‹åºå‘˜è‡ªå·±è§£å†³ï¼‰ï¼Œåªè€ƒè™‘ä¸€ä¸ªæŒç»­å¢é•¿çŠ¶æ€çš„mapçš„ä¸€ä¸ªç©ºé—´ä½¿ç”¨ç‡ï¼š
ç”±äºæº¢å‡ºæ¡¶æ•°é‡è¶…è¿‡hashæ¡¶æ•°é‡æ—¶ä¼šè§¦å‘ç¼©å®¹ï¼Œæ‰€ä»¥æœ€åçš„æƒ…å†µæ˜¯æ•°æ®è¢«é›†ä¸­åœ¨ä¸€æ¡é“¾ä¸Šï¼Œhashè¡¨åŸºæœ¬æ˜¯ç©ºçš„ï¼Œè¿™æ—¶ç©ºé—´æµªè´¹O(n)ã€‚
æœ€å¥½çš„æƒ…å†µä¸‹ï¼Œæ•°æ®å‡åŒ€æ•£åˆ—åœ¨hashè¡¨ä¸Šï¼Œæ²¡æœ‰å…ƒç´ æº¢å‡ºï¼Œè¿™æ—¶æœ€å¥½çš„ç©ºé—´å¤æ‚åº¦å°±æ˜¯æ‰©æ•£å› å­å†³å®šäº†ï¼Œå½“å‰goçš„æ‰©æ•£å› å­ç”±å…¨å±€å˜é‡å†³å®šï¼Œå³loadFactorNum/loadFactorDen = 6.5ã€‚å³å¹³å‡æ¯ä¸ªhashæ¡¶è¢«åˆ†é…åˆ°6.5ä¸ªå…ƒç´ ä»¥ä¸Šæ—¶ï¼Œå¼€å§‹æ‰©å®¹ã€‚æ‰€ä»¥æœ€å°çš„ç©ºé—´æµªè´¹æ˜¯(8-6.5)/8 = 0.1875ï¼Œå³O(0.1875n)</p>
<p>ç»“è®ºï¼šgo mapçš„ç©ºé—´å¤æ‚åº¦ï¼ˆæŒ‡é™¤å»æ­£å¸¸å­˜å‚¨å…ƒç´ æ‰€éœ€ç©ºé—´ä¹‹å¤–çš„ç©ºé—´æµªè´¹ï¼‰æ˜¯O(0.1875n) ~ O(n)ä¹‹é—´ã€‚</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/go/">go</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/a59515fd/">
        
        

        <div class="article-details">
            <h2 class="article-title">ã€è¯‘ã€‘ä½¿ç”¨ gosec æ£€æŸ¥ Go ä»£ç ä¸­çš„å®‰å…¨é—®é¢˜</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/8c9efcce/">
        
        

        <div class="article-details">
            <h2 class="article-title">æµé‡å¤åˆ¶é‡æ”¾å·¥å…·goreplay</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/ace0b2ab/">
        
        

        <div class="article-details">
            <h2 class="article-title">ã€è¯‘ã€‘Go 1.14 ä¸­æ¥å£çš„è±å½¢ç»„åˆ</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/27d7ea27/">
        
        

        <div class="article-details">
            <h2 class="article-title">ã€è¯‘ã€‘é€šè¿‡ç¦æ­¢æ¯”è¾ƒè®© Go äºŒè¿›åˆ¶æ–‡ä»¶å˜å°</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/5698ca18/">
        
        

        <div class="article-details">
            <h2 class="article-title">ã€è¯‘ã€‘Goï¼šå¼‚æ­¥æŠ¢å </h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2023 Xiaobin&#39;s Blog
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
