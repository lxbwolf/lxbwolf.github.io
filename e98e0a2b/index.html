<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='redisçš„zsetå’Œsetéƒ½ä½¿ç”¨è·³è¡¨å®ç°ã€‚è·³è¡¨ç®€å•åœ°è¯´ï¼Œå°±æ˜¯åœ¨é“¾è¡¨ä¸Šæ„é€ å¤šçº§ç´¢å¼•ï¼Œä»¥åŠ é€ŸæŸ¥æ‰¾ï¼Œæ˜¯ç”¨ç©ºé—´æ¢æ—¶é—´ã€‚å®ƒæ¯”çº¢é»‘æ ‘å®ç°æ›´ç®€å•ï¼Œä¸éœ€è¦'>
<title>redis è·³è¡¨åˆ†æå¹¶ç”¨ Go å®ç°</title>

<link rel='canonical' href='https://lxb.wiki/e98e0a2b/'>

<link rel="stylesheet" href="/scss/style.min.bc5bb6e306c354a2f5d5bfd1e65a5f3996962fb9b4a3546b748aee7daee4f258.css"><meta property='og:title' content='redis è·³è¡¨åˆ†æå¹¶ç”¨ Go å®ç°'>
<meta property='og:description' content='redisçš„zsetå’Œsetéƒ½ä½¿ç”¨è·³è¡¨å®ç°ã€‚è·³è¡¨ç®€å•åœ°è¯´ï¼Œå°±æ˜¯åœ¨é“¾è¡¨ä¸Šæ„é€ å¤šçº§ç´¢å¼•ï¼Œä»¥åŠ é€ŸæŸ¥æ‰¾ï¼Œæ˜¯ç”¨ç©ºé—´æ¢æ—¶é—´ã€‚å®ƒæ¯”çº¢é»‘æ ‘å®ç°æ›´ç®€å•ï¼Œä¸éœ€è¦'>
<meta property='og:url' content='https://lxb.wiki/e98e0a2b/'>
<meta property='og:site_name' content='Xiaobin&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='redis' /><meta property='article:published_time' content='2021-03-03T23:09:59&#43;00:00'/><meta property='article:modified_time' content='2021-03-03T23:09:59&#43;00:00'/>
<meta name="twitter:title" content="redis è·³è¡¨åˆ†æå¹¶ç”¨ Go å®ç°">
<meta name="twitter:description" content="redisçš„zsetå’Œsetéƒ½ä½¿ç”¨è·³è¡¨å®ç°ã€‚è·³è¡¨ç®€å•åœ°è¯´ï¼Œå°±æ˜¯åœ¨é“¾è¡¨ä¸Šæ„é€ å¤šçº§ç´¢å¼•ï¼Œä»¥åŠ é€ŸæŸ¥æ‰¾ï¼Œæ˜¯ç”¨ç©ºé—´æ¢æ—¶é—´ã€‚å®ƒæ¯”çº¢é»‘æ ‘å®ç°æ›´ç®€å•ï¼Œä¸éœ€è¦">
<link rel="shortcut icon" href="/favicon.png" />

<script data-ad-client="ca-pub-5708899526501350" async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-JZ2PWLT6JY"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-JZ2PWLT6JY');
</script>
<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?e710560ffa44cae2b3a6259e0171fb5f";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu692828361b78eaa42fdbdbbf5a7177a9_44446_300x0_resize_q75_box.jpeg" width="300"
                            height="298" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Xiaobin&#39;s Blog</a></h1>
            <h2 class="site-description"></h2>
        </div>
    </header>


    <ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                <span>é¦–é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/categories/' >
                
                
                
                <span>åˆ†ç±»</span>
            </a>
        </li>
        
        
        <li >
            <a href='/tags/' >
                
                
                
                <span>æ ‡ç­¾</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                <span>å‹é“¾</span>
            </a>
        </li>
        

        <div class="menu-bottom-section"><ol class="social-menu">
                    
                        <li>
                            <a 
                                href='mailto://me@liuxb.email'
                                target="_blank"
                                title="Email"
                                rel="me"
                            >
                                
                                
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                                
                            </a>
                        </li>
                    
                        <li>
                            <a 
                                href='https://github.com/lxbwolf'
                                target="_blank"
                                title="GitHub"
                                rel="me"
                            >
                                
                                
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                                
                            </a>
                        </li>
                    
                </ol>
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>æš—è‰²æ¨¡å¼</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
<section class="widget archives">
    
    <h2 class="widget-title section-title">ç›®å½•</h2>

    <div class="widget--toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#1--è·³è¡¨ç»“æ„">1.  è·³è¡¨ç»“æ„</a></li>
    <li><a href="#2--èŠ‚ç‚¹çš„æ’å…¥">2.  èŠ‚ç‚¹çš„æ’å…¥</a>
      <ul>
        <li><a href="#21--æŸ¥æ‰¾æ¯”s25å°çš„æœ€å¤§èŠ‚ç‚¹">2.1.  æŸ¥æ‰¾æ¯”s2.5å°çš„æœ€å¤§èŠ‚ç‚¹</a></li>
        <li><a href="#22--æ’å…¥èŠ‚ç‚¹s25">2.2.  æ’å…¥èŠ‚ç‚¹s2.5</a></li>
      </ul>
    </li>
    <li><a href="#3--åˆ é™¤èŠ‚ç‚¹">3.  åˆ é™¤èŠ‚ç‚¹</a>
      <ul>
        <li><a href="#32--æŸ¥æ‰¾æ¯”s3å°çš„æœ€å¤§èŠ‚ç‚¹">3.2.  æŸ¥æ‰¾æ¯”s3å°çš„æœ€å¤§èŠ‚ç‚¹</a></li>
        <li><a href="#23--åˆ é™¤èŠ‚ç‚¹">2.3.  åˆ é™¤èŠ‚ç‚¹</a></li>
      </ul>
    </li>
    <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
  </ul>
</nav>
    </div>
</section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
        <a href="/categories/DB/" >
            DB
        </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/e98e0a2b/">redis è·³è¡¨åˆ†æå¹¶ç”¨ Go å®ç°</a>
        </h2>

        
    </div>

    
    
    
    
    <footer class="article-time">
        
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
            <time class="article-time--published">Mar 03, 2021</time>
        </div>
        

        
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



            <time class="article-time--reading">
                é˜…è¯»æ—¶é•¿: 8 åˆ†é’Ÿ
            </time>
        </div>
        
        <small>
    <section class="article-tags">
        
            <a href="/tags/redis/">redis</a>
        
    </section>
</small>
    </footer>
    

    
</div>
</header>

    <section class="article-content">
    
    
    <!-- raw HTML omitted -->
<p>redisçš„zsetå’Œsetéƒ½ä½¿ç”¨è·³è¡¨å®ç°ã€‚è·³è¡¨ç®€å•åœ°è¯´ï¼Œå°±æ˜¯åœ¨é“¾è¡¨ä¸Šæ„é€ å¤šçº§ç´¢å¼•ï¼Œä»¥åŠ é€ŸæŸ¥æ‰¾ï¼Œæ˜¯ç”¨ç©ºé—´æ¢æ—¶é—´ã€‚å®ƒæ¯”çº¢é»‘æ ‘å®ç°æ›´ç®€å•ï¼Œä¸éœ€è¦è€—è´¹å¤§é‡çš„ç²¾åŠ›ç»´æŠ¤æ ‘çš„å¹³è¡¡ã€‚è·³è¡¨çš„å„ä¸ªèŠ‚ç‚¹æ˜¯æœ‰é¡ºåºçš„ï¼Œå¯ä»¥è¿›è¡ŒèŒƒå›´æŸ¥è¯¢ã€‚</p>
<p>æœ¬æ–‡å°†åˆ†æè·³è¡¨çš„æ„æˆã€æ’å…¥ã€åˆ é™¤ç­‰æ“ä½œï¼Œå¹¶ä½¿ç”¨goå®ç°ã€‚</p>
<h2 id="1--è·³è¡¨ç»“æ„">1.  è·³è¡¨ç»“æ„</h2>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20210503231105.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>ä¸Šå›¾å°±æ˜¯ä¸€ä¸ªåŒ…å«5ä¸ªèŠ‚ç‚¹çš„è·³è¡¨ç»“æ„ã€‚è·³è¡¨çš„ç»“æ„åŒ…å«ä¸€ä¸ªåˆä¸€ä¸ªçš„èŠ‚ç‚¹ï¼Œå’ŒheaderèŠ‚ç‚¹ã€‚headerèŠ‚ç‚¹æ˜¯æŸ¥è¯¢çš„èµ·å§‹ç‚¹ã€‚è·³è¡¨å®šä¹‰å¦‚ä¸‹ï¼ŒåŒ…å«å¤´ç»“ç‚¹ã€å°¾èŠ‚ç‚¹ã€é•¿åº¦ä»¥åŠè·³è¡¨çš„ç´¢å¼•å±‚æ•°ã€‚</p>
<pre tabindex="0"><code>
// skiplist æŒæœ‰ä¸€ä¸ªè·³è¡¨çš„å®Œæ•´æ•°æ®
type skiplist struct {
  // headerå’Œtailè¡¨ç¤ºè·³è¡¨çš„å¤´ç»“ç‚¹å’Œå°¾èŠ‚ç‚¹
  header, tail *skiplistNode
  // length è¡¨ç¤ºè·³è¡¨çš„é•¿åº¦
  length int
  // level è¡¨ç¤ºè¯¥è·³è¡¨ç´¢å¼•çš„å±‚æ•°
  level int
}
</code></pre><p>ä»ä¸Šé¢è·³è¡¨çš„å®šä¹‰çœ‹ä¸å‡ºä»€ä¹ˆï¼Œè·³è¡¨æ¯ä¸ªèŠ‚ç‚¹çš„å®šä¹‰å°±æœ‰å¾ˆå¤šä¸œè¥¿äº†ã€‚</p>
<pre tabindex="0"><code>
// skiplistLevel è¡¨ç¤ºskiplistæ¯ä¸€èŠ‚ç‚¹åœ¨æ¯ä¸€å±‚æŒæœ‰çš„æ•°æ®ç»“æ„
type skiplistLevel struct {
  // è¯¥å±‚èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œredisä½¿ç”¨forward
  next *skiplistNode
  // è¯¥å±‚èŠ‚ç‚¹åˆ°ä¸‹ä¸€èŠ‚ç‚¹ä¸­é—´é—´éš”çš„è·³æ•°
  span int
}
// skiplistNode è¡¨ç¤ºskiplistçš„æ¯ä¸€ä¸ªèŠ‚ç‚¹
type skiplistNode struct {
  // robj ä»£è¡¨è¯¥èŠ‚ç‚¹çš„æ•°æ®
  robj interface{}
  // score è¡¨ç¤ºè¯¥èŠ‚ç‚¹çš„åˆ†æ•°ï¼Œä»¥ä¾¿æ’åº
  score float64
  // prev è¡¨ç¤ºè¯¥èŠ‚ç‚¹çš„ä¸Šä¸€èŠ‚ç‚¹ï¼Œredis ä¸­ä½¿ç”¨backward
  prev *skiplistNode
  // levels è¡¨ç¤ºè¯¥èŠ‚ç‚¹åœ¨æ¯ä¸€å±‚ç´¢å¼•ä¸­åˆ°ä¸‹ä¸€èŠ‚ç‚¹çš„ä¿¡æ¯
  levels []skiplistLevel
}
</code></pre><p>æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸­æŒæœ‰æ•°æ®robjã€è¯¥æ•°æ®çš„åˆ†æ•°scoreç”¨æ¥æ’åºã€ä¸Šä¸€èŠ‚ç‚¹çš„æŒ‡é’ˆprevä»¥ä¾¿äºåå‘éå†ã€å„å±‚ç´¢å¼•ä¿¡æ¯levelsã€‚æ¯ä¸€å±‚çš„ç´¢å¼•ä¿¡æ¯skiplistlevelåŒ…æ‹¬è¯¥å±‚ç´¢å¼•ä¸­è¯¥èŠ‚ç‚¹æŒ‡å‘çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆnextã€è¯¥èŠ‚ç‚¹åˆ°ä¸‹ä¸€èŠ‚ç‚¹çš„é—´éš”spanã€‚ä¾‹å¦‚ä¸Šå›¾ä¸­ï¼ŒèŠ‚ç‚¹s2åœ¨ç¬¬ä¸‰å±‚ç´¢å¼•çš„ä¸‹ä¸€èŠ‚ç‚¹æ˜¯s4ï¼Œè€Œåœ¨ç¬¬äºŒå±‚ç´¢å¼•çš„ä¸‹ä¸€èŠ‚ç‚¹æ˜¯s3ï¼Œè€Œä¸”é—´éš”spanåˆ†åˆ«æ˜¯2å’Œ1ã€‚</p>
<p>æ¯ä¸ªèŠ‚ç‚¹çš„ç´¢å¼•å±‚æ•°é€šè¿‡éšæœºæ•°ç”Ÿæˆï¼Œredisè®¾è®¡çš„æ€è·¯ï¼šä½¿ç”¨ç¬¬nçº§ç´¢å¼•æ˜¯ä½¿ç”¨ç¬¬n-1çº§ç´¢å¼•æ¦‚ç‡çš„1/4ï¼Œæœ€å¤šä½¿ç”¨32çº§ç´¢å¼•ï¼Œå¦‚æœçœŸç”¨åˆ°äº†32çº§ç´¢å¼•ï¼Œè¿™ä¸ªè·³è¡¨æ‰€æŒæœ‰çš„æ•°æ®ä¹Ÿæ˜¯å·¨å¤§çš„ï¼Œå› æ­¤ä¸ç”¨æ‹…å¿ƒç´¢å¼•ä¸å¤Ÿç”¨ã€‚</p>
<pre tabindex="0"><code>
func randomLevel() int {
 var level = 1
   // SKIPLIST_P = 0.25
 for rand.Float64() &lt; SKIPLIST_P {
   level ++
 }
 if level &lt; SKIPLIST_MAXLEVEL {
   return level
 }
 return SKIPLIST_MAXLEVEL
}
</code></pre><p>è·³è¡¨æŒ‰ç…§scoreå’Œrobjä»å°åˆ°å¤§è¿›è¡Œæ’åºï¼Œå› æ­¤å®ƒçš„å„ä¸ªèŠ‚ç‚¹æ˜¯æœ‰åºçš„ï¼Œå¯ä»¥è¿›è¡ŒèŒƒå›´æŸ¥æ‰¾ã€‚</p>
<pre tabindex="0"><code>// compareObj å¦‚æœobj1&gt;obj2ï¼Œè¿”å›true
func compareObj(obj1, obj2 interface{}) bool {
  var t1, t2 reflect.Type
  t1 = reflect.TypeOf(obj1)
  t2 = reflect.TypeOf(obj2)
  if t1.Kind() != t2.Kind() {
    compareObj(fmt.Sprint(obj1), fmt.Sprint(obj2))
  }
  var v1, v2 reflect.Value
  v1 = reflect.ValueOf(obj1)
  v2 = reflect.ValueOf(obj2)
  switch t1.Kind() {
  case reflect.Int:
    return v1.Int() &gt; v2.Int()
  case reflect.Float64, reflect.Float32:
    return v1.Float() &gt; v2.Float()
  case reflect.String:
    return v1.String() &gt; v2.String()
  }
  return compareObj(fmt.Sprint(obj1), fmt.Sprint(obj2))
}
</code></pre><h2 id="2--èŠ‚ç‚¹çš„æ’å…¥">2.  èŠ‚ç‚¹çš„æ’å…¥</h2>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20210503231517.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>åœ¨é“¾è¡¨ä¸­å¦‚æœè¦æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹Sï¼Œéœ€è¦æ‰¾åˆ°åœ¨é“¾è¡¨ä¸­æ¯”Så°çš„æœ€å¤§èŠ‚ç‚¹Fï¼ŒæŠŠSæŒ‚åœ¨FèŠ‚ç‚¹åé¢ã€‚é‚£ä¹ˆåœ¨è·³è¡¨ä¸­ä¹Ÿæ˜¯è¿™æ ·çš„å¥—è·¯ï¼Œåªä¸è¿‡æ›´å¤æ‚ä¸€äº›ã€‚ä¸‹é¢åˆ†å‡ æ­¥å°†ä¸Šå›¾ä¸­s2.5èŠ‚ç‚¹æŒ‚åœ¨s2åé¢ï¼Œå·²çŸ¥s2.5çš„scoreæˆ–è€…objæ¯”s2çš„scoreæˆ–objè¦å¤§ï¼Œä½†æ˜¯å°äºs3ã€‚</p>
<h3 id="21--æŸ¥æ‰¾æ¯”s25å°çš„æœ€å¤§èŠ‚ç‚¹">2.1.  æŸ¥æ‰¾æ¯”s2.5å°çš„æœ€å¤§èŠ‚ç‚¹</h3>
<p>åœ¨æ’å…¥æ–°èŠ‚ç‚¹ä¹‹å‰ï¼Œéœ€è¦æ‰¾åˆ°æ–°èŠ‚ç‚¹å¯ä»¥æ’å…¥çš„ä½ç½®ï¼Œå°±éœ€è¦æ‰¾å‡ºæ¯ä¸€å±‚ç´¢å¼•ä¸­æ–°èŠ‚ç‚¹çš„å‰ä¸€èŠ‚ç‚¹ï¼Œè¿™é‡Œå°±æ˜¯æ¯”s2.5å°çš„æœ€å¤§èŠ‚ç‚¹ã€‚è·³è¡¨æœ‰äº”å±‚ç´¢å¼•ï¼Œè¡¨ç¤ºä¸º0-4ã€‚è·³è¡¨çš„èµ·ç‚¹æ˜¯headerï¼Œå› æ­¤æŸ¥æ‰¾èŠ‚ç‚¹æ—¶éœ€è¦ä»headerçš„level 4å¼€å§‹è¿›è¡Œï¼Œè¡¨ç¤ºä¸ºheader.levels[4]ã€‚ä»£ç ä¸­ä½¿ç”¨update[i]è¡¨ç¤ºç¬¬iå±‚ç´¢å¼•ä¸­æ¯”s2.5å°çš„æœ€å¤§èŠ‚ç‚¹æŒ‡é’ˆã€‚æ³¨æ„ä¸‹é¢çš„ä»£ç è¿˜æœ‰ä¸€ä¸ªrankæ•°ç»„ï¼Œrank[i]å°±è¡¨ç¤ºç¬¬iå±‚ç´¢å¼•ä¸­ï¼Œupdate[i]èŠ‚ç‚¹åˆ°headerçš„spanï¼Œä¸‹é¢æ³¨æ„å®ƒæ˜¯æ€ä¹ˆå¢åŠ çš„ã€‚</p>
<ol>
<li>ä»header.levels[4]å¼€å§‹å‘å³éå†ï¼Œæ­¤æ—¶rank[4]=0ï¼›header.levels[4]ä¸‹ä¸€èŠ‚ç‚¹æ˜¯s4æ¯”s2.5å¤§ï¼Œå› æ­¤è¯¥å±‚ç´¢å¼•ä¸­s2.5çš„ä¸Šä¸€èŠ‚ç‚¹å°±æ˜¯headerï¼Œå³update[4]=headerï¼Œæ¥ä¸‹æ¥å‘ä¸‹è¿›å…¥ç¬¬3å±‚ç´¢å¼•ï¼Œå³header.levels[3]</li>
<li>ç¬¬3å±‚ç´¢å¼•ä¸­ï¼Œåˆå§‹rank[3] =rank[4]=0ï¼Œå‘å³éå†æœç´¢åˆ°headerçš„ä¸‹ä¸€èŠ‚ç‚¹s2ã€‚s2å°±æ˜¯è¿™ä¸€å±‚s2.5éœ€è¦æ’å…¥çš„ä½ç½®çš„å‰ä¸€èŠ‚ç‚¹ï¼Œå› æ­¤update[3]=s2ï¼Œrank[3]=rank[3]+header.levels[3].span=2ï¼Œç„¶åå‘ä¸‹è¿›å…¥s2.levels[2]</li>
<li>ä¾æ¬¡éå†ç¬¬2ã€1ã€0å±‚ç´¢å¼•ï¼Œè·¯å¾„ä¸ºs2.levels[2]-&gt;s2.levels[1]-&gt;s2.levels[0]ï¼Œæ±‚å¾—update[2]=update[1]=update[0]=s2ï¼Œrank[2]=rank[1]=rank[0]=rank[3]=2ã€‚åˆ°è¿™é‡Œï¼Œé€šè¿‡èµ°æ¥¼æ¢¯çš„æ–¹å¼å°†s2.5éœ€è¦æ’å…¥çš„ä½ç½®å…¨æ‰¾å‡ºæ¥äº†</li>
</ol>
<pre tabindex="0"><code> x = sl.header
  for i := sl.level-1; i &gt;= 0; i -- {
    if i == sl.level-1 {
      rank[i] = 0
    } else {
      rank[i] = rank[i+1]
    }
    // å¯»æ‰¾æ¯”scoreå’Œrobjå°çš„æœ€è¿‘èŠ‚ç‚¹
    for x.levels[i].next != nil &amp;&amp; (x.levels[i].next.score &lt; score ||
          (x.levels[i].next.score == score &amp;&amp; compareObj(robj, x.levels[i].next.robj))) {
      rank[i] += x.levels[i].span
      x = x.levels[i].next
    }
    update[i] = x
  }
</code></pre><h3 id="22--æ’å…¥èŠ‚ç‚¹s25">2.2.  æ’å…¥èŠ‚ç‚¹s2.5</h3>
<p>ç°åœ¨æœ‰äº†updateæ•°ç»„è¡¨ç¤ºå„å±‚ç´¢å¼•ä¸­s2.5çš„ä¸Šä¸€èŠ‚ç‚¹ä½ç½®ï¼Œä»¥åŠrankæ•°ç»„è¡¨ç¤ºupdateå„èŠ‚ç‚¹åˆ°headerçš„è·ç¦»ï¼Œå°±å¯ä»¥è¿›è¡Œs2.5çš„æ’å…¥äº†ã€‚</p>
<pre tabindex="0"><code>var level = randomLevel()
  // ä»£ç 1
  if level &gt; sl.level {
    for i := sl.level; i &lt; level; i ++ {
      rank[i] = 0
      update[i] = sl.header
      update[i].levels[i].span = sl.length
    }
    sl.level = level
  }
  //-----
  x = createSkiplistNode(level, score, robj)
  // ä»£ç 2
  for i := 0; i &lt; level; i ++ {
    x.levels[i].next = update[i].levels[i].next
    update[i].levels[i].next = x

    x.levels[i].span = update[i].levels[i].span - (rank[0]-rank[i])
    update[i].levels[i].span = rank[0] - rank[1] + 1
  }
  // -----
  // ä»£ç 3
  for i := level-1; i &lt; sl.level; i ++ {
    update[i].levels[i].span ++
  }
  //-----
  // å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯æ’å…¥çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå®ƒçš„prevæ˜¯nil
  if update[0] == sl.header {
    x.prev = nil
  } else {
    x.prev = update[0]
  }
  if x.levels[0].next != nil {
    x.levels[0].next.prev = x
  } else {
    sl.tail = x
  }
  sl.length ++
</code></pre><ol>
<li>
<p>é¦–å…ˆé€šè¿‡éšæœºç®—æ³•randomLevel()è·å–è¯¥èŠ‚ç‚¹çš„ç´¢å¼•å±‚æ•°</p>
</li>
<li>
<p>ç°åœ¨æœ‰ä¸¤ç§æƒ…å†µï¼šlevelæ¯”è·³è¡¨åŸæ¥çš„å±‚æ•°sl.levelè¦å¤§æˆ–è€…levelå°äºç­‰äºsl.level</p>
</li>
<li>
<ul>
<li>é¦–å…ˆå¤„ç†level&gt;sl.levelçš„æƒ…å†µï¼ˆä»£ç 1ï¼‰ã€‚é«˜äºsl.levelå°äºlevelçš„ç´¢å¼•iä¸­ï¼Œs2.5çš„å‰ä¸€èŠ‚ç‚¹å°±ç›´æ¥æ˜¯headerï¼Œå› æ­¤è®¾ç½®update[i]=headerï¼ŒåŒæ—¶rank[i]=0ã€‚header.levels[i].spanè®¾ç½®ä¸ºè·³è¡¨çš„é•¿åº¦ã€‚è®¾ç½®sl.level=levelã€‚</li>
<li>ç°åœ¨åªæœ‰level&lt;=sl.levelçš„æƒ…å†µäº†ï¼ˆä»£ç 2ï¼‰ã€‚å½“ç´¢å¼•i&lt;levelæ—¶ï¼Œç›´æ¥å°†s2.5æŒ‚åœ¨update[i].levels[i]çš„åé¢ï¼Œå¹¶æ›´æ–°update[i].levels[i]å’Œs2.5.levels[i]çš„span</li>
<li>è€Œåœ¨level&lt;=sl.levelçš„æƒ…å†µï¼ˆä»£ç 3ï¼‰ï¼Œå½“level&lt;=ç´¢å¼•i&lt;sl.levelæ—¶ï¼Œç›´æ¥æŠŠupdateèŠ‚ç‚¹çš„spanåŠ ä¸€ã€‚å› ä¸ºæ­¤æ—¶æ–°èŠ‚ç‚¹çš„ç´¢å¼•å±‚æ•°levelæ¯”è·³è¡¨çš„å±‚æ•°å°‘ï¼Œé‚£ä¹ˆæ–°èŠ‚ç‚¹çš„æ’å…¥å¯¹äºæ¯”levelé«˜çš„ç´¢å¼•èŠ‚ç‚¹æ¥è¯´å°±æ˜¯å°†å…¶ä¸åé¢èŠ‚ç‚¹çš„è·ç¦»å¢åŠ äº†ä¸€ä¸ªå•ä½ã€‚</li>
</ul>
</li>
<li>
<p>å¤„ç†s2.5çš„prevæŒ‡é’ˆï¼Œç”±ä¸Šé¢çš„å›¾ä¹Ÿå¯ä»¥çŸ¥é“prevæŒ‡é’ˆå’Œç¬¬0å±‚çš„ç´¢å¼•æ˜¯åå‘çš„ï¼Œä½†æ˜¯å¹¶ä¸ä¼šæŒ‡å‘headerã€‚è¿™é‡Œæˆ‘è®¤ä¸ºæ˜¯ä¸ºäº†æ–¹ä¾¿åå‘éå†ï¼Œå¦‚æœs1.prevæŒ‡å‘headerï¼Œåœ¨åå‘éå†æ—¶éœ€è¦åŠ ä¸€å±‚headerçš„åˆ¤æ–­ã€‚</p>
</li>
<li>
<p>å¤„ç†è·³è¡¨çš„tailæŒ‡é’ˆï¼Œå¦‚æœæ’å…¥çš„èŠ‚ç‚¹åœ¨æœ€åï¼Œåˆ™é‡æ–°è®¾ç½®tail</p>
</li>
<li>
<p>æ›´æ–°è·³è¡¨é•¿åº¦</p>
</li>
</ol>
<h2 id="3--åˆ é™¤èŠ‚ç‚¹">3.  åˆ é™¤èŠ‚ç‚¹</h2>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20210503231624.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>ä¸Šå›¾ä¸­ï¼Œå¦‚æœæƒ³åˆ é™¤s3èŠ‚ç‚¹ï¼Œéœ€è¦ä¸¤æ­¥ï¼šæ‰¾åˆ°s3èŠ‚ç‚¹åœ¨å„å±‚ç´¢å¼•å¤„çš„ä¸Šä¸€èŠ‚ç‚¹ï¼›åˆ é™¤s3èŠ‚ç‚¹ã€‚</p>
<h3 id="32--æŸ¥æ‰¾æ¯”s3å°çš„æœ€å¤§èŠ‚ç‚¹">3.2.  æŸ¥æ‰¾æ¯”s3å°çš„æœ€å¤§èŠ‚ç‚¹</h3>
<p>æŸ¥æ‰¾çš„ç®—æ³•ä¾æ—§æ˜¯ä»headerçš„æœ€é«˜å±‚ç´¢å¼•å¼€å§‹ä¸‹æ¥¼æ¢¯ï¼Œå¹¶ä½¿ç”¨updateæ•°ç»„ä¿å­˜æ¯ä¸€å±‚ç´¢å¼•ä¸­s3çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p>
<p>åœ¨ä¸Šå›¾ä¸­ï¼š</p>
<ol>
<li>ä»header.levels[4]å¼€å§‹å‘å³éå†ï¼Œæ‰¾ä¸åˆ°å…¶ä»–çš„èŠ‚ç‚¹å°äºs3ï¼Œå› æ­¤å‘ä¸‹éå†header.levels[3]ï¼Œç¬¬4å±‚çš„æœ€å¤§èŠ‚ç‚¹æ˜¯headerï¼Œå³update[4]=header</li>
<li>ä¾æ¬¡ç±»æ¨ï¼Œupdate[3]=s2ï¼Œupdate[2]=s2ï¼Œupdate[1]=update[0]=s2ï¼Œéå†è·¯å¾„è§å›¾ä¸­çš„è“è‰²ç®­å¤´ã€‚</li>
</ol>
<pre tabindex="0"><code>
// æŸ¥æ‰¾æœ€è¿‘èŠ‚ç‚¹
  x = sl.header
  for i := sl.level-1; i &gt;= 0; i -- {
    for x.levels[i].next != nil &amp;&amp; (x.levels[i].next.score &lt; score || 
      (x.levels[i].next.score == score &amp;&amp; compareObj(robj, x.levels[i].next.robj))) {
      x = x.levels[i].next
    }
    update[i] = x
  }
</code></pre><h3 id="23--åˆ é™¤èŠ‚ç‚¹">2.3.  åˆ é™¤èŠ‚ç‚¹</h3>
<p>åˆ é™¤èŠ‚ç‚¹å°±æ¯”è¾ƒç®€å•äº†ï¼Œä½†æ˜¯åœ¨è¿™ä¹‹å‰éœ€è¦éªŒè¯ä¸€ä¸‹xæŒ‡å‘çš„ä¸‹ä¸€èŠ‚ç‚¹æ˜¯ä¸æ˜¯éœ€è¦åˆ é™¤çš„æ•°æ®ï¼š</p>
<pre tabindex="0"><code>
  // xä¹‹åçš„èŠ‚ç‚¹å¯èƒ½æ˜¯éœ€è¦åˆ é™¤çš„èŠ‚ç‚¹ï¼Œä¹Ÿå¯èƒ½ä¸æ˜¯
  x = x.levels[0].next
  if x != nil &amp;&amp; x.score == score &amp;&amp; equalObj(x.robj, robj) {
    sl.deleteNode(update, x)
    return true
  }
</code></pre><p>åœ¨deleteNodeä¸­ï¼Œè¿›è¡Œå¦‚ä¸‹åˆ é™¤æ­¥éª¤ï¼š</p>
<ol>
<li>
<p>å¯¹æ¯ä¸€å±‚çš„update[i]è¿›è¡Œï¼š</p>
</li>
<li>
<ul>
<li>å¦‚æœupdate[i].levels[i]çš„ä¸‹ä¸€èŠ‚ç‚¹æ˜¯xï¼Œåˆ™è¿›è¡Œxçš„åˆ é™¤ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹æŒ‡é’ˆå’Œspançš„æ”¹å˜</li>
<li>å¦‚æœupdate[i].levels[i]çš„ä¸‹ä¸€èŠ‚ç‚¹ä¸æ˜¯xï¼Œä¾‹å¦‚ï¼šåˆ é™¤s3èŠ‚ç‚¹ï¼Œå®ƒçš„update[4].levels[4]ä¸‹ä¸€èŠ‚ç‚¹æ˜¯s4ï¼Œæ­¤æ—¶ç›´æ¥å°†update[4].levels[4]çš„spanå‡ä¸€</li>
</ul>
</li>
<li>
<p>å°†xçš„nextèŠ‚ç‚¹ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰æŒ‚åœ¨xçš„prevèŠ‚ç‚¹åé¢</p>
</li>
<li>
<p>æ›´æ–°è·³è¡¨çš„levelå€¼ã€‚ä»¥åˆ é™¤s4èŠ‚ç‚¹ä¸ºä¾‹ï¼Œåˆ é™¤å®Œè¯¥èŠ‚ç‚¹ä¹‹åè·³è¡¨å®é™…å±‚æ•°åº”è¯¥è°ƒæ•´ä¸º3ã€‚ä»ç¬¬4å±‚å¼€å§‹å‘ä¸‹éå†ï¼Œå¦‚æœheader.levels[i].nextæ˜¯nilï¼Œè¯´æ˜è¯¥å±‚ç´¢å¼•å·²ç»æ²¡å¿…è¦å­˜åœ¨äº†ï¼Œå°±å°†è·³è¡¨çš„levelå‡ä¸€</p>
</li>
<li>
<p>åˆ«å¿˜äº†æŠŠè·³è¡¨çš„lengthå‡ä¸€</p>
</li>
</ol>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>è·³è¡¨å¬èµ·æ¥æŒºéš¾ï¼Œå¦‚æœä»”ç»†ç ”ç©¶å®ƒçš„ä»£ç çš„è¯è¿˜æ˜¯æŒºç®€å•çš„ã€‚è·³è¡¨ä¸»è¦éš¾çš„åœ°æ–¹å°±åœ¨äºèŠ‚ç‚¹çš„æ’å…¥å’Œåˆ é™¤ï¼Œåªè¦ç†è§£äº†è·³è¡¨çš„å¤šçº§ç´¢å¼•æ˜¯æ€ä¹ˆä½¿ç”¨çš„ï¼Œå…¶ä»–çš„æ“ä½œï¼šèŒƒå›´æŸ¥è¯¢ã€æŸ¥è¯¢æ’åç­‰éƒ½æ¯”è¾ƒç®€å•äº†ã€‚è¿™å—çš„ä»£ç å¯ä»¥çœ‹redisçš„æºç ï¼Œåœ¨å®ƒçš„t_zset.cå’Œredis.hä¸­æœ‰zslå¼€å¤´çš„ä»£ç å°±æ˜¯è·³è¡¨ç›¸å…³å†…å®¹ã€‚ä¸è¿‡æˆ‘è§‰å¾—æ›´éš¾çš„æ˜¯å†™æ–‡æ¡£ï¼Œå†™æ–‡æ¡£çš„æ—¶å€™éœ€è¦é˜…è¯»å®Œä»£ç ä¹‹åç†æ¸…æ€è·¯ï¼Œè¿™å—æˆ‘å‘ç°é€šè¿‡ç”»å›¾è¿˜æ˜¯å¯ä»¥åŠ æ·±ç†è§£çš„ã€‚</p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/7db296fb/">
        
        

        <div class="article-details">
            <h2 class="article-title">åˆ†å¸ƒå¼é”é«˜å¹¶å‘ä¼˜åŒ–</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/9f188831/">
        
        

        <div class="article-details">
            <h2 class="article-title">Redis ç¬”è®°</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="lxbwolf/lxbwolf.github.io"
        issue-term="pathname"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2023 Xiaobin&#39;s Blog
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
