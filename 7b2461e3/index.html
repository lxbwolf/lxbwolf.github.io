<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Section1 channel ä½¿ç”¨ 1.1 make channel ä¸€ç§æ˜¯å¸¦ç¼“å†²çš„channelä¸€ç§æ˜¯ä¸å¸¦ç¼“å†²çš„channelã€‚åˆ›å»ºæ–¹å¼åˆ†åˆ«å¦‚ä¸‹ï¼š // buffered ch := make(chan Task, 3) // unbuffered ch := make(chan int) buffered channel å¦‚æœæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¸¦'>
<title>Go channel åŸç†</title>

<link rel='canonical' href='https://lxb.wiki/7b2461e3/'>

<link rel="stylesheet" href="/scss/style.min.e5fa5972b3e81b9d9b61e2598991a71c444ca50e38b034d78f5651a82802e894.css"><meta property='og:title' content='Go channel åŸç†'>
<meta property='og:description' content='Section1 channel ä½¿ç”¨ 1.1 make channel ä¸€ç§æ˜¯å¸¦ç¼“å†²çš„channelä¸€ç§æ˜¯ä¸å¸¦ç¼“å†²çš„channelã€‚åˆ›å»ºæ–¹å¼åˆ†åˆ«å¦‚ä¸‹ï¼š // buffered ch := make(chan Task, 3) // unbuffered ch := make(chan int) buffered channel å¦‚æœæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¸¦'>
<meta property='og:url' content='https://lxb.wiki/7b2461e3/'>
<meta property='og:site_name' content='Xiaobin&#39;s Notes'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='go' /><meta property='article:published_time' content='2021-11-10T21:56:56&#43;00:00'/><meta property='article:modified_time' content='2021-11-10T21:56:56&#43;00:00'/>
<meta name="twitter:title" content="Go channel åŸç†">
<meta name="twitter:description" content="Section1 channel ä½¿ç”¨ 1.1 make channel ä¸€ç§æ˜¯å¸¦ç¼“å†²çš„channelä¸€ç§æ˜¯ä¸å¸¦ç¼“å†²çš„channelã€‚åˆ›å»ºæ–¹å¼åˆ†åˆ«å¦‚ä¸‹ï¼š // buffered ch := make(chan Task, 3) // unbuffered ch := make(chan int) buffered channel å¦‚æœæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¸¦">
<link rel="shortcut icon" href="/favicon.png" />

<script data-ad-client="ca-pub-5708899526501350" async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-JZ2PWLT6JY"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-JZ2PWLT6JY');
</script>
<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?e710560ffa44cae2b3a6259e0171fb5f";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>
<script>
    (function () {
        var el = document.createElement("script");
        el.src = "https://lf1-cdn-tos.bytegoofy.com/goofy/ttzz/push.js?f146251743600ee0672cdcc8455ce18def91cdb255ad969a2ef5c715d5ed5baecaf7cd753709c168f20e6a2e9019123fd11e31a222d3a2fe01ad05c6b8f519b2";
        el.id = "ttzz";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(el, s);
    })(window)
</script>
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu692828361b78eaa42fdbdbbf5a7177a9_44446_300x0_resize_q75_box.jpeg" width="300"
                            height="298" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Xiaobin&#39;s Notes</a></h1>
            <h2 class="site-description"></h2>
        </div>
    </header>


    <ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                <span>é¦–é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/categories/' >
                
                
                
                <span>åˆ†ç±»</span>
            </a>
        </li>
        
        
        <li >
            <a href='/tags/' >
                
                
                
                <span>æ ‡ç­¾</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                <span>å‹é“¾</span>
            </a>
        </li>
        

        <div class="menu-bottom-section"><ol class="social-menu">
                    
                        <li>
                            <a 
                                href='mailto://me@liuxb.email'
                                target="_blank"
                                title="Email"
                                rel="me"
                            >
                                
                                
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                                
                            </a>
                        </li>
                    
                        <li>
                            <a 
                                href='https://github.com/lxbwolf'
                                target="_blank"
                                title="GitHub"
                                rel="me"
                            >
                                
                                
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                                
                            </a>
                        </li>
                    
                        <li>
                            <a 
                                href='https://lxb.wiki/atom.xml'
                                target="_blank"
                                title="Rss"
                                rel="me"
                            >
                                
                                
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="5" cy="19" r="1" />
  <path d="M4 4a16 16 0 0 1 16 16" />
  <path d="M4 11a9 9 0 0 1 9 9" />
</svg>



                                
                            </a>
                        </li>
                    
                </ol>
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>æš—è‰²æ¨¡å¼</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
<section class="widget archives">
    
    <h2 class="widget-title section-title">ç›®å½•</h2>

    <div class="widget--toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#11-make-channel">1.1 make channel</a></li>
    <li><a href="#12-sends-and-receives">1.2 sends and receives</a></li>
  </ul>

  <ul>
    <li><a href="#21-channelæ•°æ®å­˜å‚¨ç»“æ„">2.1 channelæ•°æ®å­˜å‚¨ç»“æ„</a></li>
    <li><a href="#22-ç¯å½¢é˜Ÿåˆ—">2.2 ç¯å½¢é˜Ÿåˆ—</a></li>
    <li><a href="#23-ç­‰å¾…é˜Ÿåˆ—">2.3 ç­‰å¾…é˜Ÿåˆ—</a></li>
    <li><a href="#24-ç±»å‹ä¿¡æ¯">2.4 ç±»å‹ä¿¡æ¯</a></li>
    <li><a href="#25-é”">2.5 é”</a></li>
  </ul>

  <ul>
    <li><a href="#31-åˆ›å»ºchannel">3.1 åˆ›å»ºchannel</a></li>
    <li><a href="#32-åç¨‹å‘channelå†™å…¥æ•°æ®goroutine-sender-data">3.2 åç¨‹å‘channelå†™å…¥æ•°æ®(goroutine sender data)</a></li>
    <li><a href="#33-åç¨‹ä»channelæ¥æ”¶æ•°æ®goroutine-receive-data">3.3 åç¨‹ä»channelæ¥æ”¶æ•°æ®(goroutine receive data)</a></li>
    <li><a href="#34-å…³é—­channel">3.4 å…³é—­channel</a></li>
  </ul>

  <ul>
    <li><a href="#41-å•å‘channel">4.1 å•å‘channel</a></li>
    <li><a href="#42-select">4.2 select</a></li>
    <li><a href="#43-range">4.3 range</a></li>
  </ul>
</nav>
    </div>
</section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
        <a href="/categories/Lang/" >
            Lang
        </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/7b2461e3/">Go channel åŸç†</a>
        </h2>

        
    </div>

    
    
    
    
    <footer class="article-time">
        
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
            <time class="article-time--published">Nov 10, 2021</time>
        </div>
        

        
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



            <time class="article-time--reading">
                é˜…è¯»æ—¶é•¿: 13 åˆ†é’Ÿ
            </time>
        </div>
        
        <small>
    <section class="article-tags">
        
            <a href="/tags/go/">go</a>
        
    </section>
</small>
    </footer>
    

    
</div>
</header>

    <section class="article-content">
    
    
    <!-- raw HTML omitted -->
<h1 id="section1-channel-ä½¿ç”¨">Section1 channel ä½¿ç”¨</h1>
<h2 id="11-make-channel">1.1 make channel</h2>
<p>ä¸€ç§æ˜¯å¸¦ç¼“å†²çš„channelä¸€ç§æ˜¯ä¸å¸¦ç¼“å†²çš„channelã€‚åˆ›å»ºæ–¹å¼åˆ†åˆ«å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// buffered
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">Task</span>, <span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// unbuffered
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>)
</span></span></code></pre></div><p><strong>buffered channel</strong></p>
<p>å¦‚æœæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¸¦bufferçš„channelï¼Œåº•å±‚çš„æ•°æ®æ¨¡å‹å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312170000.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>å½“æˆ‘ä»¬å‘channelé‡Œé¢å†™å…¥æ•°æ®æ—¶å€™ï¼Œä¼šç›´æ¥æŠŠæ•°æ®å­˜å…¥circular queue(send)ã€‚å½“Queueå­˜æ»¡äº†ä¹‹åå°±ä¼šæ˜¯å¦‚ä¸‹çš„çŠ¶æ€ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312170039.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>å½“dequeueä¸€ä¸ªå…ƒç´ æ—¶å€™ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312170108.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>ä»ä¸Šå›¾å¯çŸ¥ï¼Œrecvxè‡ªå¢åŠ ä¸€ï¼Œè¡¨ç¤ºå‡ºé˜Ÿäº†ä¸€ä¸ªå…ƒç´ ï¼Œå…¶å®ä¹Ÿå°±æ˜¯å¾ªç¯æ•°ç»„å®ç°FIFOè¯­ä¹‰ã€‚</p>
<p>é‚£ä¹ˆè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå½“æˆ‘ä»¬æ–°å»ºchannelçš„æ—¶å€™ï¼Œåº•å±‚åˆ›å»ºçš„hchanæ•°æ®ç»“æ„æ˜¯åœ¨å“ªé‡Œåˆ†é…å†…å­˜çš„å‘¢ï¼Ÿå…¶å®Section2é‡Œé¢æºç åˆ†ææ—¶å€™å·²ç»åšäº†åˆ†æï¼Œhchanæ˜¯åœ¨heapé‡Œé¢åˆ†é…çš„ã€‚</p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312170236.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>å½“æˆ‘ä»¬ä½¿ç”¨makeå»åˆ›å»ºä¸€ä¸ªchannelçš„æ—¶å€™ï¼Œå®é™…ä¸Šè¿”å›çš„æ˜¯ä¸€ä¸ªæŒ‡å‘channelçš„pointerï¼Œæ‰€ä»¥æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸åŒçš„functionä¹‹é—´ç›´æ¥ä¼ é€’channelå¯¹è±¡ï¼Œè€Œä¸ç”¨é€šè¿‡æŒ‡å‘channelçš„æŒ‡é’ˆã€‚</p>
<h2 id="12-sends-and-receives">1.2 sends and receives</h2>
<p>ä¸åŒgoroutineåœ¨channelä¸Šé¢è¿›è¡Œè¯»å†™æ—¶ï¼Œæ¶‰åŠåˆ°çš„è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæ¯”å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312170342.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>ä¸Šå›¾ä¸­G1ä¼šå¾€channelé‡Œé¢å†™å…¥æ•°æ®ï¼ŒG2ä¼šä»channelé‡Œé¢è¯»å–æ•°æ®ã€‚</p>
<p>G1ä½œç”¨äºåº•å±‚hchançš„æµç¨‹å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312170423.png"
	
	
	
	loading="lazy"
	
	
></p>
<ol>
<li>å…ˆè·å–å…¨å±€é”ï¼›</li>
<li>ç„¶åenqueueå…ƒç´ (é€šè¿‡ç§»åŠ¨æ‹·è´çš„æ–¹å¼)ï¼›</li>
<li>é‡Šæ”¾é”ï¼›</li>
</ol>
<p>G2è¯»å–æ—¶å€™ä½œç”¨äºåº•å±‚æ•°æ®ç»“æ„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312170525.png"
	
	
	
	loading="lazy"
	
	
></p>
<ol>
<li>å…ˆè·å–å…¨å±€é”ï¼›</li>
<li>ç„¶ådequeueå…ƒç´ (é€šè¿‡ç§»åŠ¨æ‹·è´çš„æ–¹å¼)ï¼›</li>
<li>é‡Šæ”¾é”ï¼›</li>
</ol>
<p>ä¸Šé¢çš„è¯»å†™æ€è·¯å…¶å®å¾ˆç®€å•ï¼Œé™¤äº†hchanæ•°æ®ç»“æ„å¤–ï¼Œä¸è¦é€šè¿‡å…±äº«å†…å­˜å»é€šä¿¡ï¼›è€Œæ˜¯é€šè¿‡é€šä¿¡(å¤åˆ¶)å®ç°å…±äº«å†…å­˜ã€‚</p>
<p><strong>å†™å…¥æ»¡channelçš„åœºæ™¯</strong></p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šchannelå†™å…¥3ä¸ªtaskä¹‹åé˜Ÿåˆ—å·²ç»æ»¡äº†ï¼Œè¿™æ—¶å€™G1å†å†™å…¥ç¬¬å››ä¸ªtaskçš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312170644.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>G1è¿™æ—¶å€™ä¼šæš‚åœç›´åˆ°å‡ºç°ä¸€ä¸ªreceiverã€‚</p>
<p>è¿™ä¸ªåœ°æ–¹éœ€è¦ä»‹ç»ä¸€ä¸‹Golangçš„schedulerçš„ã€‚æˆ‘ä»¬çŸ¥é“goroutineæ˜¯ç”¨æˆ·ç©ºé—´çš„çº¿ç¨‹ï¼Œåˆ›å»ºå’Œç®¡ç†åç¨‹éƒ½æ˜¯é€šè¿‡Goçš„runtimeï¼Œè€Œä¸æ˜¯é€šè¿‡OSçš„threadã€‚</p>
<p>ä½†æ˜¯Goçš„runtimeè°ƒåº¦æ‰§è¡Œgoroutineå´æ˜¯åŸºäºOS threadçš„ã€‚å¦‚ä¸‹å›¾ï¼š
<img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312173326.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>å½“å‘å·²ç»æ»¡çš„channelé‡Œé¢å†™å…¥æ•°æ®æ—¶å€™ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312173420.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>ä¸Šå›¾æµç¨‹å¤§æ¦‚å¦‚ä¸‹ï¼š</p>
<p>å½“å‰goroutineï¼ˆG1ï¼‰ä¼šè°ƒç”¨goparkå‡½æ•°ï¼Œå°†å½“å‰åç¨‹ç½®ä¸ºwaitingçŠ¶æ€ï¼›
å°†Må’ŒG1ç»‘å®šå…³ç³»æ–­å¼€ï¼›
schedulerä¼šè°ƒåº¦å¦å¤–ä¸€ä¸ªå°±ç»ªæ€çš„goroutineä¸Må»ºç«‹ç»‘å®šå…³ç³»ï¼Œç„¶åM ä¼šè¿è¡Œå¦å¤–ä¸€ä¸ªGã€‚
æ‰€ä»¥æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼ŒOS threadä¼šä¸€ç›´å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œä¸ä¼šå› ä¸ºåç¨‹G1çš„é˜»å¡è€Œé˜»å¡ã€‚æœ€åå½“å‰çš„G1çš„å¼•ç”¨ä¼šå­˜å…¥channelçš„senderé˜Ÿåˆ—(é˜Ÿåˆ—å…ƒç´ æ˜¯æŒæœ‰G1çš„sudog)ã€‚</p>
<p>é‚£ä¹ˆblockedçš„G1æ€ä¹ˆæ¢å¤å‘¢ï¼Ÿ<strong>å½“æœ‰ä¸€ä¸ªreceiveræ¥æ”¶channelæ•°æ®çš„æ—¶å€™ï¼Œä¼šæ¢å¤ G1ã€‚</strong></p>
<p>å®é™…ä¸Šhchanæ•°æ®ç»“æ„ä¹Ÿå­˜å‚¨äº†channelçš„senderå’Œreceiverçš„ç­‰å¾…é˜Ÿåˆ—ã€‚æ•°æ®åŸå‹å¦‚ä¸‹ï¼š
<img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312173537.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>ç­‰å¾…é˜Ÿåˆ—é‡Œé¢æ˜¯sudogçš„å•é“¾è¡¨ï¼ŒsudogæŒæœ‰ä¸€ä¸ªGä»£è¡¨goroutineå¯¹è±¡å¼•ç”¨ï¼Œelemä»£è¡¨channelé‡Œé¢ä¿å­˜çš„å…ƒç´ ã€‚å½“G1æ‰§è¡Œ<code>ch&lt;-task4</code>çš„æ—¶å€™ï¼ŒG1ä¼šåˆ›å»ºä¸€ä¸ªsudogç„¶åä¿å­˜è¿›å…¥sendqé˜Ÿåˆ—ï¼Œå®é™…ä¸Šhchanç»“æ„å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312173614.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>è¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœG2è¿›è¡Œä¸€ä¸ªè¯»å–channelæ“ä½œï¼Œè¯»å–å‰å’Œè¯»å–åçš„å˜åŒ–å›¾å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312173709.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>G2è°ƒç”¨ t:=&lt;-ch è·å–ä¸€ä¸ªå…ƒç´ ï¼›</li>
<li>ä»channelçš„bufferé‡Œé¢å–å‡ºä¸€ä¸ªå…ƒç´ task1ï¼›</li>
<li>ä»senderç­‰å¾…é˜Ÿåˆ—é‡Œé¢popä¸€ä¸ªsudogï¼›</li>
<li>å°†task4å¤åˆ¶bufferä¸­task1çš„ä½ç½®ï¼Œç„¶åæ›´æ–°bufferçš„sendxå’Œrecvxç´¢å¼•å€¼ï¼›</li>
<li>è¿™æ—¶å€™éœ€è¦å°†G1ç½®ä¸ºRunableçŠ¶æ€ï¼Œè¡¨ç¤ºG1å¯ä»¥æ¢å¤è¿è¡Œï¼›</li>
</ol>
<p>è¿™ä¸ªæ—¶å€™å°†G1æ¢å¤åˆ°å¯è¿è¡ŒçŠ¶æ€éœ€è¦schedulerçš„å‚ä¸ã€‚G2ä¼šè°ƒç”¨goready(G1)æ¥å”¤é†’G1ã€‚æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312173855.png"
	
	
	
	loading="lazy"
	
	
></p>
<ol>
<li>é¦–å…ˆG2ä¼šè°ƒç”¨goready(G1)ï¼Œå”¤èµ·schedulerçš„è°ƒåº¦ï¼›</li>
<li>å°†G1è®¾ç½®æˆRunableçŠ¶æ€ï¼›</li>
<li>G1ä¼šåŠ å…¥åˆ°å±€éƒ¨è°ƒåº¦å™¨Pçš„local queueé˜Ÿåˆ—ï¼Œç­‰å¾…è¿è¡Œã€‚</li>
</ol>
<p><strong>è¯»å–ç©ºchannelçš„åœºæ™¯</strong></p>
<p>å½“channelçš„bufferé‡Œé¢ä¸ºç©ºæ—¶ï¼Œè¿™æ—¶å€™å¦‚æœG2é¦–å…ˆå‘èµ·äº†è¯»å–æ“ä½œã€‚å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312173959.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>ä¼šåˆ›å»ºä¸€ä¸ªsudogï¼Œå°†ä»£è¡¨G2çš„sudogå­˜å…¥recvqç­‰å¾…é˜Ÿåˆ—ã€‚ç„¶åG2ä¼šè°ƒç”¨goparkå‡½æ•°è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œè®©å‡ºOS threadï¼Œç„¶åG2è¿›å…¥é˜»å¡æ€ã€‚</p>
<p>è¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœæœ‰ä¸€ä¸ªG1æ‰§è¡Œå†™å…¥æ“ä½œï¼Œæœ€ç›´è§‚çš„æµç¨‹å°±æ˜¯ï¼š</p>
<ol>
<li>
<p>å°†recvqä¸­çš„taskå­˜å…¥bufferï¼›</p>
</li>
<li>
<p>goready(G2) å”¤é†’G2ï¼›</p>
<p><strong>ä½†æ˜¯</strong>æˆ‘ä»¬æœ‰æ›´åŠ æ™ºèƒ½çš„æ–¹æ³•ï¼šdirect send; å…¶å®ä¹Ÿå°±æ˜¯G1ç›´æ¥æŠŠæ•°æ®å†™å…¥åˆ°G2ä¸­çš„elemä¸­ï¼Œè¿™æ ·å°±ä¸ç”¨èµ°G2ä¸­çš„elemå¤åˆ¶åˆ°bufferä¸­ï¼Œå†ä»bufferå¤åˆ¶ç»™G1ã€‚å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312174123.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>å…·ä½“è¿‡ç¨‹å°±æ˜¯G1ç›´æ¥æŠŠæ•°æ®å†™å…¥åˆ°G2çš„æ ˆä¸­ã€‚è¿™æ · G2 ä¸éœ€è¦å»è·å–channelçš„å…¨å±€é”å’Œæ“ä½œç¼“å†²ã€‚</p>
</li>
</ol>
<h1 id="section2-channelæºç ">Section2 channelæºç </h1>
<h2 id="21-channelæ•°æ®å­˜å‚¨ç»“æ„">2.1 channelæ•°æ®å­˜å‚¨ç»“æ„</h2>
<p>åœ¨æºç <code>runtime/chan.go</code> é‡Œé¢å®šä¹‰äº†channelçš„æ•°æ®æ¨¡å‹ï¼Œchannelå¯ä»¥ç†è§£æˆä¸€ä¸ªç¼“å†²é˜Ÿåˆ—ï¼Œè¿™ä¸ªç¼“å†²é˜Ÿåˆ—ç”¨æ¥å­˜å‚¨å…ƒç´ ï¼Œå¹¶ä¸”æä¾›FIFOçš„è¯­ä¹‰ã€‚æºç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">hchan</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//channelé˜Ÿåˆ—é‡Œé¢æ€»çš„æ•°æ®é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">qcount</span>   <span style="color:#66d9ef">uint</span>           <span style="color:#75715e">// total data in the queue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// å¾ªç¯é˜Ÿåˆ—çš„å®¹é‡ï¼Œå¦‚æœæ˜¯éç¼“å†²çš„channelå°±æ˜¯0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dataqsiz</span> <span style="color:#66d9ef">uint</span>           <span style="color:#75715e">// size of the circular queue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// ç¼“å†²é˜Ÿåˆ—ï¼Œæ•°ç»„ç±»å‹ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">buf</span>      <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span> <span style="color:#75715e">// points to an array of dataqsiz elements
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// å…ƒç´ å ç”¨å­—èŠ‚çš„size
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">elemsize</span> <span style="color:#66d9ef">uint16</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å½“å‰é˜Ÿåˆ—å…³é—­æ ‡å¿—ä½ï¼Œéé›¶è¡¨ç¤ºå…³é—­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">closed</span>   <span style="color:#66d9ef">uint32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// é˜Ÿåˆ—é‡Œé¢å…ƒç´ ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">elemtype</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">_type</span> <span style="color:#75715e">// element type
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// é˜Ÿåˆ—sendç´¢å¼•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">sendx</span>    <span style="color:#66d9ef">uint</span>   <span style="color:#75715e">// send index
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// é˜Ÿåˆ—ç´¢å¼•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">recvx</span>    <span style="color:#66d9ef">uint</span>   <span style="color:#75715e">// receive index
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// ç­‰å¾…channelçš„Gé˜Ÿåˆ—ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">recvq</span>    <span style="color:#a6e22e">waitq</span>  <span style="color:#75715e">// list of recv waiters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// å‘channelå‘é€æ•°æ®çš„Gé˜Ÿåˆ—ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">sendq</span>    <span style="color:#a6e22e">waitq</span>  <span style="color:#75715e">// list of send waiters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// lock protects all fields in hchan, as well as several
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// fields in sudogs blocked on this channel.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Do not change another G&#39;s status while holding this lock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// (in particular, do not ready a G), as this can deadlock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// with stack shrinking.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// å…¨å±€é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">lock</span> <span style="color:#a6e22e">mutex</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>channelçš„æ•°æ®ç»“æ„ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯ä¸¤ä¸ªç»“æ„ï¼š
1ï¼‰ä¸€ä¸ªæ•°ç»„å®ç°çš„ç¯å½¢é˜Ÿåˆ—ï¼Œæ•°ç»„æœ‰ä¸¤ä¸ªä¸‹æ ‡ç´¢å¼•åˆ†åˆ«è¡¨ç¤ºè¯»å†™çš„ç´¢å¼•ï¼Œç”¨äºä¿å­˜channelç¼“å†²åŒºæ•°æ®ã€‚
2ï¼‰channelçš„sendå’Œrecvé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é‡Œé¢éƒ½æ˜¯æŒæœ‰goroutineçš„sudogå…ƒç´ ï¼Œé˜Ÿåˆ—éƒ½æ˜¯åŒé“¾è¡¨å®ç°çš„ã€‚
3ï¼‰channelçš„å…¨å±€é”ã€‚</p>
<h2 id="22-ç¯å½¢é˜Ÿåˆ—">2.2 ç¯å½¢é˜Ÿåˆ—</h2>
<p>chanå†…éƒ¨å®ç°äº†ä¸€ä¸ªç¯å½¢é˜Ÿåˆ—ä½œä¸ºå…¶ç¼“å†²åŒºï¼Œé˜Ÿåˆ—çš„é•¿åº¦æ˜¯åˆ›å»ºchanæ—¶æŒ‡å®šçš„ã€‚</p>
<p>ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ªå¯ç¼“å­˜6ä¸ªå…ƒç´ çš„channelç¤ºæ„å›¾ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312174357.png"
	
	
	
	loading="lazy"
	
	
></p>
<ul>
<li>dataqsizæŒ‡ç¤ºäº†é˜Ÿåˆ—é•¿åº¦ä¸º6ï¼Œå³å¯ç¼“å­˜6ä¸ªå…ƒç´ ï¼›</li>
<li>bufæŒ‡å‘é˜Ÿåˆ—çš„å†…å­˜ï¼Œé˜Ÿåˆ—ä¸­è¿˜å‰©ä½™ä¸¤ä¸ªå…ƒç´ ï¼›</li>
<li>qcountè¡¨ç¤ºé˜Ÿåˆ—ä¸­è¿˜æœ‰ä¸¤ä¸ªå…ƒç´ ï¼›</li>
<li>sendxæŒ‡ç¤ºåç»­å†™å…¥çš„æ•°æ®å­˜å‚¨çš„ä½ç½®ï¼Œå–å€¼[0, 6)ï¼›</li>
<li>recvxæŒ‡ç¤ºä»è¯¥ä½ç½®è¯»å–æ•°æ®, å–å€¼[0, 6)ï¼›</li>
</ul>
<h2 id="23-ç­‰å¾…é˜Ÿåˆ—">2.3 ç­‰å¾…é˜Ÿåˆ—</h2>
<p>ä»channelè¯»æ•°æ®ï¼Œå¦‚æœchannelç¼“å†²åŒºä¸ºç©ºæˆ–è€…æ²¡æœ‰ç¼“å†²åŒºï¼Œå½“å‰goroutineä¼šè¢«é˜»å¡ã€‚
å‘channelå†™æ•°æ®ï¼Œå¦‚æœchannelç¼“å†²åŒºå·²æ»¡æˆ–è€…æ²¡æœ‰ç¼“å†²åŒºï¼Œå½“å‰goroutineä¼šè¢«é˜»å¡ã€‚</p>
<p>è¢«é˜»å¡çš„goroutineå°†ä¼šæŒ‚åœ¨channelçš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼š</p>
<ul>
<li>å› è¯»é˜»å¡çš„goroutineä¼šè¢«å‘channelå†™å…¥æ•°æ®çš„goroutineå”¤é†’ï¼›</li>
<li>å› å†™é˜»å¡çš„goroutineä¼šè¢«ä»channelè¯»æ•°æ®çš„goroutineå”¤é†’ï¼›</li>
</ul>
<p>ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ªæ²¡æœ‰ç¼“å†²åŒºçš„channelï¼Œæœ‰å‡ ä¸ªgoroutineé˜»å¡ç­‰å¾…è¯»æ•°æ®ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312174513.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>æ³¨æ„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹recvqå’Œsendqè‡³å°‘æœ‰ä¸€ä¸ªä¸ºç©ºã€‚åªæœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œé‚£å°±æ˜¯åŒä¸€ä¸ªgoroutineä½¿ç”¨selectè¯­å¥å‘channelä¸€è¾¹å†™æ•°æ®ï¼Œä¸€è¾¹è¯»æ•°æ®ã€‚</p>
<h2 id="24-ç±»å‹ä¿¡æ¯">2.4 ç±»å‹ä¿¡æ¯</h2>
<p>ä¸€ä¸ªchannelåªèƒ½ä¼ é€’ä¸€ç§ç±»å‹çš„å€¼ï¼Œç±»å‹ä¿¡æ¯å­˜å‚¨åœ¨hchanæ•°æ®ç»“æ„ä¸­ã€‚</p>
<ul>
<li>elemtypeä»£è¡¨ç±»å‹ï¼Œç”¨äºæ•°æ®ä¼ é€’è¿‡ç¨‹ä¸­çš„èµ‹å€¼ï¼›</li>
<li>elemsizeä»£è¡¨ç±»å‹å¤§å°ï¼Œç”¨äºåœ¨bufä¸­å®šä½å…ƒç´ ä½ç½®ã€‚</li>
</ul>
<h2 id="25-é”">2.5 é”</h2>
<p>ä¸€ä¸ªchannelåŒæ—¶ä»…å…è®¸è¢«ä¸€ä¸ªgoroutineè¯»å†™ï¼Œä¸ºç®€å•èµ·è§ï¼Œæœ¬ç« åç»­éƒ¨åˆ†è¯´æ˜è¯»å†™è¿‡ç¨‹æ—¶ä¸å†æ¶‰åŠåŠ é”å’Œè§£é”ã€‚</p>
<h1 id="section3-channelè¯»å†™">Section3 channelè¯»å†™</h1>
<h2 id="31-åˆ›å»ºchannel">3.1 åˆ›å»ºchannel</h2>
<p>æˆ‘ä»¬æ–°å»ºä¸€ä¸ªchannelçš„æ—¶å€™ä¸€èˆ¬ä½¿ç”¨ <code>make(chan, n)</code> è¯­å¥ï¼Œè¿™ä¸ªè¯­å¥çš„æ‰§è¡Œç¼–è¯‘å™¨ä¼šé‡å†™ç„¶åæ‰§è¡Œ chan.goé‡Œé¢çš„ makechanå‡½æ•°ã€‚å‡½æ•°æºç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">makechan</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">chantype</span>, <span style="color:#a6e22e">size</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">elem</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">elem</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// compiler checks this but be safe.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">size</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">16</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">throw</span>(<span style="color:#e6db74">&#34;makechan: invalid channel element type&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">hchanSize</span><span style="color:#f92672">%</span><span style="color:#a6e22e">maxAlign</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">align</span> &gt; <span style="color:#a6e22e">maxAlign</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">throw</span>(<span style="color:#e6db74">&#34;makechan: bad alignment&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">size</span> &lt; <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> uintptr(<span style="color:#a6e22e">size</span>) &gt; <span style="color:#a6e22e">maxSliceCap</span>(<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">size</span>) <span style="color:#f92672">||</span> uintptr(<span style="color:#a6e22e">size</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">size</span> &gt; <span style="color:#a6e22e">maxAlloc</span><span style="color:#f92672">-</span><span style="color:#a6e22e">hchanSize</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">plainError</span>(<span style="color:#e6db74">&#34;makechan: size out of range&#34;</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Hchan does not contain pointers interesting for GC when elements stored in buf do not contain pointers.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// buf points into the same allocation, elemtype is persistent.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// SudoG&#39;s are referenced from their owning thread so they can&#39;t be collected.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// TODO(dvyukov,rlh): Rethink when collector can move allocated objects.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">size</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">size</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Queue or element size is zero.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span> = (<span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>)(<span style="color:#a6e22e">mallocgc</span>(<span style="color:#a6e22e">hchanSize</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">true</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Race detector uses this location for synchronization.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">buf</span> = <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">c</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">kind</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">kindNoPointers</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Elements do not contain pointers.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// Allocate hchan and buf in one call.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span> = (<span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>)(<span style="color:#a6e22e">mallocgc</span>(<span style="color:#a6e22e">hchanSize</span><span style="color:#f92672">+</span>uintptr(<span style="color:#a6e22e">size</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">size</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">true</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">buf</span> = <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">c</span>), <span style="color:#a6e22e">hchanSize</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Elements contain pointers.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span> = new(<span style="color:#a6e22e">hchan</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">buf</span> = <span style="color:#a6e22e">mallocgc</span>(uintptr(<span style="color:#a6e22e">size</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">size</span>, <span style="color:#a6e22e">elem</span>, <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemsize</span> = uint16(<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">size</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemtype</span> = <span style="color:#a6e22e">elem</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> = uint(<span style="color:#a6e22e">size</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">debugChan</span> {
</span></span><span style="display:flex;"><span>		print(<span style="color:#e6db74">&#34;makechan: chan=&#34;</span>, <span style="color:#a6e22e">c</span>, <span style="color:#e6db74">&#34;; elemsize=&#34;</span>, <span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">size</span>, <span style="color:#e6db74">&#34;; elemalg=&#34;</span>, <span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">alg</span>, <span style="color:#e6db74">&#34;; dataqsiz=&#34;</span>, <span style="color:#a6e22e">size</span>, <span style="color:#e6db74">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯channelé‡Œé¢ä¿å­˜çš„å…ƒç´ çš„æ•°æ®ç±»å‹ï¼Œä¸€ä¸ªæ˜¯ç¼“å†²çš„å®¹é‡(å¦‚æœä¸º0è¡¨ç¤ºæ˜¯éç¼“å†²buffer)ï¼Œåˆ›å»ºæµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ ¹æ®ä¼ é€’çš„ç¼“å†²å¤§å°sizeæ˜¯å¦ä¸ºé›¶ï¼Œåˆ†åˆ«åˆ›å»ºä¸å¸¦bufferçš„channelæˆ–åˆ™å¸¦sizeå¤§å°çš„ç¼“å†²channelï¼š
<ul>
<li>å¯¹äºä¸å¸¦ç¼“å†²channelï¼Œç”³è¯·ä¸€ä¸ªhchanæ•°æ®ç»“æ„çš„å†…å­˜å¤§å°ï¼›</li>
<li>å¯¹äºå¸¦ç¼“å†²channelï¼Œnewä¸€ä¸ªhchanå¯¹è±¡ï¼Œå¹¶åˆå§‹åŒ–bufferå†…å­˜</li>
</ul>
</li>
<li>æ›´æ–° chanä¸­å¾ªç¯é˜Ÿåˆ—çš„å…³é”®å±æ€§ï¼šelemsizeã€elemtypeã€dataqsizã€‚</li>
</ul>
<p>åˆ›å»ºchannelçš„è¿‡ç¨‹å®é™…ä¸Šæ˜¯åˆå§‹åŒ–hchanç»“æ„ã€‚å…¶ä¸­ç±»å‹ä¿¡æ¯å’Œç¼“å†²åŒºé•¿åº¦ç”±makeè¯­å¥ä¼ å…¥ï¼Œbufçš„å¤§å°åˆ™ä¸å…ƒç´ å¤§å°å’Œç¼“å†²åŒºé•¿åº¦å…±åŒå†³å®šã€‚</p>
<p>åˆ›å»ºchannelçš„ä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">makechan</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">chantype</span>, <span style="color:#a6e22e">size</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span> = new(<span style="color:#a6e22e">hchan</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">buf</span> = <span style="color:#a6e22e">malloc</span>(<span style="color:#960050;background-color:#1e0010">å…ƒç´ ç±»å‹å¤§å°</span><span style="color:#f92672">*</span><span style="color:#a6e22e">size</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemsize</span> = <span style="color:#960050;background-color:#1e0010">å…ƒç´ ç±»å‹å¤§å°</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemtype</span> = <span style="color:#960050;background-color:#1e0010">å…ƒç´ ç±»å‹</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> = <span style="color:#a6e22e">size</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="32-åç¨‹å‘channelå†™å…¥æ•°æ®goroutine-sender-data">3.2 åç¨‹å‘channelå†™å…¥æ•°æ®(goroutine sender data)</h2>
<p>æ‰€æœ‰æ‰§è¡Œ c &lt; ep å°†epå‘é€åˆ°channelçš„ä»£ç ï¼Œæœ€åéƒ½ä¼šè°ƒç”¨åˆ°chan.goé‡Œé¢çš„ chansendå‡½æ•°ã€‚</p>
<p>å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">chansend</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>, <span style="color:#a6e22e">ep</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">block</span> <span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">callerpc</span> <span style="color:#66d9ef">uintptr</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span><span style="color:#f92672">......</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å‡½æ•°æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªä»£è¡¨channelçš„æ•°æ®ç»“æ„ï¼Œç¬¬äºŒä¸ªæ˜¯è¦æŒ‡å‘å†™å…¥çš„æ•°æ®çš„æŒ‡é’ˆï¼Œç¬¬ä¸‰ä¸ªblockä»£è¡¨å†™å…¥æ“ä½œæ˜¯å¦é˜»å¡ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312175238.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>å‘ä¸€ä¸ªchannelä¸­å†™æ•°æ®ç®€å•è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¦‚æœç­‰å¾…æ¥æ”¶é˜Ÿåˆ—recvqä¸ä¸ºç©ºï¼Œè¯´æ˜ç¼“å†²åŒºä¸­æ²¡æœ‰æ•°æ®æˆ–è€…æ²¡æœ‰ç¼“å†²åŒºï¼Œæ­¤æ—¶ç›´æ¥ä»recvqå–å‡ºG,å¹¶æŠŠæ•°æ®å†™å…¥ï¼Œæœ€åæŠŠè¯¥Gå”¤é†’ï¼Œç»“æŸå‘é€è¿‡ç¨‹ï¼›</li>
<li>å¦‚æœç¼“å†²åŒºä¸­æœ‰ç©ºä½™ä½ç½®ï¼Œå°†æ•°æ®å†™å…¥ç¼“å†²åŒºï¼Œç»“æŸå‘é€è¿‡ç¨‹ï¼›</li>
<li>å¦‚æœç¼“å†²åŒºä¸­æ²¡æœ‰ç©ºä½™ä½ç½®ï¼Œå°†å¾…å‘é€æ•°æ®å†™å…¥Gï¼Œå°†å½“å‰GåŠ å…¥sendqï¼Œè¿›å…¥ç¡çœ ï¼Œç­‰å¾…è¢«è¯»goroutineå”¤é†’ï¼›</li>
</ol>
<p>æµç¨‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312175356.png"
	
	
	
	loading="lazy"
	
	
></p>
<h2 id="33-åç¨‹ä»channelæ¥æ”¶æ•°æ®goroutine-receive-data">3.3 åç¨‹ä»channelæ¥æ”¶æ•°æ®(goroutine receive data)</h2>
<p>æ‰€æœ‰æ‰§è¡Œ <code>ep &lt; c</code> ä½¿ç”¨epæ¥æ”¶channelæ•°æ®çš„ä»£ç ï¼Œæœ€åéƒ½ä¼šè°ƒç”¨åˆ°chan.goé‡Œé¢çš„ <code>chanrecvå‡½æ•°</code>ã€‚</p>
<p>å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">chanrecv</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>, <span style="color:#a6e22e">ep</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">block</span> <span style="color:#66d9ef">bool</span>) (<span style="color:#a6e22e">selected</span>, <span style="color:#a6e22e">received</span> <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">......</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä»æºç æ³¨é‡Šå°±å¯ä»¥çŸ¥é“ï¼Œè¯¥å‡½æ•°ä»channelé‡Œé¢æ¥æ”¶æ•°æ®ï¼Œç„¶åå°†æ¥æ”¶åˆ°çš„æ•°æ®å†™å…¥åˆ°epæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡é‡Œé¢ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªå‚æ•°blockï¼Œè¡¨ç¤ºå½“channelæ— æ³•è¿”å›æ•°æ®æ—¶æ˜¯å¦é˜»å¡ç­‰å¾…ã€‚å½“block=falseå¹¶ä¸”channelé‡Œé¢æ²¡æœ‰æ•°æ®æ—¶å€™ï¼Œå‡½æ•°ç›´æ¥è¿”å›(false,false)ã€‚
<img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312175531.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>ä»ä¸€ä¸ªchannelè¯»æ•°æ®ç®€å•è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¦‚æœç­‰å¾…å‘é€é˜Ÿåˆ—sendqä¸ä¸ºç©ºï¼Œä¸”æ²¡æœ‰ç¼“å†²åŒºï¼Œç›´æ¥ä»sendqä¸­å–å‡ºGï¼ŒæŠŠGä¸­æ•°æ®è¯»å‡ºï¼Œæœ€åæŠŠGå”¤é†’ï¼Œç»“æŸè¯»å–è¿‡ç¨‹ï¼›</li>
<li>å¦‚æœç­‰å¾…å‘é€é˜Ÿåˆ—sendqä¸ä¸ºç©ºï¼Œæ­¤æ—¶è¯´æ˜ç¼“å†²åŒºå·²æ»¡ï¼Œä»ç¼“å†²åŒºä¸­é¦–éƒ¨è¯»å‡ºæ•°æ®ï¼ŒæŠŠGä¸­æ•°æ®å†™å…¥ç¼“å†²åŒºå°¾éƒ¨ï¼ŒæŠŠGå”¤é†’ï¼Œç»“æŸè¯»å–è¿‡ç¨‹ï¼›</li>
<li>å¦‚æœç¼“å†²åŒºä¸­æœ‰æ•°æ®ï¼Œåˆ™ä»ç¼“å†²åŒºå–å‡ºæ•°æ®ï¼Œç»“æŸè¯»å–è¿‡ç¨‹ï¼›</li>
<li>å°†å½“å‰goroutineåŠ å…¥recvqï¼Œè¿›å…¥ç¡çœ ï¼Œç­‰å¾…è¢«å†™goroutineå”¤é†’ï¼›</li>
</ol>
<p>ç®€å•æµç¨‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lxbwolf/blog_source_image@main/20220312175628.png"
	
	
	
	loading="lazy"
	
	
></p>
<h2 id="34-å…³é—­channel">3.4 å…³é—­channel</h2>
<p>å½“æˆ‘ä»¬æ‰§è¡Œchannelçš„closeæ“ä½œçš„æ—¶å€™ä¼šå…³é—­channelã€‚</p>
<p>å…³é—­çš„ä¸»è¦æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<ol>
<li>è·å–å…¨å±€é”ï¼›</li>
<li>è®¾ç½®channelæ•°æ®ç»“æ„chançš„å…³é—­æ ‡å¿—ä½ï¼›</li>
<li>è·å–å½“å‰channelä¸Šé¢çš„è¯»goroutineå¹¶é“¾æ¥æˆé“¾è¡¨ï¼›</li>
<li>è·å–å½“å‰channelä¸Šé¢çš„å†™goroutineç„¶åæ‹¼æ¥åˆ°å‰é¢çš„è¯»é“¾è¡¨åé¢ï¼›</li>
<li>é‡Šæ”¾å…¨å±€é”ï¼›</li>
<li>å”¤é†’æ‰€æœ‰çš„è¯»å†™goroutineã€‚</li>
</ol>
<p>å…³é—­channelæ—¶ä¼šæŠŠrecvqä¸­çš„Gå…¨éƒ¨å”¤é†’ï¼Œæœ¬è¯¥å†™å…¥Gçš„æ•°æ®ä½ç½®ä¸ºnilã€‚æŠŠsendqä¸­çš„Gå…¨éƒ¨å”¤é†’ï¼Œä½†è¿™äº›Gä¼španicã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œpanicå‡ºç°çš„å¸¸è§åœºæ™¯è¿˜æœ‰ï¼š</p>
<ol>
<li>å…³é—­å€¼ä¸ºnilçš„channel</li>
<li>å…³é—­å·²ç»è¢«å…³é—­çš„channel</li>
<li>å‘å·²ç»å…³é—­çš„channelå†™æ•°æ®</li>
</ol>
<h1 id="section4-å¸¸è§ç”¨æ³•">Section4 å¸¸è§ç”¨æ³•</h1>
<h2 id="41-å•å‘channel">4.1 å•å‘channel</h2>
<p>å•å‘channelæŒ‡åªèƒ½ç”¨äºå‘é€æˆ–æ¥æ”¶æ•°æ®ï¼Œå®é™…ä¸Šå¹¶æ²¡æœ‰å•å‘channelã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“channelå¯ä»¥é€šè¿‡å‚æ•°ä¼ é€’ï¼Œæ‰€è°“å•å‘channelåªæ˜¯å¯¹channelçš„ä¸€ç§ä½¿ç”¨é™åˆ¶ï¼Œè¿™è·ŸCè¯­è¨€ä½¿ç”¨constä¿®é¥°å‡½æ•°å‚æ•°ä¸ºåªè¯»æ˜¯ä¸€ä¸ªé“ç†ã€‚</p>
<ul>
<li>func readChan(chanName &lt;-chan int)ï¼š é€šè¿‡å½¢å‚é™å®šå‡½æ•°å†…éƒ¨åªèƒ½ä»channelä¸­è¯»å–æ•°æ®</li>
<li>func writeChan(chanName chan&lt;- int)ï¼š é€šè¿‡å½¢å‚é™å®šå‡½æ•°å†…éƒ¨åªèƒ½å‘channelä¸­å†™å…¥æ•°æ®</li>
</ul>
<p>ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ç¨‹åºå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">readChan</span>(<span style="color:#a6e22e">chanName</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">chanName</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">writeChan</span>(<span style="color:#a6e22e">chanName</span> <span style="color:#66d9ef">chan</span><span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">chanName</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">mychan</span> = make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">writeChan</span>(<span style="color:#a6e22e">mychan</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">readChan</span>(<span style="color:#a6e22e">mychan</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>mychanæ˜¯ä¸ªæ­£å¸¸çš„channelï¼Œè€ŒreadChan()å‚æ•°é™åˆ¶äº†ä¼ å…¥çš„channelåªèƒ½ç”¨æ¥è¯»ï¼ŒwriteChan()å‚æ•°é™åˆ¶äº†ä¼ å…¥çš„channelåªèƒ½ç”¨æ¥å†™ã€‚</p>
<h2 id="42-select">4.2 select</h2>
<p>ä½¿ç”¨selectå¯ä»¥ç›‘æ§å¤šchannelï¼Œæ¯”å¦‚ç›‘æ§å¤šä¸ªchannelï¼Œå½“å…¶ä¸­æŸä¸€ä¸ªchannelæœ‰æ•°æ®æ—¶ï¼Œå°±ä»å…¶è¯»å‡ºæ•°æ®ã€‚</p>
<p>ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ç¨‹åºå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">addNumberToChan</span>(<span style="color:#a6e22e">chanName</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">chanName</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">chan1</span> = make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">chan2</span> = make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">addNumberToChan</span>(<span style="color:#a6e22e">chan1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">addNumberToChan</span>(<span style="color:#a6e22e">chan2</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">chan1</span> :
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Get element from chan1: %d\n&#34;</span>, <span style="color:#a6e22e">e</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">chan2</span> :
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Get element from chan2: %d\n&#34;</span>, <span style="color:#a6e22e">e</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;No element in chan1 and chan2.\n&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç¨‹åºä¸­åˆ›å»ºä¸¤ä¸ªchannelï¼š chan1å’Œchan2ã€‚å‡½æ•°addNumberToChan()å‡½æ•°ä¼šå‘ä¸¤ä¸ªchannelä¸­å‘¨æœŸæ€§å†™å…¥æ•°æ®ã€‚é€šè¿‡selectå¯ä»¥ç›‘æ§ä¸¤ä¸ªchannelï¼Œä»»æ„ä¸€ä¸ªå¯è¯»æ—¶å°±ä»å…¶ä¸­è¯»å‡ºæ•°æ®ã€‚</p>
<p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>D:<span style="color:#ae81ff">\S</span>ourceCode<span style="color:#ae81ff">\G</span>oExpert<span style="color:#ae81ff">\s</span>rc&gt;go run main.go
</span></span><span style="display:flex;"><span>Get element from chan1: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Get element from chan2: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>No element in chan1 and chan2.
</span></span><span style="display:flex;"><span>Get element from chan2: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Get element from chan1: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>No element in chan1 and chan2.
</span></span><span style="display:flex;"><span>Get element from chan2: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Get element from chan1: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>No element in chan1 and chan2.
</span></span></code></pre></div><p>ä»è¾“å‡ºå¯è§ï¼Œä»channelä¸­è¯»å‡ºæ•°æ®çš„é¡ºåºæ˜¯éšæœºçš„ï¼Œäº‹å®ä¸Šselectè¯­å¥çš„å¤šä¸ªcaseæ‰§è¡Œé¡ºåºæ˜¯éšæœºçš„ï¼Œå…³äºselectçš„å®ç°åŸç†ä¼šæœ‰ä¸“é—¨ç« èŠ‚åˆ†æã€‚</p>
<p>é€šè¿‡è¿™ä¸ªç¤ºä¾‹æƒ³è¯´çš„æ˜¯ï¼š<strong>selectçš„caseè¯­å¥è¯»channelä¸ä¼šé˜»å¡</strong>ï¼Œå°½ç®¡channelä¸­æ²¡æœ‰æ•°æ®ã€‚è¿™æ˜¯ç”±äºcaseè¯­å¥ç¼–è¯‘åè°ƒç”¨è¯»channelæ—¶ä¼š<strong>æ˜ç¡®ä¼ å…¥ä¸é˜»å¡çš„å‚æ•°</strong>ï¼Œæ­¤æ—¶è¯»ä¸åˆ°æ•°æ®æ—¶ä¸ä¼šå°†å½“å‰goroutineåŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›ã€‚</p>
<h2 id="43-range">4.3 range</h2>
<p>é€šè¿‡rangeå¯ä»¥æŒç»­ä»channelä¸­è¯»å‡ºæ•°æ®ï¼Œå¥½åƒåœ¨éå†ä¸€ä¸ªæ•°ç»„ä¸€æ ·ï¼Œå½“channelä¸­æ²¡æœ‰æ•°æ®æ—¶ä¼šé˜»å¡å½“å‰goroutineï¼Œä¸è¯»channelæ—¶é˜»å¡å¤„ç†æœºåˆ¶ä¸€æ ·ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">chanRange</span>(<span style="color:#a6e22e">chanName</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">chanName</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Get element from chan: %d\n&#34;</span>, <span style="color:#a6e22e">e</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ³¨æ„ï¼šå¦‚æœå‘æ­¤channelå†™æ•°æ®çš„goroutineé€€å‡ºæ—¶ï¼Œç³»ç»Ÿæ£€æµ‹åˆ°è¿™ç§æƒ…å†µåä¼španicï¼Œå¦åˆ™rangeå°†ä¼šæ°¸ä¹…é˜»å¡ã€‚</p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/30fc3293/">
        
        

        <div class="article-details">
            <h2 class="article-title">Go å…«è‚¡</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/aaf3975f/">
        
        

        <div class="article-details">
            <h2 class="article-title">go mapæ•°æ®ç»“æ„</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/a59515fd/">
        
        

        <div class="article-details">
            <h2 class="article-title">ã€è¯‘ã€‘ä½¿ç”¨ gosec æ£€æŸ¥ Go ä»£ç ä¸­çš„å®‰å…¨é—®é¢˜</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/8c9efcce/">
        
        

        <div class="article-details">
            <h2 class="article-title">æµé‡å¤åˆ¶é‡æ”¾å·¥å…·goreplay</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/ace0b2ab/">
        
        

        <div class="article-details">
            <h2 class="article-title">ã€è¯‘ã€‘Go 1.14 ä¸­æ¥å£çš„è±å½¢ç»„åˆ</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="lxbwolf/lxbwolf.github.io"
        issue-term="pathname"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2023 Xiaobin&#39;s Notes
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
